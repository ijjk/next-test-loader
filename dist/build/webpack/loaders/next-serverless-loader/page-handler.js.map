{"version":3,"sources":["../../../../../build/webpack/loaders/next-serverless-loader/page-handler.ts"],"names":["getPageHandler","ctx","page","pageComponent","pageConfig","pageGetStaticProps","pageGetStaticPaths","pageGetServerSideProps","appModule","documentModule","errorModule","notFoundModule","encodedPreviewProps","pageIsDynamic","generateEtags","poweredByHeader","runtimeConfig","buildManifest","reactLoadableManifest","i18n","buildId","basePath","assetPrefix","canonicalBase","escapedBuildId","experimental","initServer","onError","handleLocale","handleRewrites","handleBasePath","defaultRouteRegex","dynamicRouteMatcher","normalizeDynamicRouteParams","renderReqToHTML","req","res","renderMode","_renderOpts","_params","Component","App","config","Document","Error","notFoundMod","getStaticProps","getStaticPaths","getServerSideProps","default","Promise","all","fromExport","nextStartMode","hasValidParams","options","publicRuntimeConfig","previewProps","env","process","_nextData","defaultLocale","detectedLocale","parsedUrl","trustQuery","headers","vercelHeader","url","routeNoAssetPath","pathname","replace","RegExp","origQuery","Object","assign","query","amp","queryNoAmp","search","undefined","match","localeResult","nextInternalLocale","renderOpts","nextExport","isDataReq","locales","locale","statusCode","params","result","nowParams","groups","routeKeys","re","exec","str","obj","routeKeyNames","keys","filterLocaleItem","val","isCatchAll","Array","isArray","_val","some","item","toLowerCase","splice","length","every","name","reduce","prev","keyName","paramName","pos","key","_parsedUrl","param","optional","repeat","builtParam","paramIdx","indexOf","substr","encodeURI","resolvedUrl","resolvedAsPath","isFallback","__nextFallback","previewData","isPreviewMode","__NEXT_OPTIMIZE_FONTS","optimizeFonts","fontManifest","__webpack_require__","__NEXT_FONT_MANIFEST__","isNotFound","NotFoundComponent","errPathname","result2","err","private","stateful","revalidate","isRedirect","redirect","destination","pageData","pageProps","__N_REDIRECT","__N_REDIRECT_STATUS","__N_REDIRECT_BASE_PATH","PERMANENT_REDIRECT_STATUS","setHeader","end","JSON","stringify","html","code","console","error","underErrorErr","render"],"mappings":"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","sourcesContent":["import { parse as parseQs } from 'querystring'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { parse as parseUrl, format as formatUrl, UrlWithParsedQuery } from 'url'\nimport { isResSent } from '../../../../next-server/lib/utils'\nimport { sendPayload } from '../../../../next-server/server/send-payload'\nimport { getUtils, vercelHeader, ServerlessHandlerCtx } from './utils'\n\nimport { renderToHTML } from '../../../../next-server/server/render'\nimport { tryGetPreviewData } from '../../../../next-server/server/api-utils'\nimport { denormalizePagePath } from '../../../../next-server/server/denormalize-page-path'\nimport {\n  setLazyProp,\n  getCookieParser,\n} from '../../../../next-server/server/api-utils'\nimport { getRedirectStatus } from '../../../../lib/load-custom-routes'\nimport getRouteNoAssetPath from '../../../../next-server/lib/router/utils/get-route-from-asset-path'\nimport { getRouteMatcher } from '../../../../next-server/lib/router/utils/route-matcher'\nimport { PERMANENT_REDIRECT_STATUS } from '../../../../next-server/lib/constants'\n\nexport function getPageHandler(ctx: ServerlessHandlerCtx) {\n  const {\n    page,\n\n    pageComponent,\n    pageConfig,\n    pageGetStaticProps,\n    pageGetStaticPaths,\n    pageGetServerSideProps,\n\n    appModule,\n    documentModule,\n    errorModule,\n    notFoundModule,\n\n    encodedPreviewProps,\n    pageIsDynamic,\n    generateEtags,\n    poweredByHeader,\n\n    runtimeConfig,\n    buildManifest,\n    reactLoadableManifest,\n\n    i18n,\n    buildId,\n    basePath,\n    assetPrefix,\n    canonicalBase,\n    escapedBuildId,\n\n    experimental: { initServer, onError },\n  } = ctx\n  const {\n    handleLocale,\n    handleRewrites,\n    handleBasePath,\n    defaultRouteRegex,\n    dynamicRouteMatcher,\n    normalizeDynamicRouteParams,\n  } = getUtils(ctx)\n\n  async function renderReqToHTML(\n    req: IncomingMessage,\n    res: ServerResponse,\n    renderMode?: 'export' | 'passthrough' | true,\n    _renderOpts?: any,\n    _params?: any\n  ) {\n    let Component\n    let App\n    let config\n    let Document\n    let Error\n    let notFoundMod\n    let getStaticProps\n    let getStaticPaths\n    let getServerSideProps\n    ;[\n      getStaticProps,\n      getServerSideProps,\n      getStaticPaths,\n      Component,\n      App,\n      config,\n      { default: Document },\n      { default: Error },\n      notFoundMod,\n    ] = await Promise.all([\n      pageGetStaticProps,\n      pageGetServerSideProps,\n      pageGetStaticPaths,\n      pageComponent,\n      appModule,\n      pageConfig,\n      documentModule,\n      errorModule,\n      notFoundModule,\n    ])\n\n    const fromExport = renderMode === 'export' || renderMode === true\n    const nextStartMode = renderMode === 'passthrough'\n\n    let hasValidParams = true\n\n    setLazyProp({ req: req as any }, 'cookies', getCookieParser(req))\n\n    const options = {\n      App,\n      Document,\n      buildManifest,\n      getStaticProps,\n      getServerSideProps,\n      getStaticPaths,\n      reactLoadableManifest,\n      canonicalBase,\n      buildId,\n      assetPrefix,\n      runtimeConfig: (runtimeConfig || {}).publicRuntimeConfig || {},\n      previewProps: encodedPreviewProps,\n      env: process.env,\n      basePath,\n      ..._renderOpts,\n    }\n    let _nextData = false\n    let defaultLocale = i18n?.defaultLocale\n    let detectedLocale = i18n?.defaultLocale\n    let parsedUrl: UrlWithParsedQuery\n\n    try {\n      // We need to trust the dynamic route params from the proxy\n      // to ensure we are using the correct values\n      const trustQuery = !getStaticProps && req.headers[vercelHeader]\n      parsedUrl = parseUrl(req.url!, true)\n      let routeNoAssetPath = parsedUrl.pathname!\n\n      if (basePath) {\n        routeNoAssetPath =\n          routeNoAssetPath.replace(new RegExp(`^${basePath}`), '') || '/'\n      }\n      const origQuery = Object.assign({}, parsedUrl.query)\n\n      parsedUrl = handleRewrites(parsedUrl)\n      handleBasePath(req, parsedUrl)\n\n      // remove ?amp=1 from request URL if rendering for export\n      if (fromExport && parsedUrl.query.amp) {\n        const queryNoAmp = Object.assign({}, origQuery)\n        delete queryNoAmp.amp\n\n        req.url = formatUrl({\n          ...parsedUrl,\n          search: undefined,\n          query: queryNoAmp,\n        })\n      }\n\n      if (parsedUrl.pathname!.match(/_next\\/data/)) {\n        _nextData = page !== '/_error'\n        parsedUrl.pathname = getRouteNoAssetPath(\n          parsedUrl.pathname!.replace(\n            new RegExp(`/_next/data/${escapedBuildId}/`),\n            '/'\n          ),\n          '.json'\n        )\n        routeNoAssetPath = parsedUrl.pathname\n      }\n\n      const localeResult = handleLocale(\n        req,\n        res,\n        parsedUrl,\n        routeNoAssetPath,\n        fromExport || nextStartMode\n      )\n      defaultLocale = localeResult?.defaultLocale || defaultLocale\n      detectedLocale = localeResult?.detectedLocale || detectedLocale\n      routeNoAssetPath = localeResult?.routeNoAssetPath || routeNoAssetPath\n\n      if (parsedUrl.query.nextInternalLocale) {\n        detectedLocale = parsedUrl.query.nextInternalLocale as string\n        delete parsedUrl.query.nextInternalLocale\n      }\n\n      const renderOpts = Object.assign(\n        {\n          Component,\n          pageConfig: config,\n          nextExport: fromExport,\n          isDataReq: _nextData,\n          locales: i18n?.locales,\n          locale: detectedLocale,\n          defaultLocale,\n        },\n        options\n      )\n\n      if (page === '/_error' && !res.statusCode) {\n        res.statusCode = 404\n      }\n\n      let params = {}\n\n      if (!fromExport && pageIsDynamic) {\n        const result = normalizeDynamicRouteParams(\n          trustQuery\n            ? parsedUrl.query\n            : (dynamicRouteMatcher!(parsedUrl.pathname) as Record<\n                string,\n                string | string[]\n              >)\n        )\n\n        hasValidParams = result.hasValidParams\n        params = result.params\n      }\n\n      let nowParams = null\n\n      if (\n        pageIsDynamic &&\n        !hasValidParams &&\n        req.headers?.['x-now-route-matches']\n      ) {\n        nowParams = getRouteMatcher(\n          (function () {\n            const { groups, routeKeys } = defaultRouteRegex!\n\n            return {\n              re: {\n                // Simulate a RegExp match from the \\`req.url\\` input\n                exec: (str: string) => {\n                  const obj = parseQs(str)\n\n                  // favor named matches if available\n                  const routeKeyNames = Object.keys(routeKeys || {})\n\n                  const filterLocaleItem = (val: string | string[]) => {\n                    if (i18n) {\n                      // locale items can be included in route-matches\n                      // for fallback SSG pages so ensure they are\n                      // filtered\n                      const isCatchAll = Array.isArray(val)\n                      const _val = isCatchAll ? val[0] : val\n\n                      if (\n                        typeof _val === 'string' &&\n                        i18n.locales.some((item) => {\n                          if (item.toLowerCase() === _val.toLowerCase()) {\n                            detectedLocale = item\n                            renderOpts.locale = detectedLocale\n                            return true\n                          }\n                          return false\n                        })\n                      ) {\n                        // remove the locale item from the match\n                        if (isCatchAll) {\n                          ;(val as string[]).splice(0, 1)\n                        }\n\n                        // the value is only a locale item and\n                        // shouldn't be added\n                        return isCatchAll ? val.length === 0 : true\n                      }\n                    }\n                    return false\n                  }\n\n                  if (routeKeyNames.every((name) => obj[name])) {\n                    return routeKeyNames.reduce((prev, keyName) => {\n                      const paramName = routeKeys?.[keyName]\n\n                      if (paramName && !filterLocaleItem(obj[keyName])) {\n                        prev[groups[paramName].pos] = obj[keyName]\n                      }\n                      return prev\n                    }, {} as any)\n                  }\n\n                  return Object.keys(obj).reduce((prev, key) => {\n                    if (!filterLocaleItem(obj[key])) {\n                      return Object.assign(prev, {\n                        [key]: obj[key],\n                      })\n                    }\n                    return prev\n                  }, {})\n                },\n              },\n              groups,\n            }\n          })() as any\n        )(req.headers['x-now-route-matches'] as string)\n      }\n\n      // make sure to set renderOpts to the correct params e.g. _params\n      // if provided from worker or params if we're parsing them here\n      renderOpts.params = _params || params\n\n      // make sure to normalize req.url on Vercel to strip dynamic params\n      // from the query which are added during routing\n      if (pageIsDynamic && trustQuery && defaultRouteRegex) {\n        const _parsedUrl = parseUrl(req.url!, true)\n        delete (_parsedUrl as any).search\n\n        for (const param of Object.keys(defaultRouteRegex.groups)) {\n          delete _parsedUrl.query[param]\n        }\n        req.url = formatUrl(_parsedUrl)\n      }\n\n      // normalize request URL/asPath for fallback/revalidate pages since the\n      // proxy sets the request URL to the output's path for fallback pages\n      if (pageIsDynamic && nowParams && defaultRouteRegex) {\n        const _parsedUrl = parseUrl(req.url!)\n\n        for (const param of Object.keys(defaultRouteRegex.groups)) {\n          const { optional, repeat } = defaultRouteRegex.groups[param]\n          let builtParam = `[${repeat ? '...' : ''}${param}]`\n\n          if (optional) {\n            builtParam = `[${builtParam}]`\n          }\n\n          const paramIdx = _parsedUrl.pathname!.indexOf(builtParam)\n\n          if (paramIdx > -1) {\n            _parsedUrl.pathname =\n              _parsedUrl.pathname!.substr(0, paramIdx) +\n              encodeURI((nowParams as any)[param] || '') +\n              _parsedUrl.pathname!.substr(paramIdx + builtParam.length)\n          }\n        }\n        parsedUrl.pathname = _parsedUrl.pathname\n        req.url = formatUrl(_parsedUrl)\n      }\n\n      // make sure to normalize asPath for revalidate and _next/data requests\n      // since the asPath should match what is shown on the client\n      if (!fromExport && (getStaticProps || getServerSideProps)) {\n        // don't include dynamic route params in query while normalizing\n        // asPath\n        if (pageIsDynamic && trustQuery && defaultRouteRegex) {\n          delete (parsedUrl as any).search\n\n          for (const param of Object.keys(defaultRouteRegex.groups)) {\n            delete origQuery[param]\n          }\n        }\n\n        parsedUrl.pathname = denormalizePagePath(parsedUrl.pathname!)\n        renderOpts.resolvedUrl = formatUrl({\n          ...parsedUrl,\n          query: origQuery,\n        })\n\n        // For getServerSideProps we need to ensure we use the original URL\n        // and not the resolved URL to prevent a hydration mismatch on asPath\n        renderOpts.resolvedAsPath = getServerSideProps\n          ? formatUrl({\n              ...parsedUrl,\n              pathname: routeNoAssetPath,\n              query: origQuery,\n            })\n          : renderOpts.resolvedUrl\n      }\n\n      const isFallback = parsedUrl.query.__nextFallback\n\n      const previewData = tryGetPreviewData(req, res, options.previewProps)\n      const isPreviewMode = previewData !== false\n      if (process.env.__NEXT_OPTIMIZE_FONTS) {\n        renderOpts.optimizeFonts = true\n        /**\n         * __webpack_require__.__NEXT_FONT_MANIFEST__ is added by\n         * font-stylesheet-gathering-plugin\n         */\n        // @ts-ignore\n        renderOpts.fontManifest = __webpack_require__.__NEXT_FONT_MANIFEST__\n      }\n      let result = await renderToHTML(\n        req,\n        res,\n        page,\n        Object.assign(\n          {},\n          getStaticProps\n            ? { ...(parsedUrl.query.amp ? { amp: '1' } : {}) }\n            : parsedUrl.query,\n          nowParams ? nowParams : params,\n          _params,\n          isFallback ? { __nextFallback: 'true' } : {}\n        ),\n        renderOpts\n      )\n\n      if (!renderMode) {\n        if (_nextData || getStaticProps || getServerSideProps) {\n          if (renderOpts.isNotFound) {\n            res.statusCode = 404\n\n            const NotFoundComponent = notFoundMod ? notFoundMod.default : Error\n            const errPathname = notFoundMod ? '/404' : '/_error'\n\n            const result2 = await renderToHTML(\n              req,\n              res,\n              errPathname,\n              parsedUrl.query,\n              Object.assign({}, options, {\n                getStaticProps: notFoundMod\n                  ? notFoundMod.getStaticProps\n                  : undefined,\n                getStaticPaths: undefined,\n                getServerSideProps: undefined,\n                Component: NotFoundComponent,\n                err: undefined,\n                locale: detectedLocale,\n                locales: i18n?.locales,\n                defaultLocale: i18n?.defaultLocale,\n              })\n            )\n\n            sendPayload(\n              req,\n              res,\n              result2,\n              'html',\n              {\n                generateEtags,\n                poweredByHeader,\n              },\n              {\n                private: isPreviewMode,\n                stateful: !!getServerSideProps,\n                revalidate: renderOpts.revalidate,\n              }\n            )\n            return null\n          } else if (renderOpts.isRedirect && !_nextData) {\n            const redirect = {\n              destination: renderOpts.pageData.pageProps.__N_REDIRECT,\n              statusCode: renderOpts.pageData.pageProps.__N_REDIRECT_STATUS,\n              basePath: renderOpts.pageData.pageProps.__N_REDIRECT_BASE_PATH,\n            }\n            const statusCode = getRedirectStatus(redirect)\n\n            if (basePath && redirect.basePath !== false) {\n              redirect.destination = `${basePath}${redirect.destination}`\n            }\n\n            if (statusCode === PERMANENT_REDIRECT_STATUS) {\n              res.setHeader('Refresh', `0;url=${redirect.destination}`)\n            }\n\n            res.statusCode = statusCode\n            res.setHeader('Location', redirect.destination)\n            res.end()\n            return null\n          } else {\n            sendPayload(\n              req,\n              res,\n              _nextData ? JSON.stringify(renderOpts.pageData) : result,\n              _nextData ? 'json' : 'html',\n              {\n                generateEtags,\n                poweredByHeader,\n              },\n              {\n                private: isPreviewMode,\n                stateful: !!getServerSideProps,\n                revalidate: renderOpts.revalidate,\n              }\n            )\n            return null\n          }\n        }\n      } else if (isPreviewMode) {\n        res.setHeader(\n          'Cache-Control',\n          'private, no-cache, no-store, max-age=0, must-revalidate'\n        )\n      }\n\n      if (renderMode) return { html: result, renderOpts }\n      return result\n    } catch (err) {\n      if (!parsedUrl!) {\n        parsedUrl = parseUrl(req.url!, true)\n      }\n\n      if (err.code === 'ENOENT') {\n        res.statusCode = 404\n      } else if (err.code === 'DECODE_FAILED') {\n        // TODO: better error?\n        res.statusCode = 400\n      } else {\n        console.error('Unhandled error during request:', err)\n\n        // Backwards compat (call getInitialProps in custom error):\n        try {\n          await renderToHTML(\n            req,\n            res,\n            '/_error',\n            parsedUrl!.query,\n            Object.assign({}, options, {\n              getStaticProps: undefined,\n              getStaticPaths: undefined,\n              getServerSideProps: undefined,\n              Component: Error,\n              err: err,\n              // Short-circuit rendering:\n              isDataReq: true,\n            })\n          )\n        } catch (underErrorErr) {\n          console.error(\n            'Failed call /_error subroutine, continuing to crash function:',\n            underErrorErr\n          )\n        }\n\n        // Throw the error to crash the serverless function\n        if (isResSent(res)) {\n          console.error('!!! WARNING !!!')\n          console.error(\n            'Your function crashed, but closed the response before allowing the function to exit.\\\\n' +\n              'This may cause unexpected behavior for the next request.'\n          )\n          console.error('!!! WARNING !!!')\n        }\n        throw err\n      }\n\n      const result2 = await renderToHTML(\n        req,\n        res,\n        '/_error',\n        parsedUrl!.query,\n        Object.assign({}, options, {\n          getStaticProps: undefined,\n          getStaticPaths: undefined,\n          getServerSideProps: undefined,\n          Component: Error,\n          err: res.statusCode === 404 ? undefined : err,\n        })\n      )\n      return result2\n    }\n  }\n\n  return {\n    renderReqToHTML,\n    render: async function render(req: IncomingMessage, res: ServerResponse) {\n      try {\n        await initServer()\n        const html = await renderReqToHTML(req, res)\n        if (html) {\n          sendPayload(req, res, html, 'html', {\n            generateEtags,\n            poweredByHeader,\n          })\n        }\n      } catch (err) {\n        console.error(err)\n        await onError(err)\n        // Throw the error to crash the serverless function\n        throw err\n      }\n    },\n  }\n}\n"]}