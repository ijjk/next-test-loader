{"version":3,"sources":["../../../../build/webpack/plugins/css-minimizer-plugin.ts"],"names":["CSS_REGEX","isWebpack5","parseInt","webpack","version","CssMinimizerPlugin","constructor","options","__next_css_remove","optimizeAsset","file","asset","postcssOptions","to","from","input","map","sourceAndMap","source","prev","then","res","SourceMapSource","css","toJSON","RawSource","apply","compiler","hooks","compilation","tap","processAssets","tapPromise","name","stage","Compilation","PROCESS_ASSETS_STAGE_OPTIMIZE_SIZE","assets","files","Object","keys","Promise","all","filter","test","optimizeChunkAssets","chunks","reduce","acc","chunk","concat","entry"],"mappings":"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","sourcesContent":["import { process as minify } from 'cssnano-simple'\nimport webpack from 'webpack'\nimport { RawSource, SourceMapSource } from 'webpack-sources'\n\n// https://github.com/NMFR/optimize-css-assets-webpack-plugin/blob/0a410a9bf28c7b0e81a3470a13748e68ca2f50aa/src/index.js#L20\nconst CSS_REGEX = /\\.css(\\?.*)?$/i\n\ntype CssMinimizerPluginOptions = {\n  postcssOptions: {\n    map: false | { prev?: string | false; inline: boolean; annotation: boolean }\n  }\n}\n\nconst isWebpack5 = parseInt(webpack.version!) === 5\n\nexport class CssMinimizerPlugin {\n  __next_css_remove = true\n\n  private options: CssMinimizerPluginOptions\n\n  constructor(options: CssMinimizerPluginOptions) {\n    this.options = options\n  }\n\n  optimizeAsset(file: string, asset: any) {\n    const postcssOptions = {\n      ...this.options.postcssOptions,\n      to: file,\n      from: file,\n    }\n\n    let input: string\n    if (postcssOptions.map && asset.sourceAndMap) {\n      const { source, map } = asset.sourceAndMap()\n      input = source\n      postcssOptions.map.prev = map ? map : false\n    } else {\n      input = asset.source()\n    }\n\n    return minify(input, postcssOptions).then((res) => {\n      if (res.map) {\n        return new SourceMapSource(res.css, file, res.map.toJSON())\n      } else {\n        return new RawSource(res.css)\n      }\n    })\n  }\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.compilation.tap('CssMinimizerPlugin', (compilation: any) => {\n      if (isWebpack5) {\n        compilation.hooks.processAssets.tapPromise(\n          {\n            name: 'CssMinimizerPlugin',\n            // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n            stage: webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_SIZE,\n          },\n          async (assets: any) => {\n            const files = Object.keys(assets)\n            await Promise.all(\n              files\n                .filter((file) => CSS_REGEX.test(file))\n                .map(async (file) => {\n                  const asset = compilation.assets[file]\n\n                  assets[file] = await this.optimizeAsset(file, asset)\n                })\n            )\n          }\n        )\n        return\n      }\n      compilation.hooks.optimizeChunkAssets.tapPromise(\n        'CssMinimizerPlugin',\n        (chunks: webpack.compilation.Chunk[]) =>\n          Promise.all(\n            chunks\n              .reduce(\n                (acc, chunk) => acc.concat(chunk.files || []),\n                [] as string[]\n              )\n              .filter((entry) => CSS_REGEX.test(entry))\n              .map(async (file) => {\n                const asset = compilation.assets[file]\n\n                compilation.assets[file] = await this.optimizeAsset(file, asset)\n              })\n          )\n      )\n    })\n  }\n}\n"]}