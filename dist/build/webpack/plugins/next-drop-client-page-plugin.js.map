{"version":3,"sources":["../../../../build/webpack/plugins/next-drop-client-page-plugin.ts"],"names":["ampFirstEntryNamesMap","WeakMap","PLUGIN_NAME","findEntryModule","mod","queue","Set","module","reason","reasons","add","handler","parser","markAsAmpFirst","entryModule","state","buildInfo","NEXT_ampFirst","hooks","varDeclarationConst","for","STRING_LITERAL_DROP_BUNDLE","tap","varDeclarationLet","varDeclaration","DropClientPage","ampPages","apply","compiler","compilation","normalModuleFactory","has","set","ampFirstEntryNamesItem","get","seal","i","_preparedEntrypoints","length","entrypoint","push","name","splice","entries"],"mappings":"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","sourcesContent":["import { Compiler, compilation as CompilationType, Plugin } from 'webpack'\nimport { STRING_LITERAL_DROP_BUNDLE } from '../../../next-server/lib/constants'\n\nexport const ampFirstEntryNamesMap: WeakMap<\n  CompilationType.Compilation,\n  string[]\n> = new WeakMap()\n\nconst PLUGIN_NAME = 'DropAmpFirstPagesPlugin'\n\n// Recursively look up the issuer till it ends up at the root\nfunction findEntryModule(mod: any): CompilationType.Module | null {\n  const queue = new Set([mod])\n  for (const module of queue) {\n    for (const reason of module.reasons) {\n      if (!reason.module) return module\n      queue.add(reason.module)\n    }\n  }\n\n  return null\n}\n\nfunction handler(parser: any) {\n  function markAsAmpFirst() {\n    const entryModule = findEntryModule(parser.state.module)\n\n    if (!entryModule) {\n      return\n    }\n\n    // @ts-ignore buildInfo exists on Module\n    entryModule.buildInfo.NEXT_ampFirst = true\n  }\n\n  parser.hooks.varDeclarationConst\n    .for(STRING_LITERAL_DROP_BUNDLE)\n    .tap(PLUGIN_NAME, markAsAmpFirst)\n\n  parser.hooks.varDeclarationLet\n    .for(STRING_LITERAL_DROP_BUNDLE)\n    .tap(PLUGIN_NAME, markAsAmpFirst)\n\n  parser.hooks.varDeclaration\n    .for(STRING_LITERAL_DROP_BUNDLE)\n    .tap(PLUGIN_NAME, markAsAmpFirst)\n}\n\n// Prevents outputting client pages when they are not needed\nexport class DropClientPage implements Plugin {\n  ampPages = new Set()\n\n  apply(compiler: Compiler) {\n    compiler.hooks.compilation.tap(\n      PLUGIN_NAME,\n      (compilation, { normalModuleFactory }) => {\n        normalModuleFactory.hooks.parser\n          .for('javascript/auto')\n          .tap(PLUGIN_NAME, handler)\n\n        if (!ampFirstEntryNamesMap.has(compilation)) {\n          ampFirstEntryNamesMap.set(compilation, [])\n        }\n\n        const ampFirstEntryNamesItem = ampFirstEntryNamesMap.get(\n          compilation\n        ) as string[]\n\n        compilation.hooks.seal.tap(PLUGIN_NAME, () => {\n          // Remove preparedEntrypoint that has bundle drop marker\n          // This will ensure webpack does not create chunks/bundles for this particular entrypoint\n          for (\n            let i = compilation._preparedEntrypoints.length - 1;\n            i >= 0;\n            i--\n          ) {\n            const entrypoint = compilation._preparedEntrypoints[i]\n            if (entrypoint?.module?.buildInfo?.NEXT_ampFirst) {\n              ampFirstEntryNamesItem.push(entrypoint.name)\n              compilation._preparedEntrypoints.splice(i, 1)\n            }\n          }\n\n          for (let i = compilation.entries.length - 1; i >= 0; i--) {\n            const entryModule = compilation.entries[i]\n            if (entryModule?.buildInfo?.NEXT_ampFirst) {\n              compilation.entries.splice(i, 1)\n            }\n          }\n        })\n      }\n    )\n  }\n}\n"]}