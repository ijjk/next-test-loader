{"version":3,"sources":["lib/has-necessary-dependencies.ts"],"sourcesContent":["import chalk from 'chalk'\nimport { join } from 'path'\n\nimport { fileExists } from './file-exists'\nimport { getOxfordCommaList } from './oxford-comma-list'\nimport { FatalError } from './fatal-error'\n\nconst requiredTSPackages = [\n  { file: 'typescript', pkg: 'typescript' },\n  { file: '@types/react/index.d.ts', pkg: '@types/react' },\n  { file: '@types/node/index.d.ts', pkg: '@types/node' },\n]\n\nconst requiredLintPackages = [\n  { file: 'eslint/lib/api.js', pkg: 'eslint' },\n  { file: 'eslint-config-next', pkg: 'eslint-config-next' },\n]\n\nexport type NecessaryDependencies = {\n  resolved: Map<string, string>\n}\n\nexport async function hasNecessaryDependencies(\n  baseDir: string,\n  checkTSDeps: boolean,\n  checkESLintDeps: boolean,\n  lintDuringBuild: boolean = false\n): Promise<NecessaryDependencies> {\n  if (!checkTSDeps && !checkESLintDeps) {\n    return { resolved: undefined! }\n  }\n\n  let resolutions = new Map<string, string>()\n  let requiredPackages = checkESLintDeps\n    ? requiredLintPackages\n    : requiredTSPackages\n\n  const missingPackages = requiredPackages.filter((p) => {\n    try {\n      resolutions.set(p.pkg, require.resolve(p.file, { paths: [baseDir] }))\n      return false\n    } catch (_) {\n      return true\n    }\n  })\n\n  if (missingPackages.length < 1) {\n    return {\n      resolved: resolutions,\n    }\n  }\n\n  const packagesHuman = getOxfordCommaList(missingPackages.map((p) => p.pkg))\n  const packagesCli = missingPackages.map((p) => p.pkg).join(' ')\n\n  const yarnLockFile = join(baseDir, 'yarn.lock')\n  const isYarn = await fileExists(yarnLockFile).catch(() => false)\n\n  const removalTSMsg =\n    '\\n\\n' +\n    chalk.bold(\n      'If you are not trying to use TypeScript, please remove the ' +\n        chalk.cyan('tsconfig.json') +\n        ' file from your package root (and any TypeScript files in your pages directory).'\n    )\n  const removalLintMsg =\n    `\\n\\n` +\n    (lintDuringBuild\n      ? `If you do not want to run ESLint during builds, disable it in next.config.js. See https://nextjs.org/docs/api-reference/next.config.js/ignoring-eslint`\n      : `Once installed, run ${chalk.bold.cyan('next lint')} again.`)\n  const removalMsg = checkTSDeps ? removalTSMsg : removalLintMsg\n\n  throw new FatalError(\n    chalk.bold.red(\n      checkTSDeps\n        ? `It looks like you're trying to use TypeScript but do not have the required package(s) installed.`\n        : `To use ESLint, additional required package(s) must be installed.`\n    ) +\n      '\\n\\n' +\n      chalk.bold(`Please install ${chalk.bold(packagesHuman)} by running:`) +\n      '\\n\\n' +\n      `\\t${chalk.bold.cyan(\n        (isYarn ? 'yarn add --dev' : 'npm install --save-dev') +\n          ' ' +\n          packagesCli\n      )}` +\n      removalMsg +\n      '\\n'\n  )\n}\n"],"names":[],"mappings":";;;;QAsBsB,wBAAwB,GAAxB,wBAAwB;AAtB5B,GAAO,CAAP,MAAO;AACJ,GAAM,CAAN,KAAM;AAEA,GAAe,CAAf,WAAe;AACP,GAAqB,CAArB,gBAAqB;AAC7B,GAAe,CAAf,WAAe;;;;;;AAE1C,KAAK,CAAC,kBAAkB;;QACpB,IAAI,GAAE,UAAY;QAAE,GAAG,GAAE,UAAY;;;QACrC,IAAI,GAAE,uBAAyB;QAAE,GAAG,GAAE,YAAc;;;QACpD,IAAI,GAAE,sBAAwB;QAAE,GAAG,GAAE,WAAa;;;AAGtD,KAAK,CAAC,oBAAoB;;QACtB,IAAI,GAAE,iBAAmB;QAAE,GAAG,GAAE,MAAQ;;;QACxC,IAAI,GAAE,kBAAoB;QAAE,GAAG,GAAE,kBAAoB;;;eAOnC,wBAAwB,CAC5C,OAAe,EACf,WAAoB,EACpB,eAAwB,EACxB,eAAwB,GAAG,KAAK,EACA,CAAC;IACjC,EAAE,GAAG,WAAW,KAAK,eAAe,EAAE,CAAC;;YAC5B,QAAQ,EAAE,SAAS;;IAC9B,CAAC;IAED,GAAG,CAAC,WAAW,GAAG,GAAG,CAAC,GAAG;IACzB,GAAG,CAAC,gBAAgB,GAAG,eAAe,GAClC,oBAAoB,GACpB,kBAAkB;IAEtB,KAAK,CAAC,eAAe,GAAG,gBAAgB,CAAC,MAAM,EAAE,CAAC,GAAK,CAAC;YAClD,CAAC;YACH,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC,GAAG,EAAE,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI;gBAAI,KAAK;oBAAG,OAAO;;;mBACzD,KAAK;QACd,CAAC,QAAQ,CAAC,EAAE,CAAC;mBACJ,IAAI;QACb,CAAC;IACH,CAAC;IAED,EAAE,EAAE,eAAe,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;;YAE7B,QAAQ,EAAE,WAAW;;IAEzB,CAAC;IAED,KAAK,CAAC,aAAa,OAhDc,gBAAqB,qBAgDb,eAAe,CAAC,GAAG,EAAE,CAAC,GAAK,CAAC,CAAC,GAAG;;IACzE,KAAK,CAAC,WAAW,GAAG,eAAe,CAAC,GAAG,EAAE,CAAC,GAAK,CAAC,CAAC,GAAG;MAAE,IAAI,EAAC,CAAG;IAE9D,KAAK,CAAC,YAAY,OAtDC,KAAM,OAsDC,OAAO,GAAE,SAAW;IAC9C,KAAK,CAAC,MAAM,aArDa,WAAe,aAqDR,YAAY,EAAE,KAAK,KAAO,KAAK;;IAE/D,KAAK,CAAC,YAAY,IAChB,IAAM,IA3DQ,MAAO,SA4Df,IAAI,EACR,2DAA6D,IA7DjD,MAAO,SA8DX,IAAI,EAAC,aAAe,MAC1B,gFAAkF;IAExF,KAAK,CAAC,cAAc,IACjB,IAAI,KACJ,eAAe,IACX,sJAAsJ,KACtJ,oBAAoB,EArEX,MAAO,SAqEY,IAAI,CAAC,IAAI,EAAC,SAAW,GAAE,OAAO;IACjE,KAAK,CAAC,UAAU,GAAG,WAAW,GAAG,YAAY,GAAG,cAAc;IAE9D,KAAK,CAAC,GAAG,CAnEgB,WAAe,YALxB,MAAO,SAyEf,IAAI,CAAC,GAAG,CACZ,WAAW,IACN,gGAAgG,KAChG,gEAAgE,MAErE,IAAM,IA9EM,MAAO,SA+Eb,IAAI,EAAE,eAAe,EA/Ef,MAAO,SA+EgB,IAAI,CAAC,aAAa,EAAE,YAAY,MACnE,IAAM,KACL,EAAE,EAjFS,MAAO,SAiFR,IAAI,CAAC,IAAI,EACjB,MAAM,IAAG,cAAgB,KAAG,sBAAwB,MACnD,CAAG,IACH,WAAW,MAEf,UAAU,IACV,EAAI;AAEV,CAAC"}