{"version":3,"sources":["lib/verifyTypeScriptSetup.ts"],"sourcesContent":["import chalk from 'chalk'\nimport path from 'path'\nimport {\n  hasNecessaryDependencies,\n  NecessaryDependencies,\n} from './has-necessary-dependencies'\nimport semver from 'next/dist/compiled/semver'\nimport { CompileError } from './compile-error'\nimport { FatalError } from './fatal-error'\nimport * as log from '../build/output/log'\n\nimport { getTypeScriptIntent } from './typescript/getTypeScriptIntent'\nimport { TypeCheckResult } from './typescript/runTypeCheck'\nimport { writeAppTypeDeclarations } from './typescript/writeAppTypeDeclarations'\nimport { writeConfigurationDefaults } from './typescript/writeConfigurationDefaults'\n\nexport async function verifyTypeScriptSetup(\n  dir: string,\n  pagesDir: string,\n  typeCheckPreflight: boolean,\n  imageImportsEnabled: boolean,\n  cacheDir?: string\n): Promise<{ result?: TypeCheckResult; version: string | null }> {\n  const tsConfigPath = path.join(dir, 'tsconfig.json')\n\n  try {\n    // Check if the project uses TypeScript:\n    const intent = await getTypeScriptIntent(dir, pagesDir)\n    if (!intent) {\n      return { version: null }\n    }\n    const firstTimeSetup = intent.firstTimeSetup\n\n    // Ensure TypeScript and necessary `@types/*` are installed:\n    const deps: NecessaryDependencies = await hasNecessaryDependencies(\n      dir,\n      !!intent,\n      false\n    )\n\n    // Load TypeScript after we're sure it exists:\n    const ts = (await import(\n      deps.resolved.get('typescript')!\n    )) as typeof import('typescript')\n\n    if (semver.lt(ts.version, '4.3.2')) {\n      log.warn(\n        `Minimum recommended TypeScript version is v4.3.2, older versions can potentially be incompatible with Next.js. Detected: ${ts.version}`\n      )\n    }\n\n    // Reconfigure (or create) the user's `tsconfig.json` for them:\n    await writeConfigurationDefaults(ts, tsConfigPath, firstTimeSetup)\n    // Write out the necessary `next-env.d.ts` file to correctly register\n    // Next.js' types:\n    await writeAppTypeDeclarations(dir, imageImportsEnabled)\n\n    let result\n    if (typeCheckPreflight) {\n      const { runTypeCheck } = require('./typescript/runTypeCheck')\n\n      // Verify the project passes type-checking before we go to webpack phase:\n      result = await runTypeCheck(ts, dir, tsConfigPath, cacheDir)\n    }\n    return { result, version: ts.version }\n  } catch (err) {\n    // These are special errors that should not show a stack trace:\n    if (err instanceof CompileError) {\n      console.error(chalk.red('Failed to compile.\\n'))\n      console.error(err.message)\n      process.exit(1)\n    } else if (err instanceof FatalError) {\n      console.error(err.message)\n      process.exit(1)\n    }\n    throw err\n  }\n}\n"],"names":[],"mappings":";;;;QAgBsB,qBAAqB,GAArB,qBAAqB;AAhBzB,GAAO,CAAP,MAAO;AACR,GAAM,CAAN,KAAM;AAIhB,GAA8B,CAA9B,yBAA8B;AAClB,GAA2B,CAA3B,OAA2B;AACjB,GAAiB,CAAjB,aAAiB;AACnB,GAAe,CAAf,WAAe;AAC9B,GAAG,CAAH,GAAG;AAEqB,GAAkC,CAAlC,oBAAkC;AAE7B,GAAuC,CAAvC,yBAAuC;AACrC,GAAyC,CAAzC,2BAAyC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;eAE9D,qBAAqB,CACzC,GAAW,EACX,QAAgB,EAChB,kBAA2B,EAC3B,mBAA4B,EAC5B,QAAiB,EAC8C,CAAC;IAChE,KAAK,CAAC,YAAY,GAtBH,KAAM,SAsBK,IAAI,CAAC,GAAG,GAAE,aAAe;QAE/C,CAAC;QACH,EAAwC,AAAxC,sCAAwC;QACxC,KAAK,CAAC,MAAM,aAhBoB,oBAAkC,sBAgBzB,GAAG,EAAE,QAAQ;QACtD,EAAE,GAAG,MAAM,EAAE,CAAC;;gBACH,OAAO,EAAE,IAAI;;QACxB,CAAC;QACD,KAAK,CAAC,cAAc,GAAG,MAAM,CAAC,cAAc;QAE5C,EAA4D,AAA5D,0DAA4D;QAC5D,KAAK,CAAC,IAAI,aA7BP,yBAA8B,2BA8B/B,GAAG,IACD,MAAM,EACR,KAAK;QAGP,EAA8C,AAA9C,4CAA8C;QAC9C,KAAK,CAAC,EAAE;mDACN,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAC,UAAY;;QAGhC,EAAE,EAvCa,OAA2B,SAuC/B,EAAE,CAAC,EAAE,CAAC,OAAO,GAAE,KAAO,IAAG,CAAC;YApC7B,GAAG,CAqCL,IAAI,EACL,yHAAyH,EAAE,EAAE,CAAC,OAAO;QAE1I,CAAC;QAED,EAA+D,AAA/D,6DAA+D;kBArCxB,2BAAyC,6BAsC/C,EAAE,EAAE,YAAY,EAAE,cAAc;QACjE,EAAqE,AAArE,mEAAqE;QACrE,EAAkB,AAAlB,gBAAkB;kBAzCmB,yBAAuC,2BA0C7C,GAAG,EAAE,mBAAmB;QAEvD,GAAG,CAAC,MAAM;QACV,EAAE,EAAE,kBAAkB,EAAE,CAAC;YACvB,KAAK,GAAG,YAAY,MAAK,OAAO,EAAC,yBAA2B;YAE5D,EAAyE,AAAzE,uEAAyE;YACzE,MAAM,SAAS,YAAY,CAAC,EAAE,EAAE,GAAG,EAAE,YAAY,EAAE,QAAQ;QAC7D,CAAC;;YACQ,MAAM;YAAE,OAAO,EAAE,EAAE,CAAC,OAAO;;IACtC,CAAC,QAAQ,GAAG,EAAE,CAAC;QACb,EAA+D,AAA/D,6DAA+D;QAC/D,EAAE,EAAE,GAAG,YA5DkB,aAAiB,eA4DT,CAAC;YAChC,OAAO,CAAC,KAAK,CApED,MAAO,SAoEC,GAAG,EAAC,oBAAsB;YAC9C,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,OAAO;YACzB,OAAO,CAAC,IAAI,CAAC,CAAC;QAChB,CAAC,MAAM,EAAE,EAAE,GAAG,YA/DS,WAAe,aA+DA,CAAC;YACrC,OAAO,CAAC,KAAK,CAAC,GAAG,CAAC,OAAO;YACzB,OAAO,CAAC,IAAI,CAAC,CAAC;QAChB,CAAC;QACD,KAAK,CAAC,GAAG;IACX,CAAC;AACH,CAAC"}