{"version":3,"sources":["../../../next-server/server/next-server.ts"],"names":["getCustomRouteMatcher","Server","constructor","dir","quiet","conf","dev","minimalMode","customServer","nextConfig","distDir","pagesDir","publicDir","hasStaticDir","serverBuildDir","pagesManifest","buildId","renderOpts","compression","onErrorMiddleware","incrementalCache","router","dynamicRoutes","customRoutes","_cachedPreviewManifest","customErrorNo404Warn","console","warn","chalk","bold","yellow","_validFilesystemPathSet","phase","currentPhase","Log","CLIENT_PUBLIC_FILES_PATH","fs","existsSync","serverRuntimeConfig","publicRuntimeConfig","assetPrefix","generateEtags","compress","readBuildId","poweredByHeader","canonicalBase","amp","previewProps","getPreviewProps","undefined","ampOptimizerConfig","experimental","optimizer","basePath","images","JSON","stringify","optimizeFonts","fontManifest","_isLikeServerless","optimizeImages","optimizeCss","domainLocales","i18n","domains","Object","keys","length","runtimeConfig","target","envConfig","setConfig","SERVERLESS_DIRECTORY","SERVER_DIRECTORY","pagesManifestPath","PAGES_MANIFEST","require","getCustomRoutes","Router","generateRoutes","setAssetPrefix","plugins","initServer","default","IncrementalCache","locales","flushToDisk","sprFlushToDisk","process","env","__NEXT_OPTIMIZE_FONTS","__NEXT_OPTIMIZE_IMAGES","__NEXT_OPTIMIZE_CSS","PHASE_PRODUCTION_SERVER","logError","err","error","handleRequest","req","res","parsedUrl","url","query","__NEXT_INIT_QUERY","assign","startsWith","_nextHadBasePath","replace","pathname","parsed","defaultLocale","detectedLocale","acceptPreferredLocale","localeDetection","accept","language","headers","host","hostname","split","toLowerCase","detectedDomain","localeDomainRedirect","__nextHadTrailingSlash","endsWith","trailingSlash","localePathResult","__nextStrippedLocale","localeToCheck","matchedDomain","domain","http","denormalizedPagePath","detectedDefaultLocale","shouldStripDefaultLocale","shouldAddLocalePrefix","previous","getHeader","setHeader","Array","isArray","cookie","serialize","httpOnly","path","statusCode","TEMPORARY_REDIRECT_STATUS","end","__nextDefaultLocale","__nextLocale","reqUrlIsDataUrl","includes","matchedPathIsDataUrl","isDataUrl","parsedPath","matchedPathname","matchedPathnameNoExt","log","utils","pageIsDynamic","page","rewrites","params","paramsResult","normalizeDynamicRouteParams","hasValidParams","opts","getParamsFromRouteMatches","locale","dynamicRouteMatcher","interpolateDynamicPath","normalizeVercelUrl","run","getRequestHandler","bind","prefix","prepare","close","setImmutableAssetCacheControl","ROUTES_MANIFEST","getPrerenderManifest","manifest","PRERENDER_MANIFEST","preview","server","publicRoutes","generatePublicRoutes","staticFilesRoute","match","name","fn","p","serveStatic","finished","fsRoutes","type","render404","CLIENT_STATIC_FILES_RUNTIME","CLIENT_STATIC_FILES_PATH","_parsedUrl","shift","join","render","_nextDataReq","_params","getCustomRoute","r","source","_req","_res","map","headerRoute","hasParams","header","key","value","stringifyQuery","initialQueryValues","values","encodeURIComponent","some","val","redirects","redirect","redirectRoute","internal","parsedDestination","destination","search","updatedDestination","rewrite","rewriteRoute","check","newUrl","protocol","proxy","Proxy","changeOrigin","ignorePath","web","on","_nextRewroteUrl","_nextDidRewrite","catchAllRoute","Error","handled","handleApiRequest","useFileSystemPublicRoutes","getDynamicRoutes","pageChecker","hasPage","getPagePath","found","_","_beforeCatchAllRender","ensureApiPage","_pathname","pageFound","dynamicRoute","builtPagePath","code","pageModule","prepareServerlessUrl","publicFiles","Set","encodeURI","pathParts","basePathParts","every","part","idx","splice","has","addedPages","add","filter","item","Boolean","handleCompression","matched","execute","renderError","sendHTML","html","renderToHTML","findPageComponents","paths","pagePath","components","Component","getStaticProps","getStaticPaths","staticPaths","fallbackField","fallback","fallbackMode","renderToHTMLWithComponents","is404Page","isLikeServerless","renderReqToHTML","isSSG","isServerProps","getServerSideProps","hasStaticPaths","isDataReq","previewData","isPreviewMode","urlPathname","resolvedUrlPathname","stripNextDataPath","pop","handleRedirect","pageData","pageProps","__N_REDIRECT","__N_REDIRECT_STATUS","__N_REDIRECT_BASE_PATH","PERMANENT_REDIRECT_STATUS","ssgCacheKey","seg","decodeURIComponent","cachedData","get","data","revalidateOptions","private","stateful","revalidate","curRevalidate","isNotFound","isStale","maybeCoalesceInvoke","isOrigin","doRender","sprRevalidate","isRedirect","renderResult","origQuery","hadTrailingSlash","resolvedUrl","resolvedAsPath","isProduction","isDynamicPathname","didRespond","NoFallbackError","getFallback","__nextFallback","resHtml","set","result","dynamicRouteResult","renderErrorToHTML","setHeaders","is404","using404Page","NODE_ENV","maybeFallbackError","renderToHtmlError","isServeableUrl","method","getFilesystemPaths","pathUserFilesStatic","userFilesStatic","f","userFilesPublic","nextFilesStatic","untrustedFileUrl","decodedUntrustedFilePath","untrustedFilePath","indexOf","sep","filesystemUrls","resolved","buildIdFile","BUILD_ID_FILE","readFileSync","trim","curUrl"],"mappings":"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","sourcesContent":["import compression from 'next/dist/compiled/compression'\nimport fs from 'fs'\nimport chalk from 'chalk'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport Proxy from 'next/dist/compiled/http-proxy'\nimport { join, relative, resolve, sep } from 'path'\nimport {\n  parse as parseQs,\n  stringify as stringifyQs,\n  ParsedUrlQuery,\n} from 'querystring'\nimport { format as formatUrl, parse as parseUrl, UrlWithParsedQuery } from 'url'\nimport { PrerenderManifest } from '../../build'\nimport {\n  getRedirectStatus,\n  Header,\n  Redirect,\n  Rewrite,\n  RouteType,\n  CustomRoutes,\n} from '../../lib/load-custom-routes'\nimport { withCoalescedInvoke } from '../../lib/coalesced-function'\nimport {\n  BUILD_ID_FILE,\n  CLIENT_PUBLIC_FILES_PATH,\n  CLIENT_STATIC_FILES_PATH,\n  CLIENT_STATIC_FILES_RUNTIME,\n  PAGES_MANIFEST,\n  PERMANENT_REDIRECT_STATUS,\n  PHASE_PRODUCTION_SERVER,\n  PRERENDER_MANIFEST,\n  ROUTES_MANIFEST,\n  SERVERLESS_DIRECTORY,\n  SERVER_DIRECTORY,\n  TEMPORARY_REDIRECT_STATUS,\n} from '../lib/constants'\nimport {\n  getRouteMatcher,\n  getRouteRegex,\n  getSortedRoutes,\n  isDynamicRoute,\n} from '../lib/router/utils'\nimport * as envConfig from '../lib/runtime-config'\nimport { isResSent, NextApiRequest, NextApiResponse } from '../lib/utils'\nimport {\n  apiResolver,\n  setLazyProp,\n  getCookieParser,\n  tryGetPreviewData,\n  __ApiPreviewProps,\n} from './api-utils'\nimport loadConfig, {\n  DomainLocales,\n  isTargetLikeServerless,\n  NextConfig,\n} from './config'\nimport pathMatch from '../lib/router/utils/path-match'\nimport { recursiveReadDirSync } from './lib/recursive-readdir-sync'\nimport { loadComponents, LoadComponentsReturnType } from './load-components'\nimport { normalizePagePath } from './normalize-page-path'\nimport { RenderOpts, RenderOptsPartial, renderToHTML } from './render'\nimport { getPagePath, requireFontManifest } from './require'\nimport Router, {\n  DynamicRoutes,\n  PageChecker,\n  Params,\n  route,\n  Route,\n} from './router'\nimport prepareDestination, {\n  compileNonPath,\n} from '../lib/router/utils/prepare-destination'\nimport { sendPayload, setRevalidateHeaders } from './send-payload'\nimport { serveStatic } from './serve-static'\nimport { IncrementalCache } from './incremental-cache'\nimport { execOnce } from '../lib/utils'\nimport { isBlockedPage } from './utils'\nimport { loadEnvConfig } from '@next/env'\nimport './node-polyfill-fetch'\nimport { PagesManifest } from '../../build/webpack/plugins/pages-manifest-plugin'\nimport { removePathTrailingSlash } from '../../client/normalize-trailing-slash'\nimport getRouteFromAssetPath from '../lib/router/utils/get-route-from-asset-path'\nimport { FontManifest } from './font-utils'\nimport { denormalizePagePath } from './denormalize-page-path'\nimport accept from '@hapi/accept'\nimport { normalizeLocalePath } from '../lib/i18n/normalize-locale-path'\nimport { detectLocaleCookie } from '../lib/i18n/detect-locale-cookie'\nimport * as Log from '../../build/output/log'\nimport { imageOptimizer } from './image-optimizer'\nimport { detectDomainLocale } from '../lib/i18n/detect-domain-locale'\nimport cookie from 'next/dist/compiled/cookie'\nimport escapePathDelimiters from '../lib/router/utils/escape-path-delimiters'\nimport { getUtils } from '../../build/webpack/loaders/next-serverless-loader/utils'\n\nconst getCustomRouteMatcher = pathMatch(true)\n\ntype Middleware = (\n  req: IncomingMessage,\n  res: ServerResponse,\n  next: (err?: Error) => void\n) => void\n\ntype FindComponentsResult = {\n  components: LoadComponentsReturnType\n  query: ParsedUrlQuery\n}\n\ntype DynamicRouteItem = {\n  page: string\n  match: ReturnType<typeof getRouteMatcher>\n}\n\nexport type ServerConstructor = {\n  /**\n   * Where the Next project is located - @default '.'\n   */\n  dir?: string\n  /**\n   * Hide error messages containing server information - @default false\n   */\n  quiet?: boolean\n  /**\n   * Object what you would use in next.config.js - @default {}\n   */\n  conf?: NextConfig | null\n  dev?: boolean\n  customServer?: boolean\n}\n\nexport default class Server {\n  dir: string\n  quiet: boolean\n  nextConfig: NextConfig\n  distDir: string\n  pagesDir?: string\n  publicDir: string\n  hasStaticDir: boolean\n  serverBuildDir: string\n  pagesManifest?: PagesManifest\n  buildId: string\n  minimalMode: boolean\n  renderOpts: {\n    poweredByHeader: boolean\n    buildId: string\n    generateEtags: boolean\n    runtimeConfig?: { [key: string]: any }\n    assetPrefix?: string\n    canonicalBase: string\n    dev?: boolean\n    previewProps: __ApiPreviewProps\n    customServer?: boolean\n    ampOptimizerConfig?: { [key: string]: any }\n    basePath: string\n    optimizeFonts: boolean\n    images: string\n    fontManifest: FontManifest\n    optimizeImages: boolean\n    optimizeCss: any\n    locale?: string\n    locales?: string[]\n    defaultLocale?: string\n    domainLocales?: DomainLocales\n  }\n  private compression?: Middleware\n  private onErrorMiddleware?: ({ err }: { err: Error }) => Promise<void>\n  private incrementalCache: IncrementalCache\n  router: Router\n  protected dynamicRoutes?: DynamicRoutes\n  protected customRoutes: CustomRoutes\n\n  public constructor({\n    dir = '.',\n    quiet = false,\n    conf = null,\n    dev = false,\n    minimalMode = false,\n    customServer = true,\n  }: ServerConstructor & { minimalMode?: boolean } = {}) {\n    this.dir = resolve(dir)\n    this.quiet = quiet\n    const phase = this.currentPhase()\n    loadEnvConfig(this.dir, dev, Log)\n\n    this.nextConfig = loadConfig(phase, this.dir, conf)\n    this.distDir = join(this.dir, this.nextConfig.distDir)\n    this.publicDir = join(this.dir, CLIENT_PUBLIC_FILES_PATH)\n    this.hasStaticDir = fs.existsSync(join(this.dir, 'static'))\n\n    // Only serverRuntimeConfig needs the default\n    // publicRuntimeConfig gets it's default in client/index.js\n    const {\n      serverRuntimeConfig = {},\n      publicRuntimeConfig,\n      assetPrefix,\n      generateEtags,\n      compress,\n    } = this.nextConfig\n\n    this.buildId = this.readBuildId()\n    this.minimalMode = minimalMode\n\n    this.renderOpts = {\n      poweredByHeader: this.nextConfig.poweredByHeader,\n      canonicalBase: this.nextConfig.amp.canonicalBase,\n      buildId: this.buildId,\n      generateEtags,\n      previewProps: this.getPreviewProps(),\n      customServer: customServer === true ? true : undefined,\n      ampOptimizerConfig: this.nextConfig.experimental.amp?.optimizer,\n      basePath: this.nextConfig.basePath,\n      images: JSON.stringify(this.nextConfig.images),\n      optimizeFonts: this.nextConfig.experimental.optimizeFonts && !dev,\n      fontManifest:\n        this.nextConfig.experimental.optimizeFonts && !dev\n          ? requireFontManifest(this.distDir, this._isLikeServerless)\n          : null,\n      optimizeImages: this.nextConfig.experimental.optimizeImages,\n      optimizeCss: this.nextConfig.experimental.optimizeCss,\n      domainLocales: this.nextConfig.i18n?.domains,\n    }\n\n    // Only the `publicRuntimeConfig` key is exposed to the client side\n    // It'll be rendered as part of __NEXT_DATA__ on the client side\n    if (Object.keys(publicRuntimeConfig).length > 0) {\n      this.renderOpts.runtimeConfig = publicRuntimeConfig\n    }\n\n    if (compress && this.nextConfig.target === 'server') {\n      this.compression = compression() as Middleware\n    }\n\n    // Initialize next/config with the environment configuration\n    envConfig.setConfig({\n      serverRuntimeConfig,\n      publicRuntimeConfig,\n    })\n\n    this.serverBuildDir = join(\n      this.distDir,\n      this._isLikeServerless ? SERVERLESS_DIRECTORY : SERVER_DIRECTORY\n    )\n    const pagesManifestPath = join(this.serverBuildDir, PAGES_MANIFEST)\n\n    if (!dev) {\n      this.pagesManifest = require(pagesManifestPath)\n    }\n\n    this.customRoutes = this.getCustomRoutes()\n    this.router = new Router(this.generateRoutes())\n    this.setAssetPrefix(assetPrefix)\n\n    // call init-server middleware, this is also handled\n    // individually in serverless bundles when deployed\n    if (!dev && this.nextConfig.experimental.plugins) {\n      const initServer = require(join(this.serverBuildDir, 'init-server.js'))\n        .default\n      this.onErrorMiddleware = require(join(\n        this.serverBuildDir,\n        'on-error-server.js'\n      )).default\n      initServer()\n    }\n\n    this.incrementalCache = new IncrementalCache({\n      dev,\n      distDir: this.distDir,\n      pagesDir: join(\n        this.distDir,\n        this._isLikeServerless ? SERVERLESS_DIRECTORY : SERVER_DIRECTORY,\n        'pages'\n      ),\n      locales: this.nextConfig.i18n?.locales,\n      flushToDisk: !minimalMode && this.nextConfig.experimental.sprFlushToDisk,\n    })\n\n    /**\n     * This sets environment variable to be used at the time of SSR by head.tsx.\n     * Using this from process.env allows targetting both serverless and SSR by calling\n     * `process.env.__NEXT_OPTIMIZE_IMAGES`.\n     * TODO(atcastle@): Remove this when experimental.optimizeImages are being clened up.\n     */\n    if (this.renderOpts.optimizeFonts) {\n      process.env.__NEXT_OPTIMIZE_FONTS = JSON.stringify(true)\n    }\n    if (this.renderOpts.optimizeImages) {\n      process.env.__NEXT_OPTIMIZE_IMAGES = JSON.stringify(true)\n    }\n    if (this.renderOpts.optimizeCss) {\n      process.env.__NEXT_OPTIMIZE_CSS = JSON.stringify(true)\n    }\n  }\n\n  protected currentPhase(): string {\n    return PHASE_PRODUCTION_SERVER\n  }\n\n  public logError(err: Error): void {\n    if (this.onErrorMiddleware) {\n      this.onErrorMiddleware({ err })\n    }\n    if (this.quiet) return\n    console.error(err)\n  }\n\n  private async handleRequest(\n    req: IncomingMessage,\n    res: ServerResponse,\n    parsedUrl?: UrlWithParsedQuery\n  ): Promise<void> {\n    setLazyProp({ req: req as any }, 'cookies', getCookieParser(req))\n\n    // Parse url if parsedUrl not provided\n    if (!parsedUrl || typeof parsedUrl !== 'object') {\n      const url: any = req.url\n      parsedUrl = parseUrl(url, true)\n    }\n\n    // Parse the querystring ourselves if the user doesn't handle querystring parsing\n    if (typeof parsedUrl.query === 'string') {\n      parsedUrl.query = parseQs(parsedUrl.query)\n    }\n    ;(req as any).__NEXT_INIT_QUERY = Object.assign({}, parsedUrl.query)\n\n    const { basePath, i18n } = this.nextConfig\n\n    if (basePath && req.url?.startsWith(basePath)) {\n      // store original URL to allow checking if basePath was\n      // provided or not\n      ;(req as any)._nextHadBasePath = true\n      req.url = req.url!.replace(basePath, '') || '/'\n    }\n\n    if (i18n && !req.url?.startsWith('/_next')) {\n      // get pathname from URL with basePath stripped for locale detection\n      let { pathname, ...parsed } = parseUrl(req.url || '/')\n      pathname = pathname || '/'\n\n      let defaultLocale = i18n.defaultLocale\n      let detectedLocale = detectLocaleCookie(req, i18n.locales)\n      let acceptPreferredLocale =\n        i18n.localeDetection !== false\n          ? accept.language(req.headers['accept-language'], i18n.locales)\n          : detectedLocale\n\n      const { host } = req?.headers || {}\n      // remove port from host and remove port if present\n      const hostname = host?.split(':')[0].toLowerCase()\n\n      const detectedDomain = detectDomainLocale(i18n.domains, hostname)\n      if (detectedDomain) {\n        defaultLocale = detectedDomain.defaultLocale\n        detectedLocale = defaultLocale\n      }\n\n      // if not domain specific locale use accept-language preferred\n      detectedLocale = detectedLocale || acceptPreferredLocale\n\n      let localeDomainRedirect: string | undefined\n      ;(req as any).__nextHadTrailingSlash = pathname!.endsWith('/')\n\n      if (pathname === '/') {\n        ;(req as any).__nextHadTrailingSlash = this.nextConfig.trailingSlash\n      }\n      const localePathResult = normalizeLocalePath(pathname!, i18n.locales)\n\n      if (localePathResult.detectedLocale) {\n        detectedLocale = localePathResult.detectedLocale\n        req.url = formatUrl({\n          ...parsed,\n          pathname: localePathResult.pathname,\n        })\n        ;(req as any).__nextStrippedLocale = true\n      }\n\n      // If a detected locale is a domain specific locale and we aren't already\n      // on that domain and path prefix redirect to it to prevent duplicate\n      // content from multiple domains\n      if (detectedDomain && pathname === '/') {\n        const localeToCheck = acceptPreferredLocale\n        // const localeToCheck = localePathResult.detectedLocale\n        //   ? detectedLocale\n        //   : acceptPreferredLocale\n\n        const matchedDomain = detectDomainLocale(\n          i18n.domains,\n          undefined,\n          localeToCheck\n        )\n\n        if (\n          matchedDomain &&\n          (matchedDomain.domain !== detectedDomain.domain ||\n            localeToCheck !== matchedDomain.defaultLocale)\n        ) {\n          localeDomainRedirect = `http${matchedDomain.http ? '' : 's'}://${\n            matchedDomain.domain\n          }/${\n            localeToCheck === matchedDomain.defaultLocale ? '' : localeToCheck\n          }`\n        }\n      }\n\n      const denormalizedPagePath = denormalizePagePath(pathname || '/')\n      const detectedDefaultLocale =\n        !detectedLocale ||\n        detectedLocale.toLowerCase() === defaultLocale.toLowerCase()\n      const shouldStripDefaultLocale = false\n      // detectedDefaultLocale &&\n      // denormalizedPagePath.toLowerCase() ===\n      //   `/${i18n.defaultLocale.toLowerCase()}`\n\n      const shouldAddLocalePrefix =\n        !detectedDefaultLocale && denormalizedPagePath === '/'\n\n      detectedLocale = detectedLocale || i18n.defaultLocale\n\n      if (\n        i18n.localeDetection !== false &&\n        (localeDomainRedirect ||\n          shouldAddLocalePrefix ||\n          shouldStripDefaultLocale)\n      ) {\n        // set the NEXT_LOCALE cookie when a user visits the default locale\n        // with the locale prefix so that they aren't redirected back to\n        // their accept-language preferred locale\n        if (\n          shouldStripDefaultLocale &&\n          acceptPreferredLocale !== defaultLocale\n        ) {\n          const previous = res.getHeader('set-cookie')\n\n          res.setHeader('set-cookie', [\n            ...(typeof previous === 'string'\n              ? [previous]\n              : Array.isArray(previous)\n              ? previous\n              : []),\n            cookie.serialize('NEXT_LOCALE', defaultLocale, {\n              httpOnly: true,\n              path: '/',\n            }),\n          ])\n        }\n\n        res.setHeader(\n          'Location',\n          localeDomainRedirect\n            ? localeDomainRedirect\n            : formatUrl({\n                // make sure to include any query values when redirecting\n                ...parsed,\n                pathname: shouldStripDefaultLocale\n                  ? basePath || `/`\n                  : `${basePath || ''}/${detectedLocale}`,\n              })\n        )\n        res.statusCode = TEMPORARY_REDIRECT_STATUS\n        res.end()\n        return\n      }\n\n      parsedUrl.query.__nextDefaultLocale =\n        detectedDomain?.defaultLocale || i18n.defaultLocale\n\n      parsedUrl.query.__nextLocale =\n        localePathResult.detectedLocale ||\n        detectedDomain?.defaultLocale ||\n        defaultLocale\n    }\n\n    if (\n      this.minimalMode &&\n      req.headers['x-matched-path'] &&\n      typeof req.headers['x-matched-path'] === 'string'\n    ) {\n      const reqUrlIsDataUrl = req.url?.includes('/_next/data')\n      const matchedPathIsDataUrl = req.headers['x-matched-path']?.includes(\n        '/_next/data'\n      )\n      const isDataUrl = reqUrlIsDataUrl || matchedPathIsDataUrl\n\n      let parsedPath = parseUrl(\n        isDataUrl ? req.url! : (req.headers['x-matched-path'] as string),\n        true\n      )\n      const { pathname, query } = parsedPath\n      let matchedPathname = pathname as string\n\n      const matchedPathnameNoExt = isDataUrl\n        ? matchedPathname.replace(/\\.json$/, '')\n        : matchedPathname\n\n      console.log({\n        reqUrlIsDataUrl,\n        matchedPathIsDataUrl,\n        isDataUrl,\n        parsedPath,\n        pathname,\n        query,\n        matchedPathname,\n        matchedPathnameNoExt\n      })\n\n      // interpolate dynamic params and normalize URL if needed\n      if (isDynamicRoute(matchedPathnameNoExt)) {\n        const utils = getUtils({\n          pageIsDynamic: true,\n          page: matchedPathnameNoExt,\n          i18n: this.nextConfig.i18n,\n          basePath: this.nextConfig.basePath,\n          rewrites: this.customRoutes.rewrites,\n        })\n\n        let params: ParsedUrlQuery | false = {}\n        const paramsResult = utils.normalizeDynamicRouteParams({\n          ...parsedUrl.query,\n          ...query,\n        })\n\n        if (paramsResult.hasValidParams) {\n          params = paramsResult.params\n        } else if (req.headers['x-now-route-matches']) {\n          const opts: Record<string, string> = {}\n          params = utils.getParamsFromRouteMatches(\n            req,\n            opts,\n            (parsedUrl.query.__nextLocale as string | undefined) || ''\n          )\n\n          if (opts.locale) {\n            parsedUrl.query.__nextLocale = opts.locale\n          }\n        } else {\n          params = utils.dynamicRouteMatcher!(matchedPathname)\n        }\n\n        console.log({ params });\n\n        if (params) {\n          console.log('before interpolating', {\n            matchedPathname,\n            url: req.url\n          });\n          matchedPathname = utils.interpolateDynamicPath(\n            matchedPathname,\n            params\n          )\n\n          req.url = utils.interpolateDynamicPath(req.url!, params)\n\n          console.log('after interpolating', {\n            matchedPathname,\n            url: req.url\n          });\n        }\n\n        if (reqUrlIsDataUrl && matchedPathIsDataUrl) {\n          req.url = formatUrl({\n            ...parsedPath,\n            pathname: matchedPathname,\n          })\n          console.log('updated req.url for data path', {\n            url: req.url,\n            reqUrlIsDataUrl,\n            matchedPathIsDataUrl\n          });\n        }\n        Object.assign(parsedUrl.query, params)\n        console.log('before normalize URL', req.url);\n        utils.normalizeVercelUrl(req, true)\n        console.log('after normalize URL', req.url);\n      }\n      parsedUrl.pathname = `${basePath || ''}${\n        parsedUrl.query.__nextLocale || ''\n      }${matchedPathname}`\n\n      console.log('parsedUrl.pathname', parsedUrl.pathname);\n    }\n\n    res.statusCode = 200\n    try {\n      return await this.run(req, res, parsedUrl)\n    } catch (err) {\n      this.logError(err)\n      res.statusCode = 500\n      res.end('Internal Server Error')\n    }\n  }\n\n  public getRequestHandler() {\n    return this.handleRequest.bind(this)\n  }\n\n  public setAssetPrefix(prefix?: string): void {\n    this.renderOpts.assetPrefix = prefix ? prefix.replace(/\\/$/, '') : ''\n  }\n\n  // Backwards compatibility\n  public async prepare(): Promise<void> {}\n\n  // Backwards compatibility\n  protected async close(): Promise<void> {}\n\n  protected setImmutableAssetCacheControl(res: ServerResponse): void {\n    res.setHeader('Cache-Control', 'public, max-age=31536000, immutable')\n  }\n\n  protected getCustomRoutes(): CustomRoutes {\n    return require(join(this.distDir, ROUTES_MANIFEST))\n  }\n\n  private _cachedPreviewManifest: PrerenderManifest | undefined\n  protected getPrerenderManifest(): PrerenderManifest {\n    if (this._cachedPreviewManifest) {\n      return this._cachedPreviewManifest\n    }\n    const manifest = require(join(this.distDir, PRERENDER_MANIFEST))\n    return (this._cachedPreviewManifest = manifest)\n  }\n\n  protected getPreviewProps(): __ApiPreviewProps {\n    return this.getPrerenderManifest().preview\n  }\n\n  protected generateRoutes(): {\n    basePath: string\n    headers: Route[]\n    rewrites: Route[]\n    fsRoutes: Route[]\n    redirects: Route[]\n    catchAllRoute: Route\n    pageChecker: PageChecker\n    useFileSystemPublicRoutes: boolean\n    dynamicRoutes: DynamicRoutes | undefined\n    locales: string[]\n  } {\n    const server: Server = this\n    const publicRoutes = fs.existsSync(this.publicDir)\n      ? this.generatePublicRoutes()\n      : []\n\n    const staticFilesRoute = this.hasStaticDir\n      ? [\n          {\n            // It's very important to keep this route's param optional.\n            // (but it should support as many params as needed, separated by '/')\n            // Otherwise this will lead to a pretty simple DOS attack.\n            // See more: https://github.com/vercel/next.js/issues/2617\n            match: route('/static/:path*'),\n            name: 'static catchall',\n            fn: async (req, res, params, parsedUrl) => {\n              const p = join(this.dir, 'static', ...params.path)\n              await this.serveStatic(req, res, p, parsedUrl)\n              return {\n                finished: true,\n              }\n            },\n          } as Route,\n        ]\n      : []\n\n    const fsRoutes: Route[] = [\n      {\n        match: route('/_next/static/:path*'),\n        type: 'route',\n        name: '_next/static catchall',\n        fn: async (req, res, params, parsedUrl) => {\n          // make sure to 404 for /_next/static itself\n          if (!params.path) {\n            await this.render404(req, res, parsedUrl)\n            return {\n              finished: true,\n            }\n          }\n\n          if (\n            params.path[0] === CLIENT_STATIC_FILES_RUNTIME ||\n            params.path[0] === 'chunks' ||\n            params.path[0] === 'css' ||\n            params.path[0] === 'media' ||\n            params.path[0] === this.buildId ||\n            params.path[0] === 'pages' ||\n            params.path[1] === 'pages'\n          ) {\n            this.setImmutableAssetCacheControl(res)\n          }\n          const p = join(\n            this.distDir,\n            CLIENT_STATIC_FILES_PATH,\n            ...(params.path || [])\n          )\n          await this.serveStatic(req, res, p, parsedUrl)\n          return {\n            finished: true,\n          }\n        },\n      },\n      {\n        match: route('/_next/data/:path*'),\n        type: 'route',\n        name: '_next/data catchall',\n        fn: async (req, res, params, _parsedUrl) => {\n          // Make sure to 404 for /_next/data/ itself and\n          // we also want to 404 if the buildId isn't correct\n          if (!params.path || params.path[0] !== this.buildId) {\n            await this.render404(req, res, _parsedUrl)\n            return {\n              finished: true,\n            }\n          }\n          // remove buildId from URL\n          params.path.shift()\n\n          // show 404 if it doesn't end with .json\n          if (!params.path[params.path.length - 1].endsWith('.json')) {\n            await this.render404(req, res, _parsedUrl)\n            return {\n              finished: true,\n            }\n          }\n\n          // re-create page's pathname\n          let pathname = `/${params.path.join('/')}`\n          pathname = getRouteFromAssetPath(pathname, '.json')\n\n          const { i18n } = this.nextConfig\n\n          if (i18n) {\n            const { host } = req?.headers || {}\n            // remove port from host and remove port if present\n            const hostname = host?.split(':')[0].toLowerCase()\n            const localePathResult = normalizeLocalePath(pathname, i18n.locales)\n            const { defaultLocale } =\n              detectDomainLocale(i18n.domains, hostname) || {}\n\n            let detectedLocale = ''\n\n            if (localePathResult.detectedLocale) {\n              pathname = localePathResult.pathname\n              detectedLocale = localePathResult.detectedLocale\n            }\n\n            _parsedUrl.query.__nextLocale = detectedLocale!\n            _parsedUrl.query.__nextDefaultLocale =\n              defaultLocale || i18n.defaultLocale\n\n            if (!detectedLocale) {\n              _parsedUrl.query.__nextLocale =\n                _parsedUrl.query.__nextDefaultLocale\n              await this.render404(req, res, _parsedUrl)\n              return { finished: true }\n            }\n          }\n\n          const parsedUrl = parseUrl(pathname, true)\n\n          await this.render(\n            req,\n            res,\n            pathname,\n            { ..._parsedUrl.query, _nextDataReq: '1' },\n            parsedUrl\n          )\n          return {\n            finished: true,\n          }\n        },\n      },\n      {\n        match: route('/_next/image'),\n        type: 'route',\n        name: '_next/image catchall',\n        fn: (req, res, _params, parsedUrl) =>\n          imageOptimizer(server, req, res, parsedUrl),\n      },\n      {\n        match: route('/_next/:path*'),\n        type: 'route',\n        name: '_next catchall',\n        // This path is needed because `render()` does a check for `/_next` and the calls the routing again\n        fn: async (req, res, _params, parsedUrl) => {\n          await this.render404(req, res, parsedUrl)\n          return {\n            finished: true,\n          }\n        },\n      },\n      ...publicRoutes,\n      ...staticFilesRoute,\n    ]\n\n    const getCustomRoute = (\n      r: Rewrite | Redirect | Header,\n      type: RouteType\n    ) => {\n      const match = getCustomRouteMatcher(r.source)\n\n      return {\n        ...r,\n        type,\n        match,\n        name: type,\n        fn: async (_req, _res, _params, _parsedUrl) => ({ finished: false }),\n      } as Route & Rewrite & Header\n    }\n\n    // Headers come very first\n    const headers = this.customRoutes.headers.map((r) => {\n      const headerRoute = getCustomRoute(r, 'header')\n      return {\n        match: headerRoute.match,\n        type: headerRoute.type,\n        name: `${headerRoute.type} ${headerRoute.source} header route`,\n        fn: async (_req, res, params, _parsedUrl) => {\n          const hasParams = Object.keys(params).length > 0\n\n          for (const header of (headerRoute as Header).headers) {\n            let { key, value } = header\n            if (hasParams) {\n              key = compileNonPath(key, params)\n              value = compileNonPath(value, params)\n            }\n            res.setHeader(key, value)\n          }\n          return { finished: false }\n        },\n      } as Route\n    })\n\n    // since initial query values are decoded by querystring.parse\n    // we need to re-encode them here but still allow passing through\n    // values from rewrites/redirects\n    const stringifyQuery = (req: IncomingMessage, query: ParsedUrlQuery) => {\n      const initialQueryValues = Object.values((req as any).__NEXT_INIT_QUERY)\n\n      return stringifyQs(query, undefined, undefined, {\n        encodeURIComponent(value) {\n          if (initialQueryValues.some((val) => val === value)) {\n            return encodeURIComponent(value)\n          }\n          return value\n        },\n      })\n    }\n\n    const redirects = this.minimalMode\n      ? []\n      : this.customRoutes.redirects.map((redirect) => {\n          const redirectRoute = getCustomRoute(redirect, 'redirect')\n          return {\n            internal: redirectRoute.internal,\n            type: redirectRoute.type,\n            match: redirectRoute.match,\n            statusCode: redirectRoute.statusCode,\n            name: `Redirect route ${redirectRoute.source}`,\n            fn: async (req, res, params, parsedUrl) => {\n              const { parsedDestination } = prepareDestination(\n                redirectRoute.destination,\n                params,\n                parsedUrl.query,\n                false\n              )\n\n              const { query } = parsedDestination\n              delete (parsedDestination as any).query\n\n              parsedDestination.search = stringifyQuery(req, query)\n\n              const updatedDestination = formatUrl(parsedDestination)\n\n              res.setHeader('Location', updatedDestination)\n              res.statusCode = getRedirectStatus(redirectRoute as Redirect)\n\n              // Since IE11 doesn't support the 308 header add backwards\n              // compatibility using refresh header\n              if (res.statusCode === 308) {\n                res.setHeader('Refresh', `0;url=${updatedDestination}`)\n              }\n\n              res.end()\n              return {\n                finished: true,\n              }\n            },\n          } as Route\n        })\n\n    const rewrites = this.customRoutes.rewrites.map((rewrite) => {\n      const rewriteRoute = getCustomRoute(rewrite, 'rewrite')\n      return {\n        ...rewriteRoute,\n        check: true,\n        type: rewriteRoute.type,\n        name: `Rewrite route ${rewriteRoute.source}`,\n        match: rewriteRoute.match,\n        fn: async (req, res, params, parsedUrl) => {\n          const { newUrl, parsedDestination } = prepareDestination(\n            rewriteRoute.destination,\n            params,\n            parsedUrl.query,\n            true\n          )\n\n          // external rewrite, proxy it\n          if (parsedDestination.protocol) {\n            const { query } = parsedDestination\n            delete (parsedDestination as any).query\n            parsedDestination.search = stringifyQuery(req, query)\n\n            const target = formatUrl(parsedDestination)\n            const proxy = new Proxy({\n              target,\n              changeOrigin: true,\n              ignorePath: true,\n            })\n            proxy.web(req, res)\n\n            proxy.on('error', (err: Error) => {\n              console.error(`Error occurred proxying ${target}`, err)\n            })\n            return {\n              finished: true,\n            }\n          }\n          ;(req as any)._nextRewroteUrl = newUrl\n          ;(req as any)._nextDidRewrite =\n            (req as any)._nextRewroteUrl !== req.url\n\n          return {\n            finished: false,\n            pathname: newUrl,\n            query: parsedDestination.query,\n          }\n        },\n      } as Route\n    })\n\n    const catchAllRoute: Route = {\n      match: route('/:path*'),\n      type: 'route',\n      name: 'Catchall render',\n      fn: async (req, res, _params, parsedUrl) => {\n        let { pathname, query } = parsedUrl\n        if (!pathname) {\n          throw new Error('pathname is undefined')\n        }\n\n        // next.js core assumes page path without trailing slash\n        pathname = removePathTrailingSlash(pathname)\n\n        if (this.nextConfig.i18n) {\n          const localePathResult = normalizeLocalePath(\n            pathname,\n            this.nextConfig.i18n?.locales\n          )\n\n          if (localePathResult.detectedLocale) {\n            pathname = localePathResult.pathname\n            parsedUrl.query.__nextLocale = localePathResult.detectedLocale\n          }\n        }\n\n        if (pathname === '/api' || pathname.startsWith('/api/')) {\n          const handled = await this.handleApiRequest(\n            req as NextApiRequest,\n            res as NextApiResponse,\n            pathname,\n            query\n          )\n          if (handled) {\n            return { finished: true }\n          }\n        }\n\n        await this.render(req, res, pathname, query, parsedUrl)\n        return {\n          finished: true,\n        }\n      },\n    }\n\n    const { useFileSystemPublicRoutes } = this.nextConfig\n\n    if (useFileSystemPublicRoutes) {\n      this.dynamicRoutes = this.getDynamicRoutes()\n    }\n\n    return {\n      headers,\n      fsRoutes,\n      rewrites,\n      redirects,\n      catchAllRoute,\n      useFileSystemPublicRoutes,\n      dynamicRoutes: this.dynamicRoutes,\n      basePath: this.nextConfig.basePath,\n      pageChecker: this.hasPage.bind(this),\n      locales: this.nextConfig.i18n?.locales || [],\n    }\n  }\n\n  private async getPagePath(pathname: string): Promise<string> {\n    return getPagePath(\n      pathname,\n      this.distDir,\n      this._isLikeServerless,\n      this.renderOpts.dev\n    )\n  }\n\n  protected async hasPage(pathname: string): Promise<boolean> {\n    let found = false\n    try {\n      found = !!(await this.getPagePath(pathname))\n    } catch (_) {}\n\n    return found\n  }\n\n  protected async _beforeCatchAllRender(\n    _req: IncomingMessage,\n    _res: ServerResponse,\n    _params: Params,\n    _parsedUrl: UrlWithParsedQuery\n  ): Promise<boolean> {\n    return false\n  }\n\n  // Used to build API page in development\n  protected async ensureApiPage(_pathname: string): Promise<void> {}\n\n  /**\n   * Resolves `API` request, in development builds on demand\n   * @param req http request\n   * @param res http response\n   * @param pathname path of request\n   */\n  private async handleApiRequest(\n    req: IncomingMessage,\n    res: ServerResponse,\n    pathname: string,\n    query: ParsedUrlQuery\n  ): Promise<boolean> {\n    let page = pathname\n    let params: Params | boolean = false\n    let pageFound = await this.hasPage(page)\n\n    if (!pageFound && this.dynamicRoutes) {\n      for (const dynamicRoute of this.dynamicRoutes) {\n        params = dynamicRoute.match(pathname)\n        if (dynamicRoute.page.startsWith('/api') && params) {\n          page = dynamicRoute.page\n          pageFound = true\n          break\n        }\n      }\n    }\n\n    if (!pageFound) {\n      return false\n    }\n    // Make sure the page is built before getting the path\n    // or else it won't be in the manifest yet\n    await this.ensureApiPage(page)\n\n    let builtPagePath\n    try {\n      builtPagePath = await this.getPagePath(page)\n    } catch (err) {\n      if (err.code === 'ENOENT') {\n        return false\n      }\n      throw err\n    }\n\n    const pageModule = await require(builtPagePath)\n    query = { ...query, ...params }\n\n    delete query.__nextLocale\n    delete query.__nextDefaultLocale\n\n    if (!this.renderOpts.dev && this._isLikeServerless) {\n      if (typeof pageModule.default === 'function') {\n        prepareServerlessUrl(req, query)\n        await pageModule.default(req, res)\n        return true\n      }\n    }\n\n    await apiResolver(\n      req,\n      res,\n      query,\n      pageModule,\n      this.renderOpts.previewProps,\n      false,\n      this.onErrorMiddleware\n    )\n    return true\n  }\n\n  protected generatePublicRoutes(): Route[] {\n    const publicFiles = new Set(\n      recursiveReadDirSync(this.publicDir).map((p) =>\n        encodeURI(p.replace(/\\\\/g, '/'))\n      )\n    )\n\n    return [\n      {\n        match: route('/:path*'),\n        name: 'public folder catchall',\n        fn: async (req, res, params, parsedUrl) => {\n          const pathParts: string[] = params.path || []\n          const { basePath } = this.nextConfig\n\n          // if basePath is defined require it be present\n          if (basePath) {\n            const basePathParts = basePath.split('/')\n            // remove first empty value\n            basePathParts.shift()\n\n            if (\n              !basePathParts.every((part: string, idx: number) => {\n                return part === pathParts[idx]\n              })\n            ) {\n              return { finished: false }\n            }\n\n            pathParts.splice(0, basePathParts.length)\n          }\n\n          const path = `/${pathParts.join('/')}`\n\n          if (publicFiles.has(path)) {\n            await this.serveStatic(\n              req,\n              res,\n              join(this.publicDir, ...pathParts),\n              parsedUrl\n            )\n            return {\n              finished: true,\n            }\n          }\n          return {\n            finished: false,\n          }\n        },\n      } as Route,\n    ]\n  }\n\n  protected getDynamicRoutes(): Array<DynamicRouteItem> {\n    const addedPages = new Set<string>()\n\n    return getSortedRoutes(\n      Object.keys(this.pagesManifest!).map(\n        (page) =>\n          normalizeLocalePath(page, this.nextConfig.i18n?.locales).pathname\n      )\n    )\n      .map((page) => {\n        if (addedPages.has(page) || !isDynamicRoute(page)) return null\n        addedPages.add(page)\n        return {\n          page,\n          match: getRouteMatcher(getRouteRegex(page)),\n        }\n      })\n      .filter((item): item is DynamicRouteItem => Boolean(item))\n  }\n\n  private handleCompression(req: IncomingMessage, res: ServerResponse): void {\n    if (this.compression) {\n      this.compression(req, res, () => {})\n    }\n  }\n\n  protected async run(\n    req: IncomingMessage,\n    res: ServerResponse,\n    parsedUrl: UrlWithParsedQuery\n  ): Promise<void> {\n    this.handleCompression(req, res)\n\n    try {\n      const matched = await this.router.execute(req, res, parsedUrl)\n      if (matched) {\n        return\n      }\n    } catch (err) {\n      if (err.code === 'DECODE_FAILED') {\n        res.statusCode = 400\n        return this.renderError(null, req, res, '/_error', {})\n      }\n      throw err\n    }\n\n    await this.render404(req, res, parsedUrl)\n  }\n\n  protected async sendHTML(\n    req: IncomingMessage,\n    res: ServerResponse,\n    html: string\n  ): Promise<void> {\n    const { generateEtags, poweredByHeader } = this.renderOpts\n    return sendPayload(req, res, html, 'html', {\n      generateEtags,\n      poweredByHeader,\n    })\n  }\n\n  public async render(\n    req: IncomingMessage,\n    res: ServerResponse,\n    pathname: string,\n    query: ParsedUrlQuery = {},\n    parsedUrl?: UrlWithParsedQuery\n  ): Promise<void> {\n    if (!pathname.startsWith('/')) {\n      console.warn(\n        `Cannot render page with path \"${pathname}\", did you mean \"/${pathname}\"?. See more info here: https://err.sh/next.js/render-no-starting-slash`\n      )\n    }\n\n    if (\n      this.renderOpts.customServer &&\n      pathname === '/index' &&\n      !(await this.hasPage('/index'))\n    ) {\n      // maintain backwards compatibility for custom server\n      // (see custom-server integration tests)\n      pathname = '/'\n    }\n\n    const url: any = req.url\n\n    // we allow custom servers to call render for all URLs\n    // so check if we need to serve a static _next file or not.\n    // we don't modify the URL for _next/data request but still\n    // call render so we special case this to prevent an infinite loop\n    if (\n      !query._nextDataReq &&\n      (url.match(/^\\/_next\\//) ||\n        (this.hasStaticDir && url.match(/^\\/static\\//)))\n    ) {\n      return this.handleRequest(req, res, parsedUrl)\n    }\n\n    if (isBlockedPage(pathname)) {\n      return this.render404(req, res, parsedUrl)\n    }\n\n    const html = await this.renderToHTML(req, res, pathname, query)\n    // Request was ended by the user\n    if (html === null) {\n      return\n    }\n\n    return this.sendHTML(req, res, html)\n  }\n\n  private async findPageComponents(\n    pathname: string,\n    query: ParsedUrlQuery = {},\n    params: Params | null = null\n  ): Promise<FindComponentsResult | null> {\n    let paths = [\n      // try serving a static AMP version first\n      query.amp ? normalizePagePath(pathname) + '.amp' : null,\n      pathname,\n    ].filter(Boolean)\n\n    if (query.__nextLocale) {\n      paths = [\n        ...paths.map(\n          (path) => `/${query.__nextLocale}${path === '/' ? '' : path}`\n        ),\n        ...paths,\n      ]\n    }\n\n    for (const pagePath of paths) {\n      try {\n        const components = await loadComponents(\n          this.distDir,\n          pagePath!,\n          !this.renderOpts.dev && this._isLikeServerless\n        )\n        // if loading an static HTML file the locale is required\n        // to be present since all HTML files are output under their locale\n        if (\n          query.__nextLocale &&\n          typeof components.Component === 'string' &&\n          !pagePath?.startsWith(`/${query.__nextLocale}`)\n        ) {\n          const err = new Error('NOT_FOUND')\n          ;(err as any).code = 'ENOENT'\n          throw err\n        }\n\n        return {\n          components,\n          query: {\n            ...(components.getStaticProps\n              ? {\n                  amp: query.amp,\n                  _nextDataReq: query._nextDataReq,\n                  __nextLocale: query.__nextLocale,\n                  __nextDefaultLocale: query.__nextDefaultLocale,\n                }\n              : query),\n            ...(params || {}),\n          },\n        }\n      } catch (err) {\n        if (err.code !== 'ENOENT') throw err\n      }\n    }\n    return null\n  }\n\n  protected async getStaticPaths(\n    pathname: string\n  ): Promise<{\n    staticPaths: string[] | undefined\n    fallbackMode: 'static' | 'blocking' | false\n  }> {\n    // `staticPaths` is intentionally set to `undefined` as it should've\n    // been caught when checking disk data.\n    const staticPaths = undefined\n\n    // Read whether or not fallback should exist from the manifest.\n    const fallbackField = this.getPrerenderManifest().dynamicRoutes[pathname]\n      .fallback\n\n    return {\n      staticPaths,\n      fallbackMode:\n        typeof fallbackField === 'string'\n          ? 'static'\n          : fallbackField === null\n          ? 'blocking'\n          : false,\n    }\n  }\n\n  private async renderToHTMLWithComponents(\n    req: IncomingMessage,\n    res: ServerResponse,\n    pathname: string,\n    { components, query }: FindComponentsResult,\n    opts: RenderOptsPartial\n  ): Promise<string | null> {\n    const is404Page = pathname === '/404'\n\n    const isLikeServerless =\n      typeof components.Component === 'object' &&\n      typeof (components.Component as any).renderReqToHTML === 'function'\n    const isSSG = !!components.getStaticProps\n    const isServerProps = !!components.getServerSideProps\n    const hasStaticPaths = !!components.getStaticPaths\n\n    // Toggle whether or not this is a Data request\n    const isDataReq = !!query._nextDataReq && (isSSG || isServerProps)\n    delete query._nextDataReq\n\n    // we need to ensure the status code if /404 is visited directly\n    if (is404Page && !isDataReq) {\n      res.statusCode = 404\n    }\n\n    // handle static page\n    if (typeof components.Component === 'string') {\n      return components.Component\n    }\n\n    if (!query.amp) {\n      delete query.amp\n    }\n\n    const locale = query.__nextLocale as string\n    const defaultLocale = isSSG\n      ? this.nextConfig.i18n?.defaultLocale\n      : (query.__nextDefaultLocale as string)\n\n    const { i18n } = this.nextConfig\n    const locales = i18n?.locales\n\n    let previewData: string | false | object | undefined\n    let isPreviewMode = false\n\n    if (isServerProps || isSSG) {\n      previewData = tryGetPreviewData(req, res, this.renderOpts.previewProps)\n      isPreviewMode = previewData !== false\n    }\n\n    // Compute the iSSG cache key. We use the rewroteUrl since\n    // pages with fallback: false are allowed to be rewritten to\n    // and we need to look up the path by the rewritten path\n    let urlPathname = parseUrl(req.url || '').pathname || '/'\n\n    let resolvedUrlPathname = (req as any)._nextRewroteUrl\n      ? (req as any)._nextRewroteUrl\n      : urlPathname\n\n    urlPathname = removePathTrailingSlash(urlPathname)\n    resolvedUrlPathname = normalizeLocalePath(\n      removePathTrailingSlash(resolvedUrlPathname),\n      this.nextConfig.i18n?.locales\n    ).pathname\n\n    const stripNextDataPath = (path: string) => {\n      if (path.includes(this.buildId)) {\n        path = denormalizePagePath(\n          (path.split(this.buildId).pop() || '/').replace(/\\.json$/, '')\n        )\n      }\n\n      if (this.nextConfig.i18n) {\n        return normalizeLocalePath(path, locales).pathname\n      }\n      return path\n    }\n\n    const handleRedirect = (pageData: any) => {\n      const redirect = {\n        destination: pageData.pageProps.__N_REDIRECT,\n        statusCode: pageData.pageProps.__N_REDIRECT_STATUS,\n        basePath: pageData.pageProps.__N_REDIRECT_BASE_PATH,\n      }\n      const statusCode = getRedirectStatus(redirect)\n      const { basePath } = this.nextConfig\n\n      if (basePath && redirect.basePath !== false) {\n        redirect.destination = `${basePath}${redirect.destination}`\n      }\n\n      if (statusCode === PERMANENT_REDIRECT_STATUS) {\n        res.setHeader('Refresh', `0;url=${redirect.destination}`)\n      }\n\n      res.statusCode = statusCode\n      res.setHeader('Location', redirect.destination)\n      res.end()\n    }\n\n    // remove /_next/data prefix from urlPathname so it matches\n    // for direct page visit and /_next/data visit\n    if (isDataReq) {\n      resolvedUrlPathname = stripNextDataPath(resolvedUrlPathname)\n      urlPathname = stripNextDataPath(urlPathname)\n    }\n\n    let ssgCacheKey =\n      isPreviewMode || !isSSG || this.minimalMode\n        ? undefined // Preview mode bypasses the cache\n        : `${locale ? `/${locale}` : ''}${\n            (pathname === '/' || resolvedUrlPathname === '/') && locale\n              ? ''\n              : resolvedUrlPathname\n          }${query.amp ? '.amp' : ''}`\n\n    if (is404Page && isSSG) {\n      ssgCacheKey = `${locale ? `/${locale}` : ''}${pathname}${\n        query.amp ? '.amp' : ''\n      }`\n    }\n\n    if (ssgCacheKey) {\n      // we only encode path delimiters for path segments from\n      // getStaticPaths so we need to attempt decoding the URL\n      // to match against and only escape the path delimiters\n      // this allows non-ascii values to be handled e.g. Japanese characters\n\n      // TODO: investigate adding this handling for non-SSG pages so\n      // non-ascii names work there also\n      ssgCacheKey = ssgCacheKey\n        .split('/')\n        .map((seg) => {\n          try {\n            seg = escapePathDelimiters(decodeURIComponent(seg), true)\n          } catch (_) {\n            // An improperly encoded URL was provided, this is considered\n            // a bad request (400)\n            const err: Error & { code?: string } = new Error(\n              'failed to decode param'\n            )\n            err.code = 'DECODE_FAILED'\n            throw err\n          }\n          return seg\n        })\n        .join('/')\n    }\n\n    // Complete the response with cached data if its present\n    const cachedData = ssgCacheKey\n      ? await this.incrementalCache.get(ssgCacheKey)\n      : undefined\n\n    if (cachedData) {\n      const data = isDataReq\n        ? JSON.stringify(cachedData.pageData)\n        : cachedData.html\n\n      const revalidateOptions = !this.renderOpts.dev\n        ? {\n            private: isPreviewMode,\n            stateful: false, // GSP response\n            revalidate:\n              cachedData.curRevalidate !== undefined\n                ? cachedData.curRevalidate\n                : /* default to minimum revalidate (this should be an invariant) */ 1,\n          }\n        : undefined\n\n      if (!isDataReq && cachedData.pageData?.pageProps?.__N_REDIRECT) {\n        await handleRedirect(cachedData.pageData)\n      } else if (cachedData.isNotFound) {\n        if (revalidateOptions) {\n          setRevalidateHeaders(res, revalidateOptions)\n        }\n        if (isDataReq) {\n          res.statusCode = 404\n          res.end('{\"notFound\":true}')\n        } else {\n          await this.render404(req, res, {\n            pathname,\n            query,\n          } as UrlWithParsedQuery)\n        }\n      } else {\n        sendPayload(\n          req,\n          res,\n          data,\n          isDataReq ? 'json' : 'html',\n          {\n            generateEtags: this.renderOpts.generateEtags,\n            poweredByHeader: this.renderOpts.poweredByHeader,\n          },\n          revalidateOptions\n        )\n      }\n\n      // Stop the request chain here if the data we sent was up-to-date\n      if (!cachedData.isStale) {\n        return null\n      }\n    }\n\n    // If we're here, that means data is missing or it's stale.\n    const maybeCoalesceInvoke = ssgCacheKey\n      ? (fn: any) => withCoalescedInvoke(fn).bind(null, ssgCacheKey!, [])\n      : (fn: any) => async () => {\n          const value = await fn()\n          return { isOrigin: true, value }\n        }\n\n    const doRender = maybeCoalesceInvoke(\n      async (): Promise<{\n        html: string | null\n        pageData: any\n        sprRevalidate: number | false\n        isNotFound?: boolean\n        isRedirect?: boolean\n      }> => {\n        let pageData: any\n        let html: string | null\n        let sprRevalidate: number | false\n        let isNotFound: boolean | undefined\n        let isRedirect: boolean | undefined\n\n        let renderResult\n        // handle serverless\n        if (isLikeServerless) {\n          renderResult = await (components.Component as any).renderReqToHTML(\n            req,\n            res,\n            'passthrough',\n            {\n              locale,\n              locales,\n              defaultLocale,\n              fontManifest: this.renderOpts.fontManifest,\n              domainLocales: this.renderOpts.domainLocales,\n            }\n          )\n\n          html = renderResult.html\n          pageData = renderResult.renderOpts.pageData\n          sprRevalidate = renderResult.renderOpts.revalidate\n          isNotFound = renderResult.renderOpts.isNotFound\n          isRedirect = renderResult.renderOpts.isRedirect\n        } else {\n          const origQuery = parseUrl(req.url || '', true).query\n          const hadTrailingSlash =\n            urlPathname !== '/' && this.nextConfig.trailingSlash\n\n          const resolvedUrl = formatUrl({\n            pathname: `${resolvedUrlPathname}${hadTrailingSlash ? '/' : ''}`,\n            // make sure to only add query values from original URL\n            query: origQuery,\n          })\n\n          const renderOpts: RenderOpts = {\n            ...components,\n            ...opts,\n            isDataReq,\n            resolvedUrl,\n            locale,\n            locales,\n            defaultLocale,\n            // For getServerSideProps we need to ensure we use the original URL\n            // and not the resolved URL to prevent a hydration mismatch on\n            // asPath\n            resolvedAsPath: isServerProps\n              ? formatUrl({\n                  // we use the original URL pathname less the _next/data prefix if\n                  // present\n                  pathname: `${urlPathname}${hadTrailingSlash ? '/' : ''}`,\n                  query: origQuery,\n                })\n              : resolvedUrl,\n          }\n\n          renderResult = await renderToHTML(\n            req,\n            res,\n            pathname,\n            query,\n            renderOpts\n          )\n\n          html = renderResult\n          // TODO: change this to a different passing mechanism\n          pageData = (renderOpts as any).pageData\n          sprRevalidate = (renderOpts as any).revalidate\n          isNotFound = (renderOpts as any).isNotFound\n          isRedirect = (renderOpts as any).isRedirect\n        }\n\n        return { html, pageData, sprRevalidate, isNotFound, isRedirect }\n      }\n    )\n\n    const isProduction = !this.renderOpts.dev\n    const isDynamicPathname = isDynamicRoute(pathname)\n    const didRespond = isResSent(res)\n\n    const { staticPaths, fallbackMode } = hasStaticPaths\n      ? await this.getStaticPaths(pathname)\n      : { staticPaths: undefined, fallbackMode: false }\n\n    // When we did not respond from cache, we need to choose to block on\n    // rendering or return a skeleton.\n    //\n    // * Data requests always block.\n    //\n    // * Blocking mode fallback always blocks.\n    //\n    // * Preview mode toggles all pages to be resolved in a blocking manner.\n    //\n    // * Non-dynamic pages should block (though this is an impossible\n    //   case in production).\n    //\n    // * Dynamic pages should return their skeleton if not defined in\n    //   getStaticPaths, then finish the data request on the client-side.\n    //\n    if (\n      this.minimalMode !== true &&\n      fallbackMode !== 'blocking' &&\n      ssgCacheKey &&\n      !didRespond &&\n      !isPreviewMode &&\n      isDynamicPathname &&\n      // Development should trigger fallback when the path is not in\n      // `getStaticPaths`\n      (isProduction ||\n        !staticPaths ||\n        !staticPaths.includes(\n          // we use ssgCacheKey here as it is normalized to match the\n          // encoding from getStaticPaths along with including the locale\n          query.amp ? ssgCacheKey.replace(/\\.amp$/, '') : ssgCacheKey\n        ))\n    ) {\n      if (\n        // In development, fall through to render to handle missing\n        // getStaticPaths.\n        (isProduction || staticPaths) &&\n        // When fallback isn't present, abort this render so we 404\n        fallbackMode !== 'static'\n      ) {\n        throw new NoFallbackError()\n      }\n\n      if (!isDataReq) {\n        let html: string\n\n        // Production already emitted the fallback as static HTML.\n        if (isProduction) {\n          html = await this.incrementalCache.getFallback(\n            locale ? `/${locale}${pathname}` : pathname\n          )\n        }\n        // We need to generate the fallback on-demand for development.\n        else {\n          query.__nextFallback = 'true'\n          if (isLikeServerless) {\n            prepareServerlessUrl(req, query)\n          }\n          const { value: renderResult } = await doRender()\n          html = renderResult.html\n        }\n\n        sendPayload(req, res, html, 'html', {\n          generateEtags: this.renderOpts.generateEtags,\n          poweredByHeader: this.renderOpts.poweredByHeader,\n        })\n        return null\n      }\n    }\n\n    const {\n      isOrigin,\n      value: { html, pageData, sprRevalidate, isNotFound, isRedirect },\n    } = await doRender()\n    let resHtml = html\n\n    const revalidateOptions =\n      !this.renderOpts.dev || (isServerProps && !isDataReq)\n        ? {\n            private: isPreviewMode,\n            stateful: !isSSG,\n            revalidate: sprRevalidate,\n          }\n        : undefined\n\n    if (\n      !isResSent(res) &&\n      !isNotFound &&\n      (isSSG || isDataReq || isServerProps)\n    ) {\n      if (isRedirect && !isDataReq) {\n        await handleRedirect(pageData)\n      } else {\n        sendPayload(\n          req,\n          res,\n          isDataReq ? JSON.stringify(pageData) : html,\n          isDataReq ? 'json' : 'html',\n          {\n            generateEtags: this.renderOpts.generateEtags,\n            poweredByHeader: this.renderOpts.poweredByHeader,\n          },\n          revalidateOptions\n        )\n      }\n      resHtml = null\n    }\n\n    // Update the cache if the head request and cacheable\n    if (isOrigin && ssgCacheKey) {\n      await this.incrementalCache.set(\n        ssgCacheKey,\n        { html: html!, pageData, isNotFound, isRedirect },\n        sprRevalidate\n      )\n    }\n\n    if (!isResSent(res) && isNotFound) {\n      if (revalidateOptions) {\n        setRevalidateHeaders(res, revalidateOptions)\n      }\n      if (isDataReq) {\n        res.statusCode = 404\n        res.end('{\"notFound\":true}')\n      } else {\n        await this.render404(req, res, {\n          pathname,\n          query,\n        } as UrlWithParsedQuery)\n      }\n    }\n    return resHtml\n  }\n\n  public async renderToHTML(\n    req: IncomingMessage,\n    res: ServerResponse,\n    pathname: string,\n    query: ParsedUrlQuery = {}\n  ): Promise<string | null> {\n    try {\n      const result = await this.findPageComponents(pathname, query)\n      if (result) {\n        try {\n          return await this.renderToHTMLWithComponents(\n            req,\n            res,\n            pathname,\n            result,\n            { ...this.renderOpts }\n          )\n        } catch (err) {\n          if (!(err instanceof NoFallbackError)) {\n            throw err\n          }\n        }\n      }\n\n      if (this.dynamicRoutes) {\n        for (const dynamicRoute of this.dynamicRoutes) {\n          const params = dynamicRoute.match(pathname)\n          if (!params) {\n            continue\n          }\n\n          const dynamicRouteResult = await this.findPageComponents(\n            dynamicRoute.page,\n            query,\n            params\n          )\n          if (dynamicRouteResult) {\n            try {\n              return await this.renderToHTMLWithComponents(\n                req,\n                res,\n                dynamicRoute.page,\n                dynamicRouteResult,\n                { ...this.renderOpts, params }\n              )\n            } catch (err) {\n              if (!(err instanceof NoFallbackError)) {\n                throw err\n              }\n            }\n          }\n        }\n      }\n    } catch (err) {\n      this.logError(err)\n\n      if (err && err.code === 'DECODE_FAILED') {\n        res.statusCode = 400\n        return await this.renderErrorToHTML(err, req, res, pathname, query)\n      }\n      res.statusCode = 500\n      return await this.renderErrorToHTML(err, req, res, pathname, query)\n    }\n    res.statusCode = 404\n    return await this.renderErrorToHTML(null, req, res, pathname, query)\n  }\n\n  public async renderError(\n    err: Error | null,\n    req: IncomingMessage,\n    res: ServerResponse,\n    pathname: string,\n    query: ParsedUrlQuery = {},\n    setHeaders = true\n  ): Promise<void> {\n    if (setHeaders) {\n      res.setHeader(\n        'Cache-Control',\n        'no-cache, no-store, max-age=0, must-revalidate'\n      )\n    }\n    const html = await this.renderErrorToHTML(err, req, res, pathname, query)\n    if (html === null) {\n      return\n    }\n    return this.sendHTML(req, res, html)\n  }\n\n  private customErrorNo404Warn = execOnce(() => {\n    console.warn(\n      chalk.bold.yellow(`Warning: `) +\n        chalk.yellow(\n          `You have added a custom /_error page without a custom /404 page. This prevents the 404 page from being auto statically optimized.\\nSee here for info: https://err.sh/next.js/custom-error-no-custom-404`\n        )\n    )\n  })\n\n  public async renderErrorToHTML(\n    err: Error | null,\n    req: IncomingMessage,\n    res: ServerResponse,\n    _pathname: string,\n    query: ParsedUrlQuery = {}\n  ) {\n    let result: null | FindComponentsResult = null\n\n    const is404 = res.statusCode === 404\n    let using404Page = false\n\n    // use static 404 page if available and is 404 response\n    if (is404) {\n      result = await this.findPageComponents('/404', query)\n      using404Page = result !== null\n    }\n\n    if (!result) {\n      result = await this.findPageComponents('/_error', query)\n    }\n\n    if (\n      process.env.NODE_ENV !== 'production' &&\n      !using404Page &&\n      (await this.hasPage('/_error')) &&\n      !(await this.hasPage('/404'))\n    ) {\n      this.customErrorNo404Warn()\n    }\n\n    let html: string | null\n    try {\n      try {\n        html = await this.renderToHTMLWithComponents(\n          req,\n          res,\n          using404Page ? '/404' : '/_error',\n          result!,\n          {\n            ...this.renderOpts,\n            err,\n          }\n        )\n      } catch (maybeFallbackError) {\n        if (maybeFallbackError instanceof NoFallbackError) {\n          throw new Error('invariant: failed to render error page')\n        }\n        throw maybeFallbackError\n      }\n    } catch (renderToHtmlError) {\n      console.error(renderToHtmlError)\n      res.statusCode = 500\n      html = 'Internal Server Error'\n    }\n    return html\n  }\n\n  public async render404(\n    req: IncomingMessage,\n    res: ServerResponse,\n    parsedUrl?: UrlWithParsedQuery,\n    setHeaders = true\n  ): Promise<void> {\n    const url: any = req.url\n    const { pathname, query } = parsedUrl ? parsedUrl : parseUrl(url, true)\n    const { i18n } = this.nextConfig\n\n    if (i18n) {\n      query.__nextLocale = query.__nextLocale || i18n.defaultLocale\n      query.__nextDefaultLocale =\n        query.__nextDefaultLocale || i18n.defaultLocale\n    }\n    res.statusCode = 404\n    return this.renderError(null, req, res, pathname!, query, setHeaders)\n  }\n\n  public async serveStatic(\n    req: IncomingMessage,\n    res: ServerResponse,\n    path: string,\n    parsedUrl?: UrlWithParsedQuery\n  ): Promise<void> {\n    if (!this.isServeableUrl(path)) {\n      return this.render404(req, res, parsedUrl)\n    }\n\n    if (!(req.method === 'GET' || req.method === 'HEAD')) {\n      res.statusCode = 405\n      res.setHeader('Allow', ['GET', 'HEAD'])\n      return this.renderError(null, req, res, path)\n    }\n\n    try {\n      await serveStatic(req, res, path)\n    } catch (err) {\n      if (err.code === 'ENOENT' || err.statusCode === 404) {\n        this.render404(req, res, parsedUrl)\n      } else if (err.statusCode === 412) {\n        res.statusCode = 412\n        return this.renderError(err, req, res, path)\n      } else {\n        throw err\n      }\n    }\n  }\n\n  private _validFilesystemPathSet: Set<string> | null = null\n  private getFilesystemPaths(): Set<string> {\n    if (this._validFilesystemPathSet) {\n      return this._validFilesystemPathSet\n    }\n\n    const pathUserFilesStatic = join(this.dir, 'static')\n    let userFilesStatic: string[] = []\n    if (this.hasStaticDir && fs.existsSync(pathUserFilesStatic)) {\n      userFilesStatic = recursiveReadDirSync(pathUserFilesStatic).map((f) =>\n        join('.', 'static', f)\n      )\n    }\n\n    let userFilesPublic: string[] = []\n    if (this.publicDir && fs.existsSync(this.publicDir)) {\n      userFilesPublic = recursiveReadDirSync(this.publicDir).map((f) =>\n        join('.', 'public', f)\n      )\n    }\n\n    let nextFilesStatic: string[] = []\n    nextFilesStatic = recursiveReadDirSync(\n      join(this.distDir, 'static')\n    ).map((f) => join('.', relative(this.dir, this.distDir), 'static', f))\n\n    return (this._validFilesystemPathSet = new Set<string>([\n      ...nextFilesStatic,\n      ...userFilesPublic,\n      ...userFilesStatic,\n    ]))\n  }\n\n  protected isServeableUrl(untrustedFileUrl: string): boolean {\n    // This method mimics what the version of `send` we use does:\n    // 1. decodeURIComponent:\n    //    https://github.com/pillarjs/send/blob/0.17.1/index.js#L989\n    //    https://github.com/pillarjs/send/blob/0.17.1/index.js#L518-L522\n    // 2. resolve:\n    //    https://github.com/pillarjs/send/blob/de073ed3237ade9ff71c61673a34474b30e5d45b/index.js#L561\n\n    let decodedUntrustedFilePath: string\n    try {\n      // (1) Decode the URL so we have the proper file name\n      decodedUntrustedFilePath = decodeURIComponent(untrustedFileUrl)\n    } catch {\n      return false\n    }\n\n    // (2) Resolve \"up paths\" to determine real request\n    const untrustedFilePath = resolve(decodedUntrustedFilePath)\n\n    // don't allow null bytes anywhere in the file path\n    if (untrustedFilePath.indexOf('\\0') !== -1) {\n      return false\n    }\n\n    // Check if .next/static, static and public are in the path.\n    // If not the path is not available.\n    if (\n      (untrustedFilePath.startsWith(join(this.distDir, 'static') + sep) ||\n        untrustedFilePath.startsWith(join(this.dir, 'static') + sep) ||\n        untrustedFilePath.startsWith(join(this.dir, 'public') + sep)) === false\n    ) {\n      return false\n    }\n\n    // Check against the real filesystem paths\n    const filesystemUrls = this.getFilesystemPaths()\n    const resolved = relative(this.dir, untrustedFilePath)\n    return filesystemUrls.has(resolved)\n  }\n\n  protected readBuildId(): string {\n    const buildIdFile = join(this.distDir, BUILD_ID_FILE)\n    try {\n      return fs.readFileSync(buildIdFile, 'utf8').trim()\n    } catch (err) {\n      if (!fs.existsSync(buildIdFile)) {\n        throw new Error(\n          `Could not find a production build in the '${this.distDir}' directory. Try building your app with 'next build' before starting the production server. https://err.sh/vercel/next.js/production-start-no-build-id`\n        )\n      }\n\n      throw err\n    }\n  }\n\n  protected get _isLikeServerless(): boolean {\n    return isTargetLikeServerless(this.nextConfig.target)\n  }\n}\n\nfunction prepareServerlessUrl(\n  req: IncomingMessage,\n  query: ParsedUrlQuery\n): void {\n  const curUrl = parseUrl(req.url!, true)\n  req.url = formatUrl({\n    ...curUrl,\n    search: undefined,\n    query: {\n      ...curUrl.query,\n      ...query,\n    },\n  })\n}\n\nclass NoFallbackError extends Error {}\n"]}