{"version":3,"sources":["../../server/api-utils.ts"],"names":["apiResolver","req","res","query","resolverModule","apiContext","propagateError","apiReq","apiRes","statusCode","end","config","bodyParser","api","externalResolver","setLazyProp","getCookieParser","tryGetPreviewData","previewData","undefined","body","parseBody","sizeLimit","contentLength","writeData","write","endResponse","args","Buffer","byteLength","apply","length","console","warn","url","status","sendStatusCode","send","data","sendData","json","sendJson","redirect","statusOrUrl","setPreviewData","options","Object","assign","clearPreviewData","resolver","wasPiped","process","env","NODE_ENV","once","err","ApiError","sendError","message","error","limit","contentType","headers","type","parameters","encoding","charset","buffer","e","toString","parseJson","qs","require","decode","str","JSON","parse","parseCookie","header","cookie","parseCookieFn","Array","isArray","join","Error","writeHead","Location","getHeader","Stream","setHeader","pipe","isJSONLike","includes","stringifiedBody","stringify","etag","isBuffer","jsonBody","COOKIE_NAME_PRERENDER_BYPASS","COOKIE_NAME_PRERENDER_DATA","SYMBOL_PREVIEW_DATA","Symbol","SYMBOL_CLEARED_COOKIES","getCookies","cookies","hasBypass","hasData","previewModeId","tokenPreviewData","jsonwebtoken","encryptedPreviewData","verify","previewModeSigningKey","decryptedPreviewData","from","previewModeEncryptionKey","defineProperty","value","enumerable","isNotValidData","payload","sign","algorithm","maxAge","expiresIn","serialize","previous","httpOnly","sameSite","secure","path","expires","Date","constructor","statusMessage","prop","getter","opts","configurable","optsReset","writable","get","set"],"mappings":"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","sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\nimport { parse } from 'next/dist/compiled/content-type'\nimport { CookieSerializeOptions } from 'next/dist/compiled/cookie'\nimport getRawBody from 'raw-body'\nimport { PageConfig, PreviewData } from 'next/types'\nimport { Stream } from 'stream'\nimport { isResSent, NextApiRequest, NextApiResponse } from '../shared/lib/utils'\nimport { decryptWithSecret, encryptWithSecret } from './crypto-utils'\nimport { interopDefault } from './load-components'\nimport { sendEtagResponse } from './send-payload'\nimport generateETag from 'etag'\n\nexport type NextApiRequestCookies = { [key: string]: string }\nexport type NextApiRequestQuery = { [key: string]: string | string[] }\n\nexport type __ApiPreviewProps = {\n  previewModeId: string\n  previewModeEncryptionKey: string\n  previewModeSigningKey: string\n}\n\nexport async function apiResolver(\n  req: IncomingMessage,\n  res: ServerResponse,\n  query: any,\n  resolverModule: any,\n  apiContext: __ApiPreviewProps,\n  propagateError: boolean\n): Promise<void> {\n  const apiReq = req as NextApiRequest\n  const apiRes = res as NextApiResponse\n\n  try {\n    if (!resolverModule) {\n      res.statusCode = 404\n      res.end('Not Found')\n      return\n    }\n    const config: PageConfig = resolverModule.config || {}\n    const bodyParser = config.api?.bodyParser !== false\n    const externalResolver = config.api?.externalResolver || false\n\n    // Parsing of cookies\n    setLazyProp({ req: apiReq }, 'cookies', getCookieParser(req))\n    // Parsing query string\n    apiReq.query = query\n    // Parsing preview data\n    setLazyProp({ req: apiReq }, 'previewData', () =>\n      tryGetPreviewData(req, res, apiContext)\n    )\n    // Checking if preview mode is enabled\n    setLazyProp({ req: apiReq }, 'preview', () =>\n      apiReq.previewData !== false ? true : undefined\n    )\n\n    // Parsing of body\n    if (bodyParser && !apiReq.body) {\n      apiReq.body = await parseBody(\n        apiReq,\n        config.api && config.api.bodyParser && config.api.bodyParser.sizeLimit\n          ? config.api.bodyParser.sizeLimit\n          : '1mb'\n      )\n    }\n\n    let contentLength = 0\n    const writeData = apiRes.write\n    const endResponse = apiRes.end\n    apiRes.write = (...args: any[2]) => {\n      contentLength += Buffer.byteLength(args[0])\n      return writeData.apply(apiRes, args)\n    }\n    apiRes.end = (...args: any[2]) => {\n      if (args.length && typeof args[0] !== 'function') {\n        contentLength += Buffer.byteLength(args[0])\n      }\n\n      if (contentLength >= 4 * 1024 * 1024) {\n        console.warn(\n          `API response for ${req.url} exceeds 4MB. This will cause the request to fail in a future version. https://nextjs.org/docs/messages/api-routes-body-size-limit`\n        )\n      }\n\n      endResponse.apply(apiRes, args)\n    }\n    apiRes.status = (statusCode) => sendStatusCode(apiRes, statusCode)\n    apiRes.send = (data) => sendData(apiReq, apiRes, data)\n    apiRes.json = (data) => sendJson(apiRes, data)\n    apiRes.redirect = (statusOrUrl: number | string, url?: string) =>\n      redirect(apiRes, statusOrUrl, url)\n    apiRes.setPreviewData = (data, options = {}) =>\n      setPreviewData(apiRes, data, Object.assign({}, apiContext, options))\n    apiRes.clearPreviewData = () => clearPreviewData(apiRes)\n\n    const resolver = interopDefault(resolverModule)\n    let wasPiped = false\n\n    if (process.env.NODE_ENV !== 'production') {\n      // listen for pipe event and don't show resolve warning\n      res.once('pipe', () => (wasPiped = true))\n    }\n\n    // Call API route method\n    await resolver(req, res)\n\n    if (\n      process.env.NODE_ENV !== 'production' &&\n      !externalResolver &&\n      !isResSent(res) &&\n      !wasPiped\n    ) {\n      console.warn(\n        `API resolved without sending a response for ${req.url}, this may result in stalled requests.`\n      )\n    }\n  } catch (err) {\n    if (err instanceof ApiError) {\n      sendError(apiRes, err.statusCode, err.message)\n    } else {\n      console.error(err)\n      if (propagateError) {\n        throw err\n      }\n      sendError(apiRes, 500, 'Internal Server Error')\n    }\n  }\n}\n\n/**\n * Parse incoming message like `json` or `urlencoded`\n * @param req request object\n */\nexport async function parseBody(\n  req: NextApiRequest,\n  limit: string | number\n): Promise<any> {\n  let contentType\n  try {\n    contentType = parse(req.headers['content-type'] || 'text/plain')\n  } catch {\n    contentType = parse('text/plain')\n  }\n  const { type, parameters } = contentType\n  const encoding = parameters.charset || 'utf-8'\n\n  let buffer\n\n  try {\n    buffer = await getRawBody(req, { encoding, limit })\n  } catch (e) {\n    if (e.type === 'entity.too.large') {\n      throw new ApiError(413, `Body exceeded ${limit} limit`)\n    } else {\n      throw new ApiError(400, 'Invalid body')\n    }\n  }\n\n  const body = buffer.toString()\n\n  if (type === 'application/json' || type === 'application/ld+json') {\n    return parseJson(body)\n  } else if (type === 'application/x-www-form-urlencoded') {\n    const qs = require('querystring')\n    return qs.decode(body)\n  } else {\n    return body\n  }\n}\n\n/**\n * Parse `JSON` and handles invalid `JSON` strings\n * @param str `JSON` string\n */\nfunction parseJson(str: string): object {\n  if (str.length === 0) {\n    // special-case empty json body, as it's a common client-side mistake\n    return {}\n  }\n\n  try {\n    return JSON.parse(str)\n  } catch (e) {\n    throw new ApiError(400, 'Invalid JSON')\n  }\n}\n\n/**\n * Parse cookies from `req` header\n * @param req request object\n */\nexport function getCookieParser(\n  req: IncomingMessage\n): () => NextApiRequestCookies {\n  return function parseCookie(): NextApiRequestCookies {\n    const header: undefined | string | string[] = req.headers.cookie\n\n    if (!header) {\n      return {}\n    }\n\n    const { parse: parseCookieFn } = require('next/dist/compiled/cookie')\n    return parseCookieFn(Array.isArray(header) ? header.join(';') : header)\n  }\n}\n\n/**\n *\n * @param res response object\n * @param statusCode `HTTP` status code of response\n */\nexport function sendStatusCode(\n  res: NextApiResponse,\n  statusCode: number\n): NextApiResponse<any> {\n  res.statusCode = statusCode\n  return res\n}\n\n/**\n *\n * @param res response object\n * @param [statusOrUrl] `HTTP` status code of redirect\n * @param url URL of redirect\n */\nexport function redirect(\n  res: NextApiResponse,\n  statusOrUrl: string | number,\n  url?: string\n): NextApiResponse<any> {\n  if (typeof statusOrUrl === 'string') {\n    url = statusOrUrl\n    statusOrUrl = 307\n  }\n  if (typeof statusOrUrl !== 'number' || typeof url !== 'string') {\n    throw new Error(\n      `Invalid redirect arguments. Please use a single argument URL, e.g. res.redirect('/destination') or use a status code and URL, e.g. res.redirect(307, '/destination').`\n    )\n  }\n  res.writeHead(statusOrUrl, { Location: url })\n  res.write(url)\n  res.end()\n  return res\n}\n\n/**\n * Send `any` body to response\n * @param req request object\n * @param res response object\n * @param body of response\n */\nexport function sendData(\n  req: NextApiRequest,\n  res: NextApiResponse,\n  body: any\n): void {\n  if (body === null || body === undefined) {\n    res.end()\n    return\n  }\n\n  const contentType = res.getHeader('Content-Type')\n\n  if (body instanceof Stream) {\n    if (!contentType) {\n      res.setHeader('Content-Type', 'application/octet-stream')\n    }\n    body.pipe(res)\n    return\n  }\n\n  const isJSONLike = ['object', 'number', 'boolean'].includes(typeof body)\n  const stringifiedBody = isJSONLike ? JSON.stringify(body) : body\n  const etag = generateETag(stringifiedBody)\n  if (sendEtagResponse(req, res, etag)) {\n    return\n  }\n\n  if (Buffer.isBuffer(body)) {\n    if (!contentType) {\n      res.setHeader('Content-Type', 'application/octet-stream')\n    }\n    res.setHeader('Content-Length', body.length)\n    res.end(body)\n    return\n  }\n\n  if (isJSONLike) {\n    res.setHeader('Content-Type', 'application/json; charset=utf-8')\n  }\n\n  res.setHeader('Content-Length', Buffer.byteLength(stringifiedBody))\n  res.end(stringifiedBody)\n}\n\n/**\n * Send `JSON` object\n * @param res response object\n * @param jsonBody of data\n */\nexport function sendJson(res: NextApiResponse, jsonBody: any): void {\n  // Set header to application/json\n  res.setHeader('Content-Type', 'application/json; charset=utf-8')\n\n  // Use send to handle request\n  res.send(jsonBody)\n}\n\nconst COOKIE_NAME_PRERENDER_BYPASS = `__prerender_bypass`\nconst COOKIE_NAME_PRERENDER_DATA = `__next_preview_data`\n\nexport const SYMBOL_PREVIEW_DATA = Symbol(COOKIE_NAME_PRERENDER_DATA)\nconst SYMBOL_CLEARED_COOKIES = Symbol(COOKIE_NAME_PRERENDER_BYPASS)\n\nexport function tryGetPreviewData(\n  req: IncomingMessage,\n  res: ServerResponse,\n  options: __ApiPreviewProps\n): PreviewData {\n  // Read cached preview data if present\n  if (SYMBOL_PREVIEW_DATA in req) {\n    return (req as any)[SYMBOL_PREVIEW_DATA] as any\n  }\n\n  const getCookies = getCookieParser(req)\n  let cookies: NextApiRequestCookies\n  try {\n    cookies = getCookies()\n  } catch {\n    // TODO: warn\n    return false\n  }\n\n  const hasBypass = COOKIE_NAME_PRERENDER_BYPASS in cookies\n  const hasData = COOKIE_NAME_PRERENDER_DATA in cookies\n\n  // Case: neither cookie is set.\n  if (!(hasBypass || hasData)) {\n    return false\n  }\n\n  // Case: one cookie is set, but not the other.\n  if (hasBypass !== hasData) {\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  // Case: preview session is for an old build.\n  if (cookies[COOKIE_NAME_PRERENDER_BYPASS] !== options.previewModeId) {\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  const tokenPreviewData = cookies[COOKIE_NAME_PRERENDER_DATA]\n\n  const jsonwebtoken = require('next/dist/compiled/jsonwebtoken') as typeof import('jsonwebtoken')\n  let encryptedPreviewData: {\n    data: string\n  }\n  try {\n    encryptedPreviewData = jsonwebtoken.verify(\n      tokenPreviewData,\n      options.previewModeSigningKey\n    ) as typeof encryptedPreviewData\n  } catch {\n    // TODO: warn\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  const decryptedPreviewData = decryptWithSecret(\n    Buffer.from(options.previewModeEncryptionKey),\n    encryptedPreviewData.data\n  )\n\n  try {\n    // TODO: strict runtime type checking\n    const data = JSON.parse(decryptedPreviewData)\n    // Cache lookup\n    Object.defineProperty(req, SYMBOL_PREVIEW_DATA, {\n      value: data,\n      enumerable: false,\n    })\n    return data\n  } catch {\n    return false\n  }\n}\n\nfunction isNotValidData(str: string): boolean {\n  return typeof str !== 'string' || str.length < 16\n}\n\nfunction setPreviewData<T>(\n  res: NextApiResponse<T>,\n  data: object | string, // TODO: strict runtime type checking\n  options: {\n    maxAge?: number\n  } & __ApiPreviewProps\n): NextApiResponse<T> {\n  if (isNotValidData(options.previewModeId)) {\n    throw new Error('invariant: invalid previewModeId')\n  }\n  if (isNotValidData(options.previewModeEncryptionKey)) {\n    throw new Error('invariant: invalid previewModeEncryptionKey')\n  }\n  if (isNotValidData(options.previewModeSigningKey)) {\n    throw new Error('invariant: invalid previewModeSigningKey')\n  }\n\n  const jsonwebtoken = require('next/dist/compiled/jsonwebtoken') as typeof import('jsonwebtoken')\n\n  const payload = jsonwebtoken.sign(\n    {\n      data: encryptWithSecret(\n        Buffer.from(options.previewModeEncryptionKey),\n        JSON.stringify(data)\n      ),\n    },\n    options.previewModeSigningKey,\n    {\n      algorithm: 'HS256',\n      ...(options.maxAge !== undefined\n        ? { expiresIn: options.maxAge }\n        : undefined),\n    }\n  )\n\n  // limit preview mode cookie to 2KB since we shouldn't store too much\n  // data here and browsers drop cookies over 4KB\n  if (payload.length > 2048) {\n    throw new Error(\n      `Preview data is limited to 2KB currently, reduce how much data you are storing as preview data to continue`\n    )\n  }\n\n  const {\n    serialize,\n  } = require('next/dist/compiled/cookie') as typeof import('cookie')\n  const previous = res.getHeader('Set-Cookie')\n  res.setHeader(`Set-Cookie`, [\n    ...(typeof previous === 'string'\n      ? [previous]\n      : Array.isArray(previous)\n      ? previous\n      : []),\n    serialize(COOKIE_NAME_PRERENDER_BYPASS, options.previewModeId, {\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n      ...(options.maxAge !== undefined\n        ? ({ maxAge: options.maxAge } as CookieSerializeOptions)\n        : undefined),\n    }),\n    serialize(COOKIE_NAME_PRERENDER_DATA, payload, {\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n      ...(options.maxAge !== undefined\n        ? ({ maxAge: options.maxAge } as CookieSerializeOptions)\n        : undefined),\n    }),\n  ])\n  return res\n}\n\nfunction clearPreviewData<T>(res: NextApiResponse<T>): NextApiResponse<T> {\n  if (SYMBOL_CLEARED_COOKIES in res) {\n    return res\n  }\n\n  const {\n    serialize,\n  } = require('next/dist/compiled/cookie') as typeof import('cookie')\n  const previous = res.getHeader('Set-Cookie')\n  res.setHeader(`Set-Cookie`, [\n    ...(typeof previous === 'string'\n      ? [previous]\n      : Array.isArray(previous)\n      ? previous\n      : []),\n    serialize(COOKIE_NAME_PRERENDER_BYPASS, '', {\n      // To delete a cookie, set `expires` to a date in the past:\n      // https://tools.ietf.org/html/rfc6265#section-4.1.1\n      // `Max-Age: 0` is not valid, thus ignored, and the cookie is persisted.\n      expires: new Date(0),\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n    }),\n    serialize(COOKIE_NAME_PRERENDER_DATA, '', {\n      // To delete a cookie, set `expires` to a date in the past:\n      // https://tools.ietf.org/html/rfc6265#section-4.1.1\n      // `Max-Age: 0` is not valid, thus ignored, and the cookie is persisted.\n      expires: new Date(0),\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n    }),\n  ])\n\n  Object.defineProperty(res, SYMBOL_CLEARED_COOKIES, {\n    value: true,\n    enumerable: false,\n  })\n  return res\n}\n\n/**\n * Custom error class\n */\nexport class ApiError extends Error {\n  readonly statusCode: number\n\n  constructor(statusCode: number, message: string) {\n    super(message)\n    this.statusCode = statusCode\n  }\n}\n\n/**\n * Sends error in `response`\n * @param res response object\n * @param statusCode of response\n * @param message of response\n */\nexport function sendError(\n  res: NextApiResponse,\n  statusCode: number,\n  message: string\n): void {\n  res.statusCode = statusCode\n  res.statusMessage = message\n  res.end(message)\n}\n\ninterface LazyProps {\n  req: NextApiRequest\n}\n\n/**\n * Execute getter function only if its needed\n * @param LazyProps `req` and `params` for lazyProp\n * @param prop name of property\n * @param getter function to get data\n */\nexport function setLazyProp<T>(\n  { req }: LazyProps,\n  prop: string,\n  getter: () => T\n): void {\n  const opts = { configurable: true, enumerable: true }\n  const optsReset = { ...opts, writable: true }\n\n  Object.defineProperty(req, prop, {\n    ...opts,\n    get: () => {\n      const value = getter()\n      // we set the property on the object to avoid recalculating it\n      Object.defineProperty(req, prop, { ...optsReset, value })\n      return value\n    },\n    set: (value) => {\n      Object.defineProperty(req, prop, { ...optsReset, value })\n    },\n  })\n}\n"]}