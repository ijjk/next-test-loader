{"version":3,"sources":["../../server/hot-reloader.ts"],"names":["renderScriptError","res","error","setHeader","code","message","statusCode","end","console","stack","addCorsSupport","req","isApiRoute","url","match","API_ROUTE","preflight","headers","origin","method","writeHead","matchNextPageBundleRequest","findEntryModule","issuer","erroredPages","compilation","options","enhanceName","name","failedPages","errors","entryModule","IS_BUNDLED_PAGE_REGEX","test","enhancedName","push","HotReloader","constructor","dir","config","pagesDir","buildId","previewProps","middlewares","webpackDevMiddleware","webpackHotMiddleware","initialized","stats","serverStats","serverPrevDocumentHash","prevChunkNames","onDemandEntries","run","parsedUrl","handlePageBundleRequest","pageBundleRes","parsedPageBundleUrl","pathname","params","page","path","join","BLOCKED_PAGES","indexOf","ensurePage","finished","bundlePath","distDir","mod","require","amp","_","getCompilationErrors","length","fn","Promise","resolve","reject","err","clean","getWebpackConfig","pagePaths","all","pageExtensions","pages","filter","i","entrypoints","additionalClientEntrypoints","CLIENT_STATIC_FILES_RUNTIME_AMP","sep","NEXT_PROJECT_ROOT_DIST_CLIENT","CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH","dev","isServer","client","server","start","configs","multiCompiler","buildTools","prepareBuildTools","assignBuildTools","waitUntilValid","stop","middleware","close","rootDirectory","compilers","hooks","done","tap","documentChunk","chunks","find","c","warn","hash","send","chunkNames","Set","map","addedPages","diff","removedPages","size","addedPage","removedPage","ignored","webpackDevMiddlewareConfig","publicPath","noInfo","logLevel","watchOptions","writeToDisk","log","configOrigin","heartbeat","normalizedPage","hasErrors","action","args","publish","data","a","b","v","has"],"mappings":"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","sourcesContent":["import { getOverlayMiddleware } from '@next/react-dev-overlay/lib/middleware'\nimport { NextHandleFunction } from 'connect'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport WebpackDevMiddleware from 'next/dist/compiled/webpack-dev-middleware'\nimport WebpackHotMiddleware from 'next/dist/compiled/webpack-hot-middleware'\nimport { join, normalize, relative as relativePath, sep } from 'path'\nimport { UrlObject } from 'url'\nimport webpack from 'webpack'\nimport { createEntrypoints, createPagesMapping } from '../build/entries'\nimport { watchCompilers } from '../build/output'\nimport getBaseWebpackConfig from '../build/webpack-config'\nimport { API_ROUTE, NEXT_PROJECT_ROOT_DIST_CLIENT } from '../lib/constants'\nimport { recursiveDelete } from '../lib/recursive-delete'\nimport {\n  BLOCKED_PAGES,\n  CLIENT_STATIC_FILES_RUNTIME_AMP,\n  CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH,\n  IS_BUNDLED_PAGE_REGEX,\n} from '../next-server/lib/constants'\nimport { __ApiPreviewProps } from '../next-server/server/api-utils'\nimport { route } from '../next-server/server/router'\nimport errorOverlayMiddleware from './lib/error-overlay-middleware'\nimport { findPageFile } from './lib/find-page-file'\nimport onDemandEntryHandler from './on-demand-entry-handler'\nimport {\n  denormalizePagePath,\n  normalizePathSep,\n} from '../next-server/server/normalize-page-path'\nimport getRouteFromEntrypoint from '../next-server/server/get-route-from-entrypoint'\n\nexport async function renderScriptError(res: ServerResponse, error: Error) {\n  // Asks CDNs and others to not to cache the errored page\n  res.setHeader(\n    'Cache-Control',\n    'no-cache, no-store, max-age=0, must-revalidate'\n  )\n\n  if (\n    (error as any).code === 'ENOENT' ||\n    error.message === 'INVALID_BUILD_ID'\n  ) {\n    res.statusCode = 404\n    res.end('404 - Not Found')\n    return\n  }\n\n  console.error(error.stack)\n  res.statusCode = 500\n  res.end('500 - Internal Error')\n}\n\nfunction addCorsSupport(req: IncomingMessage, res: ServerResponse) {\n  const isApiRoute = req.url!.match(API_ROUTE)\n  // API routes handle their own CORS headers\n  if (isApiRoute) {\n    return { preflight: false }\n  }\n\n  if (!req.headers.origin) {\n    return { preflight: false }\n  }\n\n  res.setHeader('Access-Control-Allow-Origin', req.headers.origin)\n  res.setHeader('Access-Control-Allow-Methods', 'OPTIONS, GET')\n  // Based on https://github.com/primus/access-control/blob/4cf1bc0e54b086c91e6aa44fb14966fa5ef7549c/index.js#L158\n  if (req.headers['access-control-request-headers']) {\n    res.setHeader(\n      'Access-Control-Allow-Headers',\n      req.headers['access-control-request-headers'] as string\n    )\n  }\n\n  if (req.method === 'OPTIONS') {\n    res.writeHead(200)\n    res.end()\n    return { preflight: true }\n  }\n\n  return { preflight: false }\n}\n\nconst matchNextPageBundleRequest = route(\n  '/_next/static/:buildId/pages/:path*.js(\\\\.map|)'\n)\n\n// Recursively look up the issuer till it ends up at the root\nfunction findEntryModule(issuer: any): any {\n  if (issuer.issuer) {\n    return findEntryModule(issuer.issuer)\n  }\n\n  return issuer\n}\n\nfunction erroredPages(\n  compilation: webpack.compilation.Compilation,\n  options = { enhanceName: (name: string) => name }\n) {\n  const failedPages: { [page: string]: any[] } = {}\n  for (const error of compilation.errors) {\n    if (!error.origin) {\n      continue\n    }\n\n    const entryModule = findEntryModule(error.origin)\n    const { name } = entryModule\n    if (!name) {\n      continue\n    }\n\n    // Only pages have to be reloaded\n    if (!IS_BUNDLED_PAGE_REGEX.test(name)) {\n      continue\n    }\n\n    const enhancedName = options.enhanceName(name)\n\n    if (!failedPages[enhancedName]) {\n      failedPages[enhancedName] = []\n    }\n\n    failedPages[enhancedName].push(error)\n  }\n\n  return failedPages\n}\n\nexport default class HotReloader {\n  private dir: string\n  private buildId: string\n  private middlewares: any[]\n  private pagesDir: string\n  private webpackDevMiddleware: WebpackDevMiddleware.WebpackDevMiddleware | null\n  private webpackHotMiddleware:\n    | (NextHandleFunction & WebpackHotMiddleware.EventStream)\n    | null\n  private initialized: boolean\n  private config: any\n  private stats: any\n  private serverStats: any\n  private serverPrevDocumentHash: string | null\n  private prevChunkNames?: Set<any>\n  private onDemandEntries: any\n  private previewProps: __ApiPreviewProps\n\n  constructor(\n    dir: string,\n    {\n      config,\n      pagesDir,\n      buildId,\n      previewProps,\n    }: {\n      config: object\n      pagesDir: string\n      buildId: string\n      previewProps: __ApiPreviewProps\n    }\n  ) {\n    this.buildId = buildId\n    this.dir = dir\n    this.middlewares = []\n    this.pagesDir = pagesDir\n    this.webpackDevMiddleware = null\n    this.webpackHotMiddleware = null\n    this.initialized = false\n    this.stats = null\n    this.serverStats = null\n    this.serverPrevDocumentHash = null\n\n    this.config = config\n    this.previewProps = previewProps\n  }\n\n  public async run(\n    req: IncomingMessage,\n    res: ServerResponse,\n    parsedUrl: UrlObject\n  ) {\n    // Usually CORS support is not needed for the hot-reloader (this is dev only feature)\n    // With when the app runs for multi-zones support behind a proxy,\n    // the current page is trying to access this URL via assetPrefix.\n    // That's when the CORS support is needed.\n    const { preflight } = addCorsSupport(req, res)\n    if (preflight) {\n      return\n    }\n\n    // When a request comes in that is a page bundle, e.g. /_next/static/<buildid>/pages/index.js\n    // we have to compile the page using on-demand-entries, this middleware will handle doing that\n    // by adding the page to on-demand-entries, waiting till it's done\n    // and then the bundle will be served like usual by the actual route in server/index.js\n    const handlePageBundleRequest = async (\n      pageBundleRes: ServerResponse,\n      parsedPageBundleUrl: UrlObject\n    ): Promise<{ finished?: true }> => {\n      const { pathname } = parsedPageBundleUrl\n      const params = matchNextPageBundleRequest(pathname)\n      if (!params) {\n        return {}\n      }\n\n      if (params.buildId !== this.buildId) {\n        return {}\n      }\n\n      const page = denormalizePagePath(`/${params.path.join('/')}`)\n      if (page === '/_error' || BLOCKED_PAGES.indexOf(page) === -1) {\n        try {\n          await this.ensurePage(page)\n        } catch (error) {\n          await renderScriptError(pageBundleRes, error)\n          return { finished: true }\n        }\n\n        const bundlePath = join(\n          this.dir,\n          this.config.distDir,\n          'server/static/development/pages',\n          page + '.js'\n        )\n\n        // Make sure to 404 for AMP first pages\n        try {\n          const mod = require(bundlePath)\n          if (mod?.config?.amp === true) {\n            pageBundleRes.statusCode = 404\n            pageBundleRes.end()\n            return { finished: true }\n          }\n        } catch (_) {}\n\n        const errors = await this.getCompilationErrors(page)\n        if (errors.length > 0) {\n          await renderScriptError(pageBundleRes, errors[0])\n          return { finished: true }\n        }\n      }\n\n      return {}\n    }\n\n    const { finished } = await handlePageBundleRequest(res, parsedUrl)\n\n    for (const fn of this.middlewares) {\n      await new Promise((resolve, reject) => {\n        fn(req, res, (err: Error) => {\n          if (err) return reject(err)\n          resolve()\n        })\n      })\n    }\n\n    return { finished }\n  }\n\n  private async clean(): Promise<void> {\n    return recursiveDelete(join(this.dir, this.config.distDir), /^cache/)\n  }\n\n  private async getWebpackConfig() {\n    const pagePaths = await Promise.all([\n      findPageFile(this.pagesDir, '/_app', this.config.pageExtensions),\n      findPageFile(this.pagesDir, '/_document', this.config.pageExtensions),\n    ])\n\n    const pages = createPagesMapping(\n      pagePaths.filter((i) => i !== null) as string[],\n      this.config.pageExtensions\n    )\n    const entrypoints = createEntrypoints(\n      pages,\n      'server',\n      this.buildId,\n      this.previewProps,\n      this.config,\n      []\n    )\n\n    let additionalClientEntrypoints: { [file: string]: string } = {}\n    additionalClientEntrypoints[CLIENT_STATIC_FILES_RUNTIME_AMP] =\n      `.${sep}` +\n      relativePath(\n        this.dir,\n        join(NEXT_PROJECT_ROOT_DIST_CLIENT, 'dev', 'amp-dev')\n      )\n\n    additionalClientEntrypoints[\n      CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH\n    ] = require.resolve(`@next/react-refresh-utils/runtime`)\n\n    return Promise.all([\n      getBaseWebpackConfig(this.dir, {\n        dev: true,\n        isServer: false,\n        config: this.config,\n        buildId: this.buildId,\n        pagesDir: this.pagesDir,\n        entrypoints: { ...entrypoints.client, ...additionalClientEntrypoints },\n      }),\n      getBaseWebpackConfig(this.dir, {\n        dev: true,\n        isServer: true,\n        config: this.config,\n        buildId: this.buildId,\n        pagesDir: this.pagesDir,\n        entrypoints: entrypoints.server,\n      }),\n    ])\n  }\n\n  public async start(): Promise<void> {\n    await this.clean()\n\n    const configs = await this.getWebpackConfig()\n\n    const multiCompiler = webpack(configs)\n\n    const buildTools = await this.prepareBuildTools(multiCompiler)\n    this.assignBuildTools(buildTools)\n\n    // [Client, Server]\n    ;[\n      this.stats,\n      this.serverStats,\n    ] = ((await this.waitUntilValid()) as any).stats\n  }\n\n  public async stop(\n    webpackDevMiddleware?: WebpackDevMiddleware.WebpackDevMiddleware\n  ): Promise<void> {\n    const middleware = webpackDevMiddleware || this.webpackDevMiddleware\n    if (middleware) {\n      return new Promise((resolve, reject) => {\n        ;(middleware.close as any)((err: any) => {\n          if (err) return reject(err)\n          resolve()\n        })\n      })\n    }\n  }\n\n  private assignBuildTools({\n    webpackDevMiddleware,\n    webpackHotMiddleware,\n    onDemandEntries,\n  }: {\n    webpackDevMiddleware: WebpackDevMiddleware.WebpackDevMiddleware\n    webpackHotMiddleware: NextHandleFunction & WebpackHotMiddleware.EventStream\n    onDemandEntries: any\n  }): void {\n    this.webpackDevMiddleware = webpackDevMiddleware\n    this.webpackHotMiddleware = webpackHotMiddleware\n    this.onDemandEntries = onDemandEntries\n    this.middlewares = [\n      webpackDevMiddleware,\n      // must come before hotMiddleware\n      onDemandEntries.middleware(),\n      webpackHotMiddleware,\n      errorOverlayMiddleware({ dir: this.dir }),\n      getOverlayMiddleware({\n        rootDirectory: this.dir,\n        stats: () => this.stats,\n        serverStats: () => this.serverStats,\n      }),\n    ]\n  }\n\n  private async prepareBuildTools(multiCompiler: webpack.MultiCompiler) {\n    watchCompilers(multiCompiler.compilers[0], multiCompiler.compilers[1])\n\n    // This plugin watches for changes to _document.js and notifies the client side that it should reload the page\n    multiCompiler.compilers[1].hooks.done.tap(\n      'NextjsHotReloaderForServer',\n      (stats) => {\n        this.serverStats = stats\n        if (!this.initialized) {\n          return\n        }\n\n        const { compilation } = stats\n\n        // We only watch `_document` for changes on the server compilation\n        // the rest of the files will be triggered by the client compilation\n        const documentChunk = compilation.chunks.find(\n          (c) => c.name === normalize(`static/BUILD_ID/pages/_document.js`)\n        )\n        // If the document chunk can't be found we do nothing\n        if (!documentChunk) {\n          console.warn('_document.js chunk not found')\n          return\n        }\n\n        // Initial value\n        if (this.serverPrevDocumentHash === null) {\n          this.serverPrevDocumentHash = documentChunk.hash\n          return\n        }\n\n        // If _document.js didn't change we don't trigger a reload\n        if (documentChunk.hash === this.serverPrevDocumentHash) {\n          return\n        }\n\n        // Notify reload to reload the page, as _document.js was changed (different hash)\n        this.send('reloadPage')\n        this.serverPrevDocumentHash = documentChunk.hash\n      }\n    )\n\n    multiCompiler.compilers[0].hooks.done.tap(\n      'NextjsHotReloaderForClient',\n      (stats) => {\n        const { compilation } = stats\n        const chunkNames = new Set(\n          compilation.chunks\n            .map((c) => c.name)\n            .filter((name) => IS_BUNDLED_PAGE_REGEX.test(name))\n        )\n\n        if (this.initialized) {\n          // detect chunks which have to be replaced with a new template\n          // e.g, pages/index.js <-> pages/_error.js\n          const addedPages = diff(chunkNames, this.prevChunkNames!)\n          const removedPages = diff(this.prevChunkNames!, chunkNames)\n\n          if (addedPages.size > 0) {\n            for (const addedPage of addedPages) {\n              const page = getRouteFromEntrypoint(addedPage)\n              this.send('addedPage', page)\n            }\n          }\n\n          if (removedPages.size > 0) {\n            for (const removedPage of removedPages) {\n              const page = getRouteFromEntrypoint(removedPage)\n              this.send('removedPage', page)\n            }\n          }\n        }\n\n        this.initialized = true\n        this.stats = stats\n        this.prevChunkNames = chunkNames\n      }\n    )\n\n    // We don’t watch .git/ .next/ and node_modules for changes\n    const ignored = [\n      /[\\\\/]\\.git[\\\\/]/,\n      /[\\\\/]\\.next[\\\\/]/,\n      /[\\\\/]node_modules[\\\\/]/,\n    ]\n\n    let webpackDevMiddlewareConfig = {\n      publicPath: `/_next/static/webpack`,\n      noInfo: true,\n      logLevel: 'silent',\n      watchOptions: { ignored },\n      writeToDisk: true,\n    }\n\n    if (this.config.webpackDevMiddleware) {\n      console.log(\n        `> Using \"webpackDevMiddleware\" config function defined in ${this.config.configOrigin}.`\n      )\n      webpackDevMiddlewareConfig = this.config.webpackDevMiddleware(\n        webpackDevMiddlewareConfig\n      )\n    }\n\n    const webpackDevMiddleware = WebpackDevMiddleware(\n      multiCompiler,\n      webpackDevMiddlewareConfig\n    )\n\n    const webpackHotMiddleware = WebpackHotMiddleware(\n      multiCompiler.compilers[0],\n      {\n        path: '/_next/webpack-hmr',\n        log: false,\n        heartbeat: 2500,\n      }\n    )\n\n    const onDemandEntries = onDemandEntryHandler(\n      webpackDevMiddleware,\n      multiCompiler,\n      {\n        pagesDir: this.pagesDir,\n        pageExtensions: this.config.pageExtensions,\n        ...(this.config.onDemandEntries as {\n          maxInactiveAge: number\n          pagesBufferLength: number\n        }),\n      }\n    )\n\n    return {\n      webpackDevMiddleware,\n      webpackHotMiddleware,\n      onDemandEntries,\n    }\n  }\n\n  private waitUntilValid(): Promise<webpack.Stats> {\n    return new Promise((resolve) => {\n      this.webpackDevMiddleware!.waitUntilValid(resolve)\n    })\n  }\n\n  public async getCompilationErrors(page: string) {\n    const normalizedPage = normalizePathSep(page)\n\n    if (this.stats.hasErrors()) {\n      const { compilation } = this.stats\n      const failedPages = erroredPages(compilation, {\n        enhanceName(name) {\n          return getRouteFromEntrypoint(name) as string\n        },\n      })\n\n      // If there is an error related to the requesting page we display it instead of the first error\n      if (\n        failedPages[normalizedPage] &&\n        failedPages[normalizedPage].length > 0\n      ) {\n        return failedPages[normalizedPage]\n      }\n\n      // If none were found we still have to show the other errors\n      return this.stats.compilation.errors\n    }\n\n    return []\n  }\n\n  private send(action: string, ...args: any[]): void {\n    this.webpackHotMiddleware!.publish({ action, data: args })\n  }\n\n  public async ensurePage(page: string) {\n    // Make sure we don't re-build or dispose prebuilt pages\n    if (page !== '/_error' && BLOCKED_PAGES.indexOf(page) !== -1) {\n      return\n    }\n    return this.onDemandEntries.ensurePage(page)\n  }\n}\n\nfunction diff(a: Set<any>, b: Set<any>) {\n  return new Set([...a].filter((v) => !b.has(v)))\n}\n"]}