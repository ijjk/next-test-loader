{"version":3,"sources":["../../server/image-optimizer.ts"],"names":["WEBP","PNG","JPEG","GIF","SVG","CACHE_VERSION","MODERN_TYPES","ANIMATABLE_TYPES","VECTOR_TYPES","BLUR_IMG_SIZE","inflightRequests","Map","imageOptimizer","server","req","res","parsedUrl","nextConfig","distDir","isDev","imageData","images","imageConfigDefault","deviceSizes","imageSizes","domains","loader","render404","finished","headers","url","w","q","query","mimeType","getSupportedMimeType","accept","href","statusCode","end","Array","isArray","isAbsolute","startsWith","hrefParsed","URL","toString","_error","includes","protocol","hostname","isStatic","width","parseInt","isNaN","sizes","push","quality","hash","getHash","imagesDir","hashDir","now","Date","has","get","dedupeResolver","set","Promise","resolve","files","promises","readdir","file","maxAgeStr","expireAtSt","etag","extension","split","maxAge","Number","expireAt","contentType","fsPath","result","setResponseHeaders","pipe","unlink","upstreamBuffer","upstreamType","upstreamRes","fetch","ok","status","Buffer","from","arrayBuffer","detectContentType","getMaxAge","resBuffers","mockRes","Stream","Writable","isStreamFinished","reject","on","write","chunk","isBuffer","_write","mockHeaders","writeHead","_status","_headers","Object","assign","getHeader","name","toLowerCase","getHeaders","getHeaderNames","keys","setHeader","value","_implicitHeader","mockReq","Readable","_read","emit","method","getRequestHandler","nodeUrl","parse","concat","err","vector","animate","writeToCacheDir","sendResponse","orientation","operations","Orientation","RIGHT_TOP","type","numRotations","BOTTOM_RIGHT","LEFT_BOTTOM","optimizedBuffer","Error","error","delete","dir","buffer","mkdir","recursive","filename","writeFile","options","items","item","update","String","digest","replace","parseCacheControl","str","map","directive","key","trim","every","b","i","minimum","age","endsWith","slice","n","Math","max"],"mappings":"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","sourcesContent":["import { mediaType } from '@hapi/accept'\nimport { createHash } from 'crypto'\nimport { createReadStream, promises } from 'fs'\nimport { getOrientation, Orientation } from 'get-orientation'\nimport { IncomingMessage, ServerResponse } from 'http'\n// @ts-ignore no types for is-animated\nimport isAnimated from 'next/dist/compiled/is-animated'\nimport { join } from 'path'\nimport Stream from 'stream'\nimport nodeUrl, { UrlWithParsedQuery } from 'url'\nimport { NextConfig } from './config-shared'\nimport { fileExists } from '../lib/file-exists'\nimport { ImageConfig, imageConfigDefault } from './image-config'\nimport { processBuffer, Operation } from './lib/squoosh/main'\nimport Server from './next-server'\nimport { sendEtagResponse } from './send-payload'\nimport { getContentType, getExtension } from './serve-static'\n\n//const AVIF = 'image/avif'\nconst WEBP = 'image/webp'\nconst PNG = 'image/png'\nconst JPEG = 'image/jpeg'\nconst GIF = 'image/gif'\nconst SVG = 'image/svg+xml'\nconst CACHE_VERSION = 3\nconst MODERN_TYPES = [/* AVIF, */ WEBP]\nconst ANIMATABLE_TYPES = [WEBP, PNG, GIF]\nconst VECTOR_TYPES = [SVG]\nconst BLUR_IMG_SIZE = 8 // should match `next-image-loader`\nconst inflightRequests = new Map<string, Promise<undefined>>()\n\nexport async function imageOptimizer(\n  server: Server,\n  req: IncomingMessage,\n  res: ServerResponse,\n  parsedUrl: UrlWithParsedQuery,\n  nextConfig: NextConfig,\n  distDir: string,\n  isDev = false\n) {\n  const imageData: ImageConfig = nextConfig.images || imageConfigDefault\n  const { deviceSizes = [], imageSizes = [], domains = [], loader } = imageData\n\n  if (loader !== 'default') {\n    await server.render404(req, res, parsedUrl)\n    return { finished: true }\n  }\n\n  const { headers } = req\n  const { url, w, q } = parsedUrl.query\n  const mimeType = getSupportedMimeType(MODERN_TYPES, headers.accept)\n  let href: string\n\n  if (!url) {\n    res.statusCode = 400\n    res.end('\"url\" parameter is required')\n    return { finished: true }\n  } else if (Array.isArray(url)) {\n    res.statusCode = 400\n    res.end('\"url\" parameter cannot be an array')\n    return { finished: true }\n  }\n\n  let isAbsolute: boolean\n\n  if (url.startsWith('/')) {\n    href = url\n    isAbsolute = false\n  } else {\n    let hrefParsed: URL\n\n    try {\n      hrefParsed = new URL(url)\n      href = hrefParsed.toString()\n      isAbsolute = true\n    } catch (_error) {\n      res.statusCode = 400\n      res.end('\"url\" parameter is invalid')\n      return { finished: true }\n    }\n\n    if (!['http:', 'https:'].includes(hrefParsed.protocol)) {\n      res.statusCode = 400\n      res.end('\"url\" parameter is invalid')\n      return { finished: true }\n    }\n\n    if (!domains.includes(hrefParsed.hostname)) {\n      res.statusCode = 400\n      res.end('\"url\" parameter is not allowed')\n      return { finished: true }\n    }\n  }\n\n  if (!w) {\n    res.statusCode = 400\n    res.end('\"w\" parameter (width) is required')\n    return { finished: true }\n  } else if (Array.isArray(w)) {\n    res.statusCode = 400\n    res.end('\"w\" parameter (width) cannot be an array')\n    return { finished: true }\n  }\n\n  if (!q) {\n    res.statusCode = 400\n    res.end('\"q\" parameter (quality) is required')\n    return { finished: true }\n  } else if (Array.isArray(q)) {\n    res.statusCode = 400\n    res.end('\"q\" parameter (quality) cannot be an array')\n    return { finished: true }\n  }\n\n  // Should match output from next-image-loader\n  const isStatic = url.startsWith('/_next/static/image')\n\n  const width = parseInt(w, 10)\n\n  if (!width || isNaN(width)) {\n    res.statusCode = 400\n    res.end('\"w\" parameter (width) must be a number greater than 0')\n    return { finished: true }\n  }\n\n  const sizes = [...deviceSizes, ...imageSizes]\n\n  if (isDev) {\n    sizes.push(BLUR_IMG_SIZE)\n  }\n\n  if (!sizes.includes(width)) {\n    res.statusCode = 400\n    res.end(`\"w\" parameter (width) of ${width} is not allowed`)\n    return { finished: true }\n  }\n\n  const quality = parseInt(q)\n\n  if (isNaN(quality) || quality < 1 || quality > 100) {\n    res.statusCode = 400\n    res.end('\"q\" parameter (quality) must be a number between 1 and 100')\n    return { finished: true }\n  }\n\n  const hash = getHash([CACHE_VERSION, href, width, quality, mimeType])\n  const imagesDir = join(distDir, 'cache', 'images')\n  const hashDir = join(imagesDir, hash)\n  const now = Date.now()\n\n  // If there're concurrent requests hitting the same resource and it's still\n  // being optimized, wait before accessing the cache.\n  if (inflightRequests.has(hash)) {\n    await inflightRequests.get(hash)\n  }\n  let dedupeResolver: (val?: PromiseLike<undefined>) => void\n  inflightRequests.set(\n    hash,\n    new Promise((resolve) => (dedupeResolver = resolve))\n  )\n\n  try {\n    if (await fileExists(hashDir, 'directory')) {\n      const files = await promises.readdir(hashDir)\n      for (let file of files) {\n        const [maxAgeStr, expireAtSt, etag, extension] = file.split('.')\n        const maxAge = Number(maxAgeStr)\n        const expireAt = Number(expireAtSt)\n        const contentType = getContentType(extension)\n        const fsPath = join(hashDir, file)\n        if (now < expireAt) {\n          const result = setResponseHeaders(\n            req,\n            res,\n            etag,\n            maxAge,\n            contentType,\n            isStatic,\n            isDev\n          )\n          if (!result.finished) {\n            createReadStream(fsPath).pipe(res)\n          }\n          return { finished: true }\n        } else {\n          await promises.unlink(fsPath)\n        }\n      }\n    }\n\n    let upstreamBuffer: Buffer\n    let upstreamType: string | null\n    let maxAge: number\n\n    if (isAbsolute) {\n      const upstreamRes = await fetch(href)\n\n      if (!upstreamRes.ok) {\n        res.statusCode = upstreamRes.status\n        res.end('\"url\" parameter is valid but upstream response is invalid')\n        return { finished: true }\n      }\n\n      res.statusCode = upstreamRes.status\n      upstreamBuffer = Buffer.from(await upstreamRes.arrayBuffer())\n      upstreamType =\n        detectContentType(upstreamBuffer) ||\n        upstreamRes.headers.get('Content-Type')\n      maxAge = getMaxAge(upstreamRes.headers.get('Cache-Control'))\n    } else {\n      try {\n        const resBuffers: Buffer[] = []\n        const mockRes: any = new Stream.Writable()\n\n        const isStreamFinished = new Promise(function (resolve, reject) {\n          mockRes.on('finish', () => resolve(true))\n          mockRes.on('end', () => resolve(true))\n          mockRes.on('error', () => reject())\n        })\n\n        mockRes.write = (chunk: Buffer | string) => {\n          resBuffers.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk))\n        }\n        mockRes._write = (chunk: Buffer | string) => {\n          mockRes.write(chunk)\n        }\n\n        const mockHeaders: Record<string, string | string[]> = {}\n\n        mockRes.writeHead = (_status: any, _headers: any) =>\n          Object.assign(mockHeaders, _headers)\n        mockRes.getHeader = (name: string) => mockHeaders[name.toLowerCase()]\n        mockRes.getHeaders = () => mockHeaders\n        mockRes.getHeaderNames = () => Object.keys(mockHeaders)\n        mockRes.setHeader = (name: string, value: string | string[]) =>\n          (mockHeaders[name.toLowerCase()] = value)\n        mockRes._implicitHeader = () => {}\n        mockRes.finished = false\n        mockRes.statusCode = 200\n\n        const mockReq: any = new Stream.Readable()\n\n        mockReq._read = () => {\n          mockReq.emit('end')\n          mockReq.emit('close')\n          return Buffer.from('')\n        }\n\n        mockReq.headers = req.headers\n        mockReq.method = req.method\n        mockReq.url = href\n\n        await server.getRequestHandler()(\n          mockReq,\n          mockRes,\n          nodeUrl.parse(href, true)\n        )\n        await isStreamFinished\n        res.statusCode = mockRes.statusCode\n\n        upstreamBuffer = Buffer.concat(resBuffers)\n        upstreamType =\n          detectContentType(upstreamBuffer) || mockRes.getHeader('Content-Type')\n        maxAge = getMaxAge(mockRes.getHeader('Cache-Control'))\n      } catch (err) {\n        res.statusCode = 500\n        res.end('\"url\" parameter is valid but upstream response is invalid')\n        return { finished: true }\n      }\n    }\n\n    const expireAt = maxAge * 1000 + now\n\n    if (upstreamType) {\n      const vector = VECTOR_TYPES.includes(upstreamType)\n      const animate =\n        ANIMATABLE_TYPES.includes(upstreamType) && isAnimated(upstreamBuffer)\n      if (vector || animate) {\n        await writeToCacheDir(\n          hashDir,\n          upstreamType,\n          maxAge,\n          expireAt,\n          upstreamBuffer\n        )\n        sendResponse(\n          req,\n          res,\n          maxAge,\n          upstreamType,\n          upstreamBuffer,\n          isStatic,\n          isDev\n        )\n        return { finished: true }\n      }\n\n      if (!upstreamType.startsWith('image/')) {\n        res.statusCode = 400\n        res.end(\"The requested resource isn't a valid image.\")\n        return { finished: true }\n      }\n    }\n\n    let contentType: string\n\n    if (mimeType) {\n      contentType = mimeType\n    } else if (\n      upstreamType?.startsWith('image/') &&\n      getExtension(upstreamType)\n    ) {\n      contentType = upstreamType\n    } else {\n      contentType = JPEG\n    }\n\n    try {\n      const orientation = await getOrientation(upstreamBuffer)\n\n      const operations: Operation[] = []\n\n      if (orientation === Orientation.RIGHT_TOP) {\n        operations.push({ type: 'rotate', numRotations: 1 })\n      } else if (orientation === Orientation.BOTTOM_RIGHT) {\n        operations.push({ type: 'rotate', numRotations: 2 })\n      } else if (orientation === Orientation.LEFT_BOTTOM) {\n        operations.push({ type: 'rotate', numRotations: 3 })\n      } else {\n        // TODO: support more orientations\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\n        // const _: never = orientation\n      }\n\n      operations.push({ type: 'resize', width })\n\n      let optimizedBuffer: Buffer | undefined\n      //if (contentType === AVIF) {\n      //} else\n      if (contentType === WEBP) {\n        optimizedBuffer = await processBuffer(\n          upstreamBuffer,\n          operations,\n          'webp',\n          quality\n        )\n      } else if (contentType === PNG) {\n        optimizedBuffer = await processBuffer(\n          upstreamBuffer,\n          operations,\n          'png',\n          quality\n        )\n      } else if (contentType === JPEG) {\n        optimizedBuffer = await processBuffer(\n          upstreamBuffer,\n          operations,\n          'jpeg',\n          quality\n        )\n      }\n\n      if (optimizedBuffer) {\n        await writeToCacheDir(\n          hashDir,\n          contentType,\n          maxAge,\n          expireAt,\n          optimizedBuffer\n        )\n        sendResponse(\n          req,\n          res,\n          maxAge,\n          contentType,\n          optimizedBuffer,\n          isStatic,\n          isDev\n        )\n      } else {\n        throw new Error('Unable to optimize buffer')\n      }\n    } catch (error) {\n      sendResponse(\n        req,\n        res,\n        maxAge,\n        upstreamType,\n        upstreamBuffer,\n        isStatic,\n        isDev\n      )\n    }\n\n    return { finished: true }\n  } finally {\n    // Make sure to remove the hash in the end.\n    dedupeResolver!()\n    inflightRequests.delete(hash)\n  }\n}\n\nasync function writeToCacheDir(\n  dir: string,\n  contentType: string,\n  maxAge: number,\n  expireAt: number,\n  buffer: Buffer\n) {\n  await promises.mkdir(dir, { recursive: true })\n  const extension = getExtension(contentType)\n  const etag = getHash([buffer])\n  const filename = join(dir, `${maxAge}.${expireAt}.${etag}.${extension}`)\n  await promises.writeFile(filename, buffer)\n}\n\nfunction setResponseHeaders(\n  req: IncomingMessage,\n  res: ServerResponse,\n  etag: string,\n  maxAge: number,\n  contentType: string | null,\n  isStatic: boolean,\n  isDev: boolean\n) {\n  res.setHeader('Vary', 'Accept')\n  res.setHeader(\n    'Cache-Control',\n    isStatic\n      ? 'public, max-age=315360000, immutable'\n      : `public, max-age=${isDev ? 0 : maxAge}, must-revalidate`\n  )\n  if (sendEtagResponse(req, res, etag)) {\n    // already called res.end() so we're finished\n    return { finished: true }\n  }\n  if (contentType) {\n    res.setHeader('Content-Type', contentType)\n  }\n  return { finished: false }\n}\n\nfunction sendResponse(\n  req: IncomingMessage,\n  res: ServerResponse,\n  maxAge: number,\n  contentType: string | null,\n  buffer: Buffer,\n  isStatic: boolean,\n  isDev: boolean\n) {\n  const etag = getHash([buffer])\n  const result = setResponseHeaders(\n    req,\n    res,\n    etag,\n    maxAge,\n    contentType,\n    isStatic,\n    isDev\n  )\n  if (!result.finished) {\n    res.end(buffer)\n  }\n}\n\nfunction getSupportedMimeType(options: string[], accept = ''): string {\n  const mimeType = mediaType(accept, options)\n  return accept.includes(mimeType) ? mimeType : ''\n}\n\nfunction getHash(items: (string | number | Buffer)[]) {\n  const hash = createHash('sha256')\n  for (let item of items) {\n    if (typeof item === 'number') hash.update(String(item))\n    else {\n      hash.update(item)\n    }\n  }\n  // See https://en.wikipedia.org/wiki/Base64#Filenames\n  return hash.digest('base64').replace(/\\//g, '-')\n}\n\nfunction parseCacheControl(str: string | null): Map<string, string> {\n  const map = new Map<string, string>()\n  if (!str) {\n    return map\n  }\n  for (let directive of str.split(',')) {\n    let [key, value] = directive.trim().split('=')\n    key = key.toLowerCase()\n    if (value) {\n      value = value.toLowerCase()\n    }\n    map.set(key, value)\n  }\n  return map\n}\n\n/**\n * Inspects the first few bytes of a buffer to determine if\n * it matches the \"magic number\" of known file signatures.\n * https://en.wikipedia.org/wiki/List_of_file_signatures\n */\nexport function detectContentType(buffer: Buffer) {\n  if ([0xff, 0xd8, 0xff].every((b, i) => buffer[i] === b)) {\n    return JPEG\n  }\n  if (\n    [0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a].every(\n      (b, i) => buffer[i] === b\n    )\n  ) {\n    return PNG\n  }\n  if ([0x47, 0x49, 0x46, 0x38].every((b, i) => buffer[i] === b)) {\n    return GIF\n  }\n  if (\n    [0x52, 0x49, 0x46, 0x46, 0, 0, 0, 0, 0x57, 0x45, 0x42, 0x50].every(\n      (b, i) => !b || buffer[i] === b\n    )\n  ) {\n    return WEBP\n  }\n  if ([0x3c, 0x3f, 0x78, 0x6d, 0x6c].every((b, i) => buffer[i] === b)) {\n    return SVG\n  }\n  return null\n}\n\nexport function getMaxAge(str: string | null): number {\n  const minimum = 60\n  const map = parseCacheControl(str)\n  if (map) {\n    let age = map.get('s-maxage') || map.get('max-age') || ''\n    if (age.startsWith('\"') && age.endsWith('\"')) {\n      age = age.slice(1, -1)\n    }\n    const n = parseInt(age, 10)\n    if (!isNaN(n)) {\n      return Math.max(n, minimum)\n    }\n  }\n  return minimum\n}\n"]}