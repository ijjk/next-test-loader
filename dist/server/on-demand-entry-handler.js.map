{"version":3,"sources":["../../server/on-demand-entry-handler.ts"],"names":["ADDED","Symbol","BUILDING","BUILT","addEntry","compilation","context","name","entry","Promise","resolve","reject","dep","DynamicEntryPlugin","createDependency","err","onDemandEntryHandler","devMiddleware","multiCompiler","pagesDir","pageExtensions","maxInactiveAge","pagesBufferLength","compilers","invalidator","Invalidator","entries","lastAccessPages","doneCallbacks","EventEmitter","compiler","hooks","make","tapPromise","startBuilding","isClientCompilation","allEntries","Object","keys","map","page","match","API_ROUTE","serverBundlePath","clientBundlePath","absolutePagePath","pageExists","status","pageLoaderOpts","all","catch","console","error","getPagePathsFromEntrypoints","entrypoints","pagePaths","entrypoint","values","push","done","tap","multiStats","clientStats","serverStats","stats","Set","lastActiveTime","Date","now","emit","doneBuilding","disposeHandler","setInterval","disposeInactiveEntries","unref","handlePing","pg","entryInfo","toSend","invalid","success","includes","unshift","length","pop","ensurePage","normalizedPagePath","pagePath","pageUrl","replace","RegExp","join","bundleFile","startsWith","require","posix","normalize","normalizedPage","once","handleCallback","Log","event","invalidate","middleware","req","res","next","test","url","query","runPing","data","write","JSON","stringify","pingInterval","on","clearInterval","disposingPages","forEach","constructor","building","rebuildAgain","call"],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport WebpackDevMiddleware from 'next/dist/compiled/webpack-dev-middleware'\nimport { join, posix } from 'path'\nimport { stringify } from 'querystring'\nimport { parse } from 'url'\nimport webpack from 'webpack'\nimport DynamicEntryPlugin from 'webpack/lib/DynamicEntryPlugin'\nimport { isWriteable } from '../build/is-writeable'\nimport * as Log from '../build/output/log'\nimport { ClientPagesLoaderOptions } from '../build/webpack/loaders/next-client-pages-loader'\nimport { API_ROUTE } from '../lib/constants'\nimport {\n  normalizePagePath,\n  normalizePathSep,\n} from '../next-server/server/normalize-page-path'\nimport { pageNotFoundError } from '../next-server/server/require'\nimport { findPageFile } from './lib/find-page-file'\nimport getRouteFromEntrypoint from '../next-server/server/get-route-from-entrypoint'\n\nconst ADDED = Symbol('added')\nconst BUILDING = Symbol('building')\nconst BUILT = Symbol('built')\n\n// Based on https://github.com/webpack/webpack/blob/master/lib/DynamicEntryPlugin.js#L29-L37\nfunction addEntry(\n  compilation: webpack.compilation.Compilation,\n  context: string,\n  name: string,\n  entry: string[]\n) {\n  return new Promise((resolve, reject) => {\n    const dep = DynamicEntryPlugin.createDependency(entry, name)\n    compilation.addEntry(context, dep, name, (err: Error) => {\n      if (err) return reject(err)\n      resolve()\n    })\n  })\n}\n\nexport default function onDemandEntryHandler(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  multiCompiler: webpack.MultiCompiler,\n  {\n    pagesDir,\n    pageExtensions,\n    maxInactiveAge,\n    pagesBufferLength,\n  }: {\n    pagesDir: string\n    pageExtensions: string[]\n    maxInactiveAge: number\n    pagesBufferLength: number\n  }\n) {\n  const { compilers } = multiCompiler\n  const invalidator = new Invalidator(devMiddleware, multiCompiler)\n  let entries: {\n    [page: string]: {\n      serverBundlePath: string\n      clientBundlePath: string\n      absolutePagePath: string\n      status?: typeof ADDED | typeof BUILDING | typeof BUILT\n      lastActiveTime?: number\n    }\n  } = {}\n  let lastAccessPages = ['']\n  let doneCallbacks: EventEmitter | null = new EventEmitter()\n\n  for (const compiler of compilers) {\n    compiler.hooks.make.tapPromise(\n      'NextJsOnDemandEntries',\n      (compilation: webpack.compilation.Compilation) => {\n        invalidator.startBuilding()\n\n        const isClientCompilation = compiler.name === 'client'\n        const allEntries = Object.keys(entries).map(async (page) => {\n          if (isClientCompilation && page.match(API_ROUTE)) {\n            return\n          }\n          const {\n            serverBundlePath,\n            clientBundlePath,\n            absolutePagePath,\n          } = entries[page]\n          const pageExists = await isWriteable(absolutePagePath)\n          if (!pageExists) {\n            // page was removed\n            delete entries[page]\n            return\n          }\n\n          entries[page].status = BUILDING\n          const pageLoaderOpts: ClientPagesLoaderOptions = {\n            page,\n            absolutePagePath,\n          }\n          return addEntry(\n            compilation,\n            compiler.context,\n            isClientCompilation ? clientBundlePath : serverBundlePath,\n            [\n              isClientCompilation\n                ? `next-client-pages-loader?${stringify(pageLoaderOpts)}!`\n                : absolutePagePath,\n            ]\n          )\n        })\n\n        return Promise.all(allEntries).catch((err) => console.error(err))\n      }\n    )\n  }\n\n  function getPagePathsFromEntrypoints(entrypoints: any): string[] {\n    const pagePaths = []\n    for (const entrypoint of entrypoints.values()) {\n      const page = getRouteFromEntrypoint(entrypoint.name)\n      if (page) {\n        pagePaths.push(page)\n      }\n    }\n\n    return pagePaths\n  }\n\n  multiCompiler.hooks.done.tap('NextJsOnDemandEntries', (multiStats) => {\n    const [clientStats, serverStats] = multiStats.stats\n    const pagePaths = new Set([\n      ...getPagePathsFromEntrypoints(clientStats.compilation.entrypoints),\n      ...getPagePathsFromEntrypoints(serverStats.compilation.entrypoints),\n    ])\n\n    for (const page of pagePaths) {\n      const entry = entries[page]\n      if (!entry) {\n        continue\n      }\n\n      if (entry.status !== BUILDING) {\n        continue\n      }\n\n      entry.status = BUILT\n      entry.lastActiveTime = Date.now()\n      doneCallbacks!.emit(page)\n    }\n\n    invalidator.doneBuilding()\n  })\n\n  const disposeHandler = setInterval(function () {\n    disposeInactiveEntries(\n      devMiddleware,\n      entries,\n      lastAccessPages,\n      maxInactiveAge\n    )\n  }, 5000)\n\n  disposeHandler.unref()\n\n  function handlePing(pg: string) {\n    const page = normalizePathSep(pg)\n    const entryInfo = entries[page]\n    let toSend\n\n    // If there's no entry, it may have been invalidated and needs to be re-built.\n    if (!entryInfo) {\n      // if (page !== lastEntry) client pings, but there's no entry for page\n      return { invalid: true }\n    }\n\n    // 404 is an on demand entry but when a new page is added we have to refresh the page\n    if (page === '/_error') {\n      toSend = { invalid: true }\n    } else {\n      toSend = { success: true }\n    }\n\n    // We don't need to maintain active state of anything other than BUILT entries\n    if (entryInfo.status !== BUILT) return\n\n    // If there's an entryInfo\n    if (!lastAccessPages.includes(page)) {\n      lastAccessPages.unshift(page)\n\n      // Maintain the buffer max length\n      if (lastAccessPages.length > pagesBufferLength) {\n        lastAccessPages.pop()\n      }\n    }\n    entryInfo.lastActiveTime = Date.now()\n    return toSend\n  }\n\n  return {\n    async ensurePage(page: string) {\n      let normalizedPagePath: string\n      try {\n        normalizedPagePath = normalizePagePath(page)\n      } catch (err) {\n        console.error(err)\n        throw pageNotFoundError(page)\n      }\n\n      let pagePath = await findPageFile(\n        pagesDir,\n        normalizedPagePath,\n        pageExtensions\n      )\n\n      // Default the /_error route to the Next.js provided default page\n      if (page === '/_error' && pagePath === null) {\n        pagePath = 'next/dist/pages/_error'\n      }\n\n      if (pagePath === null) {\n        throw pageNotFoundError(normalizedPagePath)\n      }\n\n      let pageUrl = pagePath.replace(/\\\\/g, '/')\n\n      pageUrl = `${pageUrl[0] !== '/' ? '/' : ''}${pageUrl\n        .replace(new RegExp(`\\\\.+(?:${pageExtensions.join('|')})$`), '')\n        .replace(/\\/index$/, '')}`\n\n      pageUrl = pageUrl === '' ? '/' : pageUrl\n\n      const bundleFile = normalizePagePath(pageUrl)\n      const serverBundlePath = join('pages', bundleFile)\n      const clientBundlePath = join('static', 'pages', bundleFile)\n      const absolutePagePath = pagePath.startsWith('next/dist/pages')\n        ? require.resolve(pagePath)\n        : join(pagesDir, pagePath)\n\n      page = posix.normalize(pageUrl)\n\n      return new Promise((resolve, reject) => {\n        // Makes sure the page that is being kept in on-demand-entries matches the webpack output\n        const normalizedPage = normalizePathSep(page)\n        const entryInfo = entries[normalizedPage]\n\n        if (entryInfo) {\n          if (entryInfo.status === BUILT) {\n            resolve()\n            return\n          }\n\n          if (entryInfo.status === BUILDING) {\n            doneCallbacks!.once(normalizedPage, handleCallback)\n            return\n          }\n        }\n\n        Log.event(`build page: ${normalizedPage}`)\n\n        entries[normalizedPage] = {\n          serverBundlePath,\n          clientBundlePath,\n          absolutePagePath,\n          status: ADDED,\n        }\n        doneCallbacks!.once(normalizedPage, handleCallback)\n\n        invalidator.invalidate()\n\n        function handleCallback(err: Error) {\n          if (err) return reject(err)\n          resolve()\n        }\n      })\n    },\n\n    middleware() {\n      return (req: IncomingMessage, res: ServerResponse, next: Function) => {\n        if (!/^\\/_next\\/webpack-hmr/.test(req.url!)) return next()\n\n        const { query } = parse(req.url!, true)\n        const page = query.page\n        if (!page) return next()\n\n        const runPing = () => {\n          const data = handlePing(query.page as string)\n          if (!data) return\n          res.write('data: ' + JSON.stringify(data) + '\\n\\n')\n        }\n        const pingInterval = setInterval(() => runPing(), 5000)\n\n        req.on('close', () => {\n          clearInterval(pingInterval)\n        })\n        next()\n      }\n    },\n  }\n}\n\nfunction disposeInactiveEntries(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  entries: any,\n  lastAccessPages: any,\n  maxInactiveAge: number\n) {\n  const disposingPages: any = []\n\n  Object.keys(entries).forEach((page) => {\n    const { lastActiveTime, status } = entries[page]\n\n    // This means this entry is currently building or just added\n    // We don't need to dispose those entries.\n    if (status !== BUILT) return\n\n    // We should not build the last accessed page even we didn't get any pings\n    // Sometimes, it's possible our XHR ping to wait before completing other requests.\n    // In that case, we should not dispose the current viewing page\n    if (lastAccessPages.includes(page)) return\n\n    if (Date.now() - lastActiveTime > maxInactiveAge) {\n      disposingPages.push(page)\n    }\n  })\n\n  if (disposingPages.length > 0) {\n    disposingPages.forEach((page: any) => {\n      delete entries[page]\n    })\n    // disposing inactive page(s)\n    devMiddleware.invalidate()\n  }\n}\n\n// Make sure only one invalidation happens at a time\n// Otherwise, webpack hash gets changed and it'll force the client to reload.\nclass Invalidator {\n  private multiCompiler: webpack.MultiCompiler\n  private devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware\n  private building: boolean\n  private rebuildAgain: boolean\n\n  constructor(\n    devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n    multiCompiler: webpack.MultiCompiler\n  ) {\n    this.multiCompiler = multiCompiler\n    this.devMiddleware = devMiddleware\n    // contains an array of types of compilers currently building\n    this.building = false\n    this.rebuildAgain = false\n  }\n\n  invalidate() {\n    // If there's a current build is processing, we won't abort it by invalidating.\n    // (If aborted, it'll cause a client side hard reload)\n    // But let it to invalidate just after the completion.\n    // So, it can re-build the queued pages at once.\n    if (this.building) {\n      this.rebuildAgain = true\n      return\n    }\n\n    this.building = true\n    // Work around a bug in webpack, calling `invalidate` on Watching.js\n    // doesn't trigger the invalid call used to keep track of the `.done` hook on multiCompiler\n    for (const compiler of this.multiCompiler.compilers) {\n      compiler.hooks.invalid.call()\n    }\n    this.devMiddleware.invalidate()\n  }\n\n  startBuilding() {\n    this.building = true\n  }\n\n  doneBuilding() {\n    this.building = false\n\n    if (this.rebuildAgain) {\n      this.rebuildAgain = false\n      this.invalidate()\n    }\n  }\n}\n"]}