{"version":3,"sources":["../../server/on-demand-entry-handler.ts"],"names":["ADDED","Symbol","BUILDING","BUILT","addEntry","compilation","context","name","entry","Promise","resolve","reject","dep","DynamicEntryPlugin","createDependency","err","onDemandEntryHandler","devMiddleware","multiCompiler","buildId","pagesDir","pageExtensions","maxInactiveAge","pagesBufferLength","compilers","invalidator","Invalidator","entries","lastAccessPages","doneCallbacks","EventEmitter","compiler","hooks","make","tapPromise","startBuilding","allEntries","Object","keys","map","page","match","API_ROUTE","absolutePagePath","pageExists","status","pageLoaderOpts","all","catch","console","error","getPagePathsFromEntrypoints","entrypoints","pagePaths","entrypoint","result","ROUTE_NAME_REGEX","exec","pagePath","push","done","tap","multiStats","clientStats","serverStats","stats","Set","normalizePage","lastActiveTime","Date","now","emit","doneBuilding","disposeHandler","setInterval","disposeInactiveEntries","unref","handlePing","pg","entryInfo","toSend","invalid","success","includes","unshift","length","pop","ensurePage","normalizedPagePath","pageUrl","replace","RegExp","join","bundleFile","startsWith","require","posix","normalize","normalizedPage","once","handleCallback","Log","event","invalidate","middleware","req","res","next","test","url","query","runPing","data","write","JSON","stringify","pingInterval","on","clearInterval","disposingPages","forEach","unixPagePath","constructor","building","rebuildAgain","call"],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport WebpackDevMiddleware from 'next/dist/compiled/webpack-dev-middleware'\nimport { join, posix } from 'path'\nimport { stringify } from 'querystring'\nimport { parse } from 'url'\nimport webpack from 'webpack'\nimport DynamicEntryPlugin from 'webpack/lib/DynamicEntryPlugin'\nimport { isWriteable } from '../build/is-writeable'\nimport * as Log from '../build/output/log'\nimport { ClientPagesLoaderOptions } from '../build/webpack/loaders/next-client-pages-loader'\nimport { API_ROUTE } from '../lib/constants'\nimport { ROUTE_NAME_REGEX } from '../next-server/lib/constants'\nimport { normalizePagePath } from '../next-server/server/normalize-page-path'\nimport { pageNotFoundError } from '../next-server/server/require'\nimport { findPageFile } from './lib/find-page-file'\n\nconst ADDED = Symbol('added')\nconst BUILDING = Symbol('building')\nconst BUILT = Symbol('built')\n\n// Based on https://github.com/webpack/webpack/blob/master/lib/DynamicEntryPlugin.js#L29-L37\nfunction addEntry(\n  compilation: webpack.compilation.Compilation,\n  context: string,\n  name: string,\n  entry: string[]\n) {\n  return new Promise((resolve, reject) => {\n    const dep = DynamicEntryPlugin.createDependency(entry, name)\n    compilation.addEntry(context, dep, name, (err: Error) => {\n      if (err) return reject(err)\n      resolve()\n    })\n  })\n}\n\nexport default function onDemandEntryHandler(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  multiCompiler: webpack.MultiCompiler,\n  {\n    buildId,\n    pagesDir,\n    pageExtensions,\n    maxInactiveAge,\n    pagesBufferLength,\n  }: {\n    buildId: string\n    pagesDir: string\n    pageExtensions: string[]\n    maxInactiveAge: number\n    pagesBufferLength: number\n  }\n) {\n  const { compilers } = multiCompiler\n  const invalidator = new Invalidator(devMiddleware, multiCompiler)\n  let entries: any = {}\n  let lastAccessPages = ['']\n  let doneCallbacks: EventEmitter | null = new EventEmitter()\n\n  for (const compiler of compilers) {\n    compiler.hooks.make.tapPromise(\n      'NextJsOnDemandEntries',\n      (compilation: webpack.compilation.Compilation) => {\n        invalidator.startBuilding()\n\n        const allEntries = Object.keys(entries).map(async (page) => {\n          if (compiler.name === 'client' && page.match(API_ROUTE)) {\n            return\n          }\n          const { name, absolutePagePath } = entries[page]\n          const pageExists = await isWriteable(absolutePagePath)\n          if (!pageExists) {\n            // page was removed\n            delete entries[page]\n            return\n          }\n\n          entries[page].status = BUILDING\n          const pageLoaderOpts: ClientPagesLoaderOptions = {\n            page,\n            absolutePagePath,\n          }\n          return addEntry(compilation, compiler.context, name, [\n            compiler.name === 'client'\n              ? `next-client-pages-loader?${stringify(pageLoaderOpts)}!`\n              : absolutePagePath,\n          ])\n        })\n\n        return Promise.all(allEntries).catch((err) => console.error(err))\n      }\n    )\n  }\n\n  function getPagePathsFromEntrypoints(entrypoints: any) {\n    const pagePaths = []\n    for (const [, entrypoint] of entrypoints.entries()) {\n      const result = ROUTE_NAME_REGEX.exec(entrypoint.name)\n      if (!result) {\n        continue\n      }\n\n      const pagePath = result[1]\n\n      if (!pagePath) {\n        continue\n      }\n\n      pagePaths.push(pagePath)\n    }\n\n    return pagePaths\n  }\n\n  multiCompiler.hooks.done.tap('NextJsOnDemandEntries', (multiStats) => {\n    const [clientStats, serverStats] = multiStats.stats\n    const pagePaths = new Set([\n      ...getPagePathsFromEntrypoints(clientStats.compilation.entrypoints),\n      ...getPagePathsFromEntrypoints(serverStats.compilation.entrypoints),\n    ])\n\n    // compilation.entrypoints is a Map object, so iterating over it 0 is the key and 1 is the value\n    for (const pagePath of pagePaths) {\n      const page = normalizePage('/' + pagePath)\n\n      const entry = entries[page]\n      if (!entry) {\n        continue\n      }\n\n      if (entry.status !== BUILDING) {\n        continue\n      }\n\n      entry.status = BUILT\n      entry.lastActiveTime = Date.now()\n      doneCallbacks!.emit(page)\n    }\n\n    invalidator.doneBuilding()\n  })\n\n  const disposeHandler = setInterval(function () {\n    disposeInactiveEntries(\n      devMiddleware,\n      entries,\n      lastAccessPages,\n      maxInactiveAge\n    )\n  }, 5000)\n\n  disposeHandler.unref()\n\n  function handlePing(pg: string) {\n    const page = normalizePage(pg)\n    const entryInfo = entries[page]\n    let toSend\n\n    // If there's no entry, it may have been invalidated and needs to be re-built.\n    if (!entryInfo) {\n      // if (page !== lastEntry) client pings, but there's no entry for page\n      return { invalid: true }\n    }\n\n    // 404 is an on demand entry but when a new page is added we have to refresh the page\n    if (page === '/_error') {\n      toSend = { invalid: true }\n    } else {\n      toSend = { success: true }\n    }\n\n    // We don't need to maintain active state of anything other than BUILT entries\n    if (entryInfo.status !== BUILT) return\n\n    // If there's an entryInfo\n    if (!lastAccessPages.includes(page)) {\n      lastAccessPages.unshift(page)\n\n      // Maintain the buffer max length\n      if (lastAccessPages.length > pagesBufferLength) {\n        lastAccessPages.pop()\n      }\n    }\n    entryInfo.lastActiveTime = Date.now()\n    return toSend\n  }\n\n  return {\n    async ensurePage(page: string) {\n      let normalizedPagePath: string\n      try {\n        normalizedPagePath = normalizePagePath(page)\n      } catch (err) {\n        console.error(err)\n        throw pageNotFoundError(page)\n      }\n\n      let pagePath = await findPageFile(\n        pagesDir,\n        normalizedPagePath,\n        pageExtensions\n      )\n\n      // Default the /_error route to the Next.js provided default page\n      if (page === '/_error' && pagePath === null) {\n        pagePath = 'next/dist/pages/_error'\n      }\n\n      if (pagePath === null) {\n        throw pageNotFoundError(normalizedPagePath)\n      }\n\n      let pageUrl = pagePath.replace(/\\\\/g, '/')\n\n      pageUrl = `${pageUrl[0] !== '/' ? '/' : ''}${pageUrl\n        .replace(new RegExp(`\\\\.+(?:${pageExtensions.join('|')})$`), '')\n        .replace(/\\/index$/, '')}`\n\n      pageUrl = pageUrl === '' ? '/' : pageUrl\n\n      const bundleFile = `${normalizePagePath(pageUrl)}.js`\n      const name = join('static', buildId, 'pages', bundleFile)\n      const absolutePagePath = pagePath.startsWith('next/dist/pages')\n        ? require.resolve(pagePath)\n        : join(pagesDir, pagePath)\n\n      page = posix.normalize(pageUrl)\n\n      return new Promise((resolve, reject) => {\n        // Makes sure the page that is being kept in on-demand-entries matches the webpack output\n        const normalizedPage = normalizePage(page)\n        const entryInfo = entries[normalizedPage]\n\n        if (entryInfo) {\n          if (entryInfo.status === BUILT) {\n            resolve()\n            return\n          }\n\n          if (entryInfo.status === BUILDING) {\n            doneCallbacks!.once(normalizedPage, handleCallback)\n            return\n          }\n        }\n\n        Log.event(`build page: ${normalizedPage}`)\n\n        entries[normalizedPage] = { name, absolutePagePath, status: ADDED }\n        doneCallbacks!.once(normalizedPage, handleCallback)\n\n        invalidator.invalidate()\n\n        function handleCallback(err: Error) {\n          if (err) return reject(err)\n          resolve()\n        }\n      })\n    },\n\n    middleware() {\n      return (req: IncomingMessage, res: ServerResponse, next: Function) => {\n        if (!/^\\/_next\\/webpack-hmr/.test(req.url!)) return next()\n\n        const { query } = parse(req.url!, true)\n        const page = query.page\n        if (!page) return next()\n\n        const runPing = () => {\n          const data = handlePing(query.page as string)\n          if (!data) return\n          res.write('data: ' + JSON.stringify(data) + '\\n\\n')\n        }\n        const pingInterval = setInterval(() => runPing(), 5000)\n\n        req.on('close', () => {\n          clearInterval(pingInterval)\n        })\n        next()\n      }\n    },\n  }\n}\n\nfunction disposeInactiveEntries(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  entries: any,\n  lastAccessPages: any,\n  maxInactiveAge: number\n) {\n  const disposingPages: any = []\n\n  Object.keys(entries).forEach((page) => {\n    const { lastActiveTime, status } = entries[page]\n\n    // This means this entry is currently building or just added\n    // We don't need to dispose those entries.\n    if (status !== BUILT) return\n\n    // We should not build the last accessed page even we didn't get any pings\n    // Sometimes, it's possible our XHR ping to wait before completing other requests.\n    // In that case, we should not dispose the current viewing page\n    if (lastAccessPages.includes(page)) return\n\n    if (Date.now() - lastActiveTime > maxInactiveAge) {\n      disposingPages.push(page)\n    }\n  })\n\n  if (disposingPages.length > 0) {\n    disposingPages.forEach((page: any) => {\n      delete entries[page]\n    })\n    // disposing inactive page(s)\n    devMiddleware.invalidate()\n  }\n}\n\n// /index and / is the same. So, we need to identify both pages as the same.\n// This also applies to sub pages as well.\nexport function normalizePage(page: string) {\n  const unixPagePath = page.replace(/\\\\/g, '/')\n  if (unixPagePath === '/index' || unixPagePath === '/') {\n    return '/'\n  }\n  return unixPagePath.replace(/\\/index$/, '')\n}\n\n// Make sure only one invalidation happens at a time\n// Otherwise, webpack hash gets changed and it'll force the client to reload.\nclass Invalidator {\n  private multiCompiler: webpack.MultiCompiler\n  private devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware\n  private building: boolean\n  private rebuildAgain: boolean\n\n  constructor(\n    devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n    multiCompiler: webpack.MultiCompiler\n  ) {\n    this.multiCompiler = multiCompiler\n    this.devMiddleware = devMiddleware\n    // contains an array of types of compilers currently building\n    this.building = false\n    this.rebuildAgain = false\n  }\n\n  invalidate() {\n    // If there's a current build is processing, we won't abort it by invalidating.\n    // (If aborted, it'll cause a client side hard reload)\n    // But let it to invalidate just after the completion.\n    // So, it can re-build the queued pages at once.\n    if (this.building) {\n      this.rebuildAgain = true\n      return\n    }\n\n    this.building = true\n    // Work around a bug in webpack, calling `invalidate` on Watching.js\n    // doesn't trigger the invalid call used to keep track of the `.done` hook on multiCompiler\n    for (const compiler of this.multiCompiler.compilers) {\n      compiler.hooks.invalid.call()\n    }\n    this.devMiddleware.invalidate()\n  }\n\n  startBuilding() {\n    this.building = true\n  }\n\n  doneBuilding() {\n    this.building = false\n\n    if (this.rebuildAgain) {\n      this.rebuildAgain = false\n      this.invalidate()\n    }\n  }\n}\n"]}