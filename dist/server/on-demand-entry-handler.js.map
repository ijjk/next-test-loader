{"version":3,"sources":["../../server/on-demand-entry-handler.ts"],"names":["ADDED","Symbol","BUILDING","BUILT","addEntry","compilation","context","name","entry","Promise","resolve","reject","dep","DynamicEntryPlugin","createDependency","err","onDemandEntryHandler","devMiddleware","multiCompiler","pagesDir","pageExtensions","maxInactiveAge","pagesBufferLength","compilers","invalidator","Invalidator","entries","lastAccessPages","doneCallbacks","EventEmitter","compiler","hooks","make","tapPromise","startBuilding","allEntries","Object","keys","map","page","match","API_ROUTE","absolutePagePath","pageExists","status","pageLoaderOpts","all","catch","console","error","getPagePathsFromEntrypoints","entrypoints","pagePaths","entrypoint","values","push","done","tap","multiStats","clientStats","serverStats","stats","Set","lastActiveTime","Date","now","emit","doneBuilding","disposeHandler","setInterval","disposeInactiveEntries","unref","handlePing","pg","entryInfo","toSend","invalid","success","includes","unshift","length","pop","ensurePage","normalizedPagePath","pagePath","pageUrl","replace","RegExp","join","bundleFile","startsWith","require","posix","normalize","normalizedPage","once","handleCallback","Log","event","invalidate","middleware","req","res","next","test","url","query","runPing","data","write","JSON","stringify","pingInterval","on","clearInterval","disposingPages","forEach","constructor","building","rebuildAgain","call"],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport WebpackDevMiddleware from 'next/dist/compiled/webpack-dev-middleware'\nimport { join, posix } from 'path'\nimport { stringify } from 'querystring'\nimport { parse } from 'url'\nimport webpack from 'webpack'\nimport DynamicEntryPlugin from 'webpack/lib/DynamicEntryPlugin'\nimport { isWriteable } from '../build/is-writeable'\nimport * as Log from '../build/output/log'\nimport { ClientPagesLoaderOptions } from '../build/webpack/loaders/next-client-pages-loader'\nimport { API_ROUTE } from '../lib/constants'\nimport {\n  normalizePagePath,\n  normalizePathSep,\n} from '../next-server/server/normalize-page-path'\nimport { pageNotFoundError } from '../next-server/server/require'\nimport { findPageFile } from './lib/find-page-file'\nimport getRouteFromEntrypoint from '../next-server/server/get-route-from-entrypoint'\n\nconst ADDED = Symbol('added')\nconst BUILDING = Symbol('building')\nconst BUILT = Symbol('built')\n\n// Based on https://github.com/webpack/webpack/blob/master/lib/DynamicEntryPlugin.js#L29-L37\nfunction addEntry(\n  compilation: webpack.compilation.Compilation,\n  context: string,\n  name: string,\n  entry: string[]\n) {\n  return new Promise((resolve, reject) => {\n    const dep = DynamicEntryPlugin.createDependency(entry, name)\n    compilation.addEntry(context, dep, name, (err: Error) => {\n      if (err) return reject(err)\n      resolve()\n    })\n  })\n}\n\nexport default function onDemandEntryHandler(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  multiCompiler: webpack.MultiCompiler,\n  {\n    pagesDir,\n    pageExtensions,\n    maxInactiveAge,\n    pagesBufferLength,\n  }: {\n    pagesDir: string\n    pageExtensions: string[]\n    maxInactiveAge: number\n    pagesBufferLength: number\n  }\n) {\n  const { compilers } = multiCompiler\n  const invalidator = new Invalidator(devMiddleware, multiCompiler)\n  let entries: any = {}\n  let lastAccessPages = ['']\n  let doneCallbacks: EventEmitter | null = new EventEmitter()\n\n  for (const compiler of compilers) {\n    compiler.hooks.make.tapPromise(\n      'NextJsOnDemandEntries',\n      (compilation: webpack.compilation.Compilation) => {\n        invalidator.startBuilding()\n\n        const allEntries = Object.keys(entries).map(async (page) => {\n          if (compiler.name === 'client' && page.match(API_ROUTE)) {\n            return\n          }\n          const { name, absolutePagePath } = entries[page]\n          const pageExists = await isWriteable(absolutePagePath)\n          if (!pageExists) {\n            // page was removed\n            delete entries[page]\n            return\n          }\n\n          entries[page].status = BUILDING\n          const pageLoaderOpts: ClientPagesLoaderOptions = {\n            page,\n            absolutePagePath,\n          }\n          return addEntry(compilation, compiler.context, name, [\n            compiler.name === 'client'\n              ? `next-client-pages-loader?${stringify(pageLoaderOpts)}!`\n              : absolutePagePath,\n          ])\n        })\n\n        return Promise.all(allEntries).catch((err) => console.error(err))\n      }\n    )\n  }\n\n  function getPagePathsFromEntrypoints(entrypoints: any): string[] {\n    const pagePaths = []\n    for (const entrypoint of entrypoints.values()) {\n      const page = getRouteFromEntrypoint(entrypoint.name)\n      if (page) {\n        pagePaths.push(page)\n      }\n    }\n\n    return pagePaths\n  }\n\n  multiCompiler.hooks.done.tap('NextJsOnDemandEntries', (multiStats) => {\n    const [clientStats, serverStats] = multiStats.stats\n    const pagePaths = new Set([\n      ...getPagePathsFromEntrypoints(clientStats.compilation.entrypoints),\n      ...getPagePathsFromEntrypoints(serverStats.compilation.entrypoints),\n    ])\n\n    for (const page of pagePaths) {\n      const entry = entries[page]\n      if (!entry) {\n        continue\n      }\n\n      if (entry.status !== BUILDING) {\n        continue\n      }\n\n      entry.status = BUILT\n      entry.lastActiveTime = Date.now()\n      doneCallbacks!.emit(page)\n    }\n\n    invalidator.doneBuilding()\n  })\n\n  const disposeHandler = setInterval(function () {\n    disposeInactiveEntries(\n      devMiddleware,\n      entries,\n      lastAccessPages,\n      maxInactiveAge\n    )\n  }, 5000)\n\n  disposeHandler.unref()\n\n  function handlePing(pg: string) {\n    const page = normalizePathSep(pg)\n    const entryInfo = entries[page]\n    let toSend\n\n    // If there's no entry, it may have been invalidated and needs to be re-built.\n    if (!entryInfo) {\n      // if (page !== lastEntry) client pings, but there's no entry for page\n      return { invalid: true }\n    }\n\n    // 404 is an on demand entry but when a new page is added we have to refresh the page\n    if (page === '/_error') {\n      toSend = { invalid: true }\n    } else {\n      toSend = { success: true }\n    }\n\n    // We don't need to maintain active state of anything other than BUILT entries\n    if (entryInfo.status !== BUILT) return\n\n    // If there's an entryInfo\n    if (!lastAccessPages.includes(page)) {\n      lastAccessPages.unshift(page)\n\n      // Maintain the buffer max length\n      if (lastAccessPages.length > pagesBufferLength) {\n        lastAccessPages.pop()\n      }\n    }\n    entryInfo.lastActiveTime = Date.now()\n    return toSend\n  }\n\n  return {\n    async ensurePage(page: string) {\n      let normalizedPagePath: string\n      try {\n        normalizedPagePath = normalizePagePath(page)\n      } catch (err) {\n        console.error(err)\n        throw pageNotFoundError(page)\n      }\n\n      let pagePath = await findPageFile(\n        pagesDir,\n        normalizedPagePath,\n        pageExtensions\n      )\n\n      // Default the /_error route to the Next.js provided default page\n      if (page === '/_error' && pagePath === null) {\n        pagePath = 'next/dist/pages/_error'\n      }\n\n      if (pagePath === null) {\n        throw pageNotFoundError(normalizedPagePath)\n      }\n\n      let pageUrl = pagePath.replace(/\\\\/g, '/')\n\n      pageUrl = `${pageUrl[0] !== '/' ? '/' : ''}${pageUrl\n        .replace(new RegExp(`\\\\.+(?:${pageExtensions.join('|')})$`), '')\n        .replace(/\\/index$/, '')}`\n\n      pageUrl = pageUrl === '' ? '/' : pageUrl\n\n      const bundleFile = `${normalizePagePath(pageUrl)}.js`\n      const name = join('static', 'BUILD_ID', 'pages', bundleFile)\n      const absolutePagePath = pagePath.startsWith('next/dist/pages')\n        ? require.resolve(pagePath)\n        : join(pagesDir, pagePath)\n\n      page = posix.normalize(pageUrl)\n\n      return new Promise((resolve, reject) => {\n        // Makes sure the page that is being kept in on-demand-entries matches the webpack output\n        const normalizedPage = normalizePathSep(page)\n        const entryInfo = entries[normalizedPage]\n\n        if (entryInfo) {\n          if (entryInfo.status === BUILT) {\n            resolve()\n            return\n          }\n\n          if (entryInfo.status === BUILDING) {\n            doneCallbacks!.once(normalizedPage, handleCallback)\n            return\n          }\n        }\n\n        Log.event(`build page: ${normalizedPage}`)\n\n        entries[normalizedPage] = { name, absolutePagePath, status: ADDED }\n        doneCallbacks!.once(normalizedPage, handleCallback)\n\n        invalidator.invalidate()\n\n        function handleCallback(err: Error) {\n          if (err) return reject(err)\n          resolve()\n        }\n      })\n    },\n\n    middleware() {\n      return (req: IncomingMessage, res: ServerResponse, next: Function) => {\n        if (!/^\\/_next\\/webpack-hmr/.test(req.url!)) return next()\n\n        const { query } = parse(req.url!, true)\n        const page = query.page\n        if (!page) return next()\n\n        const runPing = () => {\n          const data = handlePing(query.page as string)\n          if (!data) return\n          res.write('data: ' + JSON.stringify(data) + '\\n\\n')\n        }\n        const pingInterval = setInterval(() => runPing(), 5000)\n\n        req.on('close', () => {\n          clearInterval(pingInterval)\n        })\n        next()\n      }\n    },\n  }\n}\n\nfunction disposeInactiveEntries(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  entries: any,\n  lastAccessPages: any,\n  maxInactiveAge: number\n) {\n  const disposingPages: any = []\n\n  Object.keys(entries).forEach((page) => {\n    const { lastActiveTime, status } = entries[page]\n\n    // This means this entry is currently building or just added\n    // We don't need to dispose those entries.\n    if (status !== BUILT) return\n\n    // We should not build the last accessed page even we didn't get any pings\n    // Sometimes, it's possible our XHR ping to wait before completing other requests.\n    // In that case, we should not dispose the current viewing page\n    if (lastAccessPages.includes(page)) return\n\n    if (Date.now() - lastActiveTime > maxInactiveAge) {\n      disposingPages.push(page)\n    }\n  })\n\n  if (disposingPages.length > 0) {\n    disposingPages.forEach((page: any) => {\n      delete entries[page]\n    })\n    // disposing inactive page(s)\n    devMiddleware.invalidate()\n  }\n}\n\n// Make sure only one invalidation happens at a time\n// Otherwise, webpack hash gets changed and it'll force the client to reload.\nclass Invalidator {\n  private multiCompiler: webpack.MultiCompiler\n  private devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware\n  private building: boolean\n  private rebuildAgain: boolean\n\n  constructor(\n    devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n    multiCompiler: webpack.MultiCompiler\n  ) {\n    this.multiCompiler = multiCompiler\n    this.devMiddleware = devMiddleware\n    // contains an array of types of compilers currently building\n    this.building = false\n    this.rebuildAgain = false\n  }\n\n  invalidate() {\n    // If there's a current build is processing, we won't abort it by invalidating.\n    // (If aborted, it'll cause a client side hard reload)\n    // But let it to invalidate just after the completion.\n    // So, it can re-build the queued pages at once.\n    if (this.building) {\n      this.rebuildAgain = true\n      return\n    }\n\n    this.building = true\n    // Work around a bug in webpack, calling `invalidate` on Watching.js\n    // doesn't trigger the invalid call used to keep track of the `.done` hook on multiCompiler\n    for (const compiler of this.multiCompiler.compilers) {\n      compiler.hooks.invalid.call()\n    }\n    this.devMiddleware.invalidate()\n  }\n\n  startBuilding() {\n    this.building = true\n  }\n\n  doneBuilding() {\n    this.building = false\n\n    if (this.rebuildAgain) {\n      this.rebuildAgain = false\n      this.invalidate()\n    }\n  }\n}\n"]}