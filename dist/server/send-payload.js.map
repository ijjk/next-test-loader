{"version":3,"sources":["server/send-payload.ts"],"sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\nimport { isResSent } from '../shared/lib/utils'\nimport generateETag from 'etag'\nimport fresh from 'next/dist/compiled/fresh'\n\nexport type PayloadOptions =\n  | { private: true }\n  | { private: boolean; stateful: true }\n  | { private: boolean; stateful: false; revalidate: number | false }\n\nexport function setRevalidateHeaders(\n  res: ServerResponse,\n  options: PayloadOptions\n) {\n  if (options.private || options.stateful) {\n    if (options.private || !res.hasHeader('Cache-Control')) {\n      res.setHeader(\n        'Cache-Control',\n        `private, no-cache, no-store, max-age=0, must-revalidate`\n      )\n    }\n  } else if (typeof options.revalidate === 'number') {\n    if (options.revalidate < 1) {\n      throw new Error(\n        `invariant: invalid Cache-Control duration provided: ${options.revalidate} < 1`\n      )\n    }\n\n    res.setHeader(\n      'Cache-Control',\n      `s-maxage=${options.revalidate}, stale-while-revalidate`\n    )\n  } else if (options.revalidate === false) {\n    res.setHeader('Cache-Control', `s-maxage=31536000, stale-while-revalidate`)\n  }\n}\n\nexport function sendPayload(\n  req: IncomingMessage,\n  res: ServerResponse,\n  payload: any,\n  type: 'html' | 'json',\n  {\n    generateEtags,\n    poweredByHeader,\n  }: { generateEtags: boolean; poweredByHeader: boolean },\n  options?: PayloadOptions\n): void {\n  if (isResSent(res)) {\n    return\n  }\n\n  if (poweredByHeader && type === 'html') {\n    res.setHeader('X-Powered-By', 'Next.js')\n  }\n\n  const etag = generateEtags ? generateETag(payload) : undefined\n  if (sendEtagResponse(req, res, etag)) {\n    return\n  }\n\n  if (!res.getHeader('Content-Type')) {\n    res.setHeader(\n      'Content-Type',\n      type === 'json' ? 'application/json' : 'text/html; charset=utf-8'\n    )\n  }\n  res.setHeader('Content-Length', Buffer.byteLength(payload))\n  if (options != null) {\n    setRevalidateHeaders(res, options)\n  }\n  res.end(req.method === 'HEAD' ? null : payload)\n}\n\nexport function sendEtagResponse(\n  req: IncomingMessage,\n  res: ServerResponse,\n  etag: string | undefined\n): boolean {\n  if (etag) {\n    /**\n     * The server generating a 304 response MUST generate any of the\n     * following header fields that would have been sent in a 200 (OK)\n     * response to the same request: Cache-Control, Content-Location, Date,\n     * ETag, Expires, and Vary. https://tools.ietf.org/html/rfc7232#section-4.1\n     */\n    res.setHeader('ETag', etag)\n  }\n\n  if (fresh(req.headers, { etag })) {\n    res.statusCode = 304\n    res.end()\n    return true\n  }\n\n  return false\n}\n"],"names":[],"mappings":";;;;QAUgB,oBAAoB,GAApB,oBAAoB;QA2BpB,WAAW,GAAX,WAAW;QAqCX,gBAAgB,GAAhB,gBAAgB;AAzEN,GAAqB,CAArB,MAAqB;AACtB,GAAM,CAAN,KAAM;AACb,GAA0B,CAA1B,MAA0B;;;;;;SAO5B,oBAAoB,CAClC,GAAmB,EACnB,OAAuB,EACvB,CAAC;IACD,EAAE,EAAE,OAAO,CAAC,OAAO,IAAI,OAAO,CAAC,QAAQ,EAAE,CAAC;QACxC,EAAE,EAAE,OAAO,CAAC,OAAO,KAAK,GAAG,CAAC,SAAS,EAAC,aAAe,IAAG,CAAC;YACvD,GAAG,CAAC,SAAS,EACX,aAAe,IACd,uDAAuD;QAE5D,CAAC;IACH,CAAC,MAAM,EAAE,SAAS,OAAO,CAAC,UAAU,MAAK,MAAQ,GAAE,CAAC;QAClD,EAAE,EAAE,OAAO,CAAC,UAAU,GAAG,CAAC,EAAE,CAAC;YAC3B,KAAK,CAAC,GAAG,CAAC,KAAK,EACZ,oDAAoD,EAAE,OAAO,CAAC,UAAU,CAAC,IAAI;QAElF,CAAC;QAED,GAAG,CAAC,SAAS,EACX,aAAe,IACd,SAAS,EAAE,OAAO,CAAC,UAAU,CAAC,wBAAwB;IAE3D,CAAC,MAAM,EAAE,EAAE,OAAO,CAAC,UAAU,KAAK,KAAK,EAAE,CAAC;QACxC,GAAG,CAAC,SAAS,EAAC,aAAe,IAAG,yCAAyC;IAC3E,CAAC;AACH,CAAC;SAEe,WAAW,CACzB,GAAoB,EACpB,GAAmB,EACnB,OAAY,EACZ,IAAqB,IAEnB,aAAa,GACb,eAAe,KAEjB,OAAwB,EAClB,CAAC;IACP,EAAE,MA/CsB,MAAqB,YA+C/B,GAAG,GAAG,CAAC;;IAErB,CAAC;IAED,EAAE,EAAE,eAAe,IAAI,IAAI,MAAK,IAAM,GAAE,CAAC;QACvC,GAAG,CAAC,SAAS,EAAC,YAAc,IAAE,OAAS;IACzC,CAAC;IAED,KAAK,CAAC,IAAI,GAAG,aAAa,OAtDH,KAAM,UAsDa,OAAO,IAAI,SAAS;IAC9D,EAAE,EAAE,gBAAgB,CAAC,GAAG,EAAE,GAAG,EAAE,IAAI,GAAG,CAAC;;IAEvC,CAAC;IAED,EAAE,GAAG,GAAG,CAAC,SAAS,EAAC,YAAc,IAAG,CAAC;QACnC,GAAG,CAAC,SAAS,EACX,YAAc,GACd,IAAI,MAAK,IAAM,KAAG,gBAAkB,KAAG,wBAA0B;IAErE,CAAC;IACD,GAAG,CAAC,SAAS,EAAC,cAAgB,GAAE,MAAM,CAAC,UAAU,CAAC,OAAO;IACzD,EAAE,EAAE,OAAO,IAAI,IAAI,EAAE,CAAC;QACpB,oBAAoB,CAAC,GAAG,EAAE,OAAO;IACnC,CAAC;IACD,GAAG,CAAC,GAAG,CAAC,GAAG,CAAC,MAAM,MAAK,IAAM,IAAG,IAAI,GAAG,OAAO;AAChD,CAAC;SAEe,gBAAgB,CAC9B,GAAoB,EACpB,GAAmB,EACnB,IAAwB,EACf,CAAC;IACV,EAAE,EAAE,IAAI,EAAE,CAAC;QACT,EAKG,AALH;;;;;KAKG,AALH,EAKG,CACH,GAAG,CAAC,SAAS,EAAC,IAAM,GAAE,IAAI;IAC5B,CAAC;IAED,EAAE,MAtFc,MAA0B,UAsFhC,GAAG,CAAC,OAAO;QAAI,IAAI;QAAK,CAAC;QACjC,GAAG,CAAC,UAAU,GAAG,GAAG;QACpB,GAAG,CAAC,GAAG;eACA,IAAI;IACb,CAAC;WAEM,KAAK;AACd,CAAC"}